<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0d0d0d">
  <title>Axe Team</title>
  <!-- Prometheus-style fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>
  <style>
    /* Prometheus 2 - Cyberpunk/Matrix style font */
    :root {
      --font-prometheus: 'Share Tech Mono', 'Orbitron', monospace;
    }
    /* Auth Gate - Face ID / Biometrics */
    .auth-gate {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #0d0d0d;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    .auth-gate.hidden { display: none; }
    .auth-logo {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      font-size: 48px;
      font-weight: 700;
      letter-spacing: -2px;
      color: #e5e5e5;
      margin-bottom: 20px;
    }
    .auth-logo .x { color: #f97316; font-weight: 800; }
    .auth-icon {
      font-size: 64px;
      margin-bottom: 24px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    .auth-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #f5f5f5;
    }
    .auth-subtitle {
      font-size: 14px;
      color: #888;
      margin-bottom: 32px;
      max-width: 300px;
      line-height: 1.5;
    }
    .auth-btn {
      padding: 16px 48px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      margin-bottom: 16px;
    }
    .auth-btn.primary {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
    }
    .auth-btn.primary:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(249, 115, 22, 0.4);
    }
    .auth-btn.secondary {
      background: #262626;
      color: #888;
      border: 1px solid #333;
    }
    .auth-error {
      color: #ef4444;
      font-size: 13px;
      margin-top: 16px;
      display: none;
    }
    .auth-error.show { display: block; }
    .auth-status {
      font-size: 12px;
      color: #666;
      margin-top: 24px;
    }
  </style>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0d0d0d;
      --bg2: #1a1a1a;
      --bg3: #262626;
      --border: #333;
      --text: #f5f5f5;
      --text2: #888;
      --blue: #3b82f6;
      --green: #22c55e;
      --orange: #f97316;
      --purple: #a855f7;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    * {
      -webkit-tap-highlight-color: transparent;
    }
    button, a, [onclick], [data-action], .clickable, input, textarea, select {
      touch-action: manipulation;
    }
    body {
      font-family: var(--font-prometheus);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      overscroll-behavior: none;
    }
    html {
      overflow-x: hidden;
      scroll-behavior: smooth;
    }
    /* GPU skip rendering for offscreen pages */
    #projects-page,
    #team-page,
    #klausAdminPage {
      content-visibility: auto;
      contain-intrinsic-size: auto 100dvh;
    }
    /* Safari Smart Scroll - compact URL bar on scroll */
    @supports (-webkit-touch-callout: none) {
      body {
        min-height: -webkit-fill-available;
        height: 100%;
      }
      html {
        height: -webkit-fill-available;
      }
    }

    /* Minimal Header - always visible */
    header {
      padding: 12px 16px;
      background: var(--bg);
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 500;
      border-bottom: 1px solid var(--border);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-self: start;
    }
    .header-center {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-self: center;
    }
    .header-right {
      justify-self: end;
    }
    .axe-logo {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -1px;
      color: #e5e5e5;
    }
    .axe-logo .x {
      color: #f97316;
      font-weight: 800;
    }
    .header-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text2);
    }
    .status-animation {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      overflow: hidden;
      background: transparent;
    }
    .status-animation video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      mix-blend-mode: screen; /* Removes white background */
      filter: brightness(1.2) contrast(1.1); /* Make it pop more */
      animation: spinFast 0.8s linear infinite; /* Faster spin */
    }
    @keyframes spinFast {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* ============================================
       ELON MODE: INNOVATIVE CHAT FEATURES
       ============================================ */

    /* LIVE AGENT ACTIVITY BAR - Shows who's working on what */
    .agent-activity-bar {
      display: flex;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(180deg, rgba(13,13,13,0.95) 0%, rgba(13,13,13,0) 100%);
      position: sticky;
      top: 0;
      z-index: 50;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .agent-activity-bar::-webkit-scrollbar { display: none; }

    .agent-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg2);
      border-radius: 12px;
      min-width: 120px;
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }
    .agent-card.active {
      border-color: var(--orange);
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.2);
    }
    .agent-card.thinking {
      animation: shimmer 2s ease-in-out infinite;
    }
    .agent-card-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      background: var(--bg3);
    }
    .agent-card-info {
      flex: 1;
      min-width: 0;
    }
    .agent-card-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .agent-card-status {
      font-size: 10px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .agent-card-status.working { color: var(--green); }
    .agent-card-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #555;
    }
    .agent-card-dot.online { background: var(--green); animation: pulse 2s infinite; }
    .agent-card-dot.working { background: var(--orange); animation: pulse 1s infinite; }

    /* SHIMMER ANIMATION - Claude-style thinking glow */
    @keyframes shimmer {
      0%, 100% { background: var(--bg2); }
      50% { background: linear-gradient(135deg, var(--bg2) 0%, rgba(249,115,22,0.1) 50%, var(--bg2) 100%); }
    }
    @keyframes shimmerText {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .thinking-shimmer {
      background: linear-gradient(90deg, #888 25%, #fff 50%, #888 75%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmerText 2s linear infinite;
    }

    /* FOLLOW-UP SUGGESTION CHIPS - Perplexity-style */
    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 16px;
      margin-top: -8px;
    }
    .suggestion-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg2);
      border: 1px solid var(--bg3);
      border-radius: 20px;
      font-size: 13px;
      color: #aaa;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .suggestion-chip:hover {
      background: var(--bg3);
      border-color: var(--orange);
      color: var(--text);
    }
    .suggestion-chip:active {
      transform: scale(0.98);
    }
    .suggestion-chip-icon {
      font-size: 12px;
    }

    /* NEW MESSAGES PILL - Shows when scrolled up */
    .new-messages-pill {
      position: fixed;
      bottom: calc(160px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 10px 20px;
      background: var(--orange);
      color: white;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(249, 115, 22, 0.4);
      transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .new-messages-pill.visible {
      transform: translateX(-50%) translateY(0);
    }
    .new-messages-pill:hover {
      transform: translateX(-50%) scale(1.05);
      box-shadow: 0 6px 24px rgba(249, 115, 22, 0.5);
    }

    /* QUICK REACTIONS - Message feedback */
    .msg-reactions {
      display: flex;
      gap: 4px;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .msg:hover .msg-reactions {
      opacity: 1;
    }
    .reaction-btn {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid var(--bg3);
      background: var(--bg2);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .reaction-btn:hover {
      background: var(--bg3);
      transform: scale(1.1);
    }
    .reaction-btn.active {
      background: var(--orange);
      border-color: var(--orange);
    }

    /* PROGRESS STEPS - Show work phases */
    .work-progress {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .progress-step {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #666;
    }
    .progress-step.active {
      color: var(--orange);
    }
    .progress-step.done {
      color: var(--green);
    }
    .progress-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    .progress-line {
      width: 20px;
      height: 2px;
      background: var(--bg3);
    }
    .progress-line.done {
      background: var(--green);
    }

    /* MESSAGE TYPE BADGES */
    .msg-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 8px;
    }
    .msg-badge.research { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .msg-badge.decision { background: rgba(249, 115, 22, 0.2); color: var(--orange); }
    .msg-badge.artifact { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .msg-badge.task { background: rgba(34, 197, 94, 0.2); color: var(--green); }

    /* ============================================
       CLAUDE-STYLE ARTIFACT VIEWER
       Bottom sheet with rich content display
       ============================================ */
    .artifact-viewer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .artifact-viewer-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .artifact-viewer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg);
      border-radius: 20px 20px 0 0;
      z-index: 2001;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .artifact-viewer.active {
      transform: translateY(0);
    }
    .artifact-viewer-handle {
      width: 36px;
      height: 5px;
      background: var(--bg3);
      border-radius: 3px;
      margin: 10px auto;
    }
    .artifact-viewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px 16px;
      border-bottom: 1px solid var(--border);
    }
    .artifact-close-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--bg2);
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .artifact-title {
      flex: 1;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
      padding: 0 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .artifact-menu-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--bg2);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .artifact-viewer-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      padding-bottom: calc(40px + var(--safe-bottom));
      -webkit-overflow-scrolling: touch;
    }
    /* Rich content styling */
    .artifact-viewer-content h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    .artifact-viewer-content h2 {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .artifact-viewer-content h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 8px;
    }
    .artifact-viewer-content p {
      margin-bottom: 16px;
      line-height: 1.7;
      color: var(--text);
    }
    .artifact-viewer-content .subtitle {
      color: var(--text-dim);
      font-size: 15px;
      margin-bottom: 20px;
    }
    .artifact-viewer-content ul, .artifact-viewer-content ol {
      margin: 16px 0;
      padding-left: 24px;
    }
    .artifact-viewer-content li {
      margin-bottom: 12px;
      line-height: 1.6;
    }
    .artifact-viewer-content strong {
      font-weight: 600;
      color: var(--text);
    }
    .artifact-viewer-content hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 24px 0;
    }
    /* Tables */
    .artifact-viewer-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      font-size: 14px;
    }
    .artifact-viewer-content th {
      text-align: left;
      font-weight: 600;
      padding: 12px 8px;
      border-bottom: 2px solid var(--border);
    }
    .artifact-viewer-content td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--border);
    }
    .artifact-viewer-content tr:last-child td {
      border-bottom: none;
    }
    /* Code blocks */
    .artifact-viewer-content pre {
      background: var(--bg2);
      padding: 16px;
      border-radius: 12px;
      overflow-x: auto;
      margin: 16px 0;
      font-size: 13px;
      line-height: 1.5;
    }
    .artifact-viewer-content code {
      background: var(--bg2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }
    /* Blockquotes */
    /* Action bar inside artifact viewer */
    .artifact-actions-bar {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--bg3);
      background: var(--bg2);
    }
    .artifact-action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 12px;
      background: var(--bg3);
      border: none;
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .artifact-action-btn:hover {
      background: var(--orange);
      color: #000;
    }
    .artifact-action-btn .icon {
      font-size: 16px;
    }

    /* View button on artifact cards */
    .artifact-card-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--bg3);
    }
    .artifact-view-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: var(--orange);
      border: none;
      border-radius: 6px;
      color: #000;
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .artifact-view-btn:hover {
      background: #ffb347;
      transform: scale(1.02);
    }

    /* Add to Project dropdown */
    .project-selector-wrap {
      position: relative;
      display: inline-block;
    }
    .project-selector-dropdown {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 0;
      min-width: 240px;
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg2);
      border: 1px solid var(--bg3);
      border-radius: 10px;
      padding: 6px;
      margin-bottom: 6px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
      z-index: 100;
    }
    .project-selector-dropdown.active { display: block; }
    .project-selector-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text);
      transition: background 0.15s;
    }
    .project-selector-item:hover { background: var(--bg3); }
    .project-selector-item .ps-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .project-selector-item .ps-status { font-size: 11px; color: var(--text-dim); }

    .artifact-viewer-content blockquote {
      border-left: 3px solid var(--orange);
      padding-left: 16px;
      margin: 16px 0;
      color: var(--text-dim);
      font-style: italic;
    }
    /* Artifact cards in chat */
    .artifact-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .artifact-card:hover {
      border-color: var(--orange);
      background: var(--bg3);
    }
    .artifact-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .artifact-card-icon {
      font-size: 20px;
    }
    .artifact-card-title {
      font-weight: 600;
      font-size: 14px;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .artifact-card-preview {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .artifact-card-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 11px;
      color: #666;
    }
    .artifact-card-author {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .menu-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: var(--bg2);
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
    }

    /* Bottom Sheet Menu */
    .bottom-sheet-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 900;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .bottom-sheet-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg2);
      border-radius: 20px 20px 0 0;
      padding: 20px;
      padding-bottom: calc(20px + var(--safe-bottom));
      z-index: 950;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      max-height: 70vh;
      overflow-y: auto;
    }
    .bottom-sheet.active {
      transform: translateY(0);
    }
    .sheet-handle {
      width: 40px;
      height: 4px;
      background: var(--bg3);
      border-radius: 2px;
      margin: 0 auto 20px;
    }
    .sheet-section {
      margin-bottom: 24px;
    }
    .sheet-section-title {
      font-size: 11px;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }
    .sheet-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: var(--bg3);
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .sheet-item:hover, .sheet-item:active {
      background: var(--border);
    }
    .sheet-item-icon { font-size: 20px; }
    .sheet-item-text { flex: 1; }
    .sheet-item-title { font-size: 14px; font-weight: 500; }
    .sheet-item-sub { font-size: 11px; color: var(--text2); }
    .sheet-item-badge {
      background: var(--orange);
      color: #000;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    /* Team Members in Sheet */
    .team-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .team-member {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 12px;
      background: var(--bg3);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .team-member:hover { background: var(--border); }
    .team-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: var(--bg);
      margin-bottom: 8px;
      position: relative;
    }
    .team-avatar .online-dot {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--green);
      border: 2px solid var(--bg3);
    }
    .team-avatar .offline-dot {
      background: var(--text2);
    }
    .team-name { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
    .team-role { font-size: 10px; color: var(--text2); margin-bottom: 8px; }
    .ping-btn {
      padding: 6px 14px;
      background: var(--blue);
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 11px;
      cursor: pointer;
    }
    .ping-btn:active { transform: scale(0.95); }

    /* Task Modal */
    .task-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .task-modal.active { display: flex; }
    .task-modal-content {
      background: var(--bg2);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      overflow: hidden;
    }
    .task-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task-modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    .task-modal-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--bg3);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
    }
    .task-modal-body {
      padding: 20px;
    }
    .task-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      color: var(--text);
      font-family: inherit;
      resize: none;
      min-height: 120px;
      margin-bottom: 16px;
    }
    .task-input:focus {
      outline: none;
      border-color: var(--orange);
    }
    .task-hint {
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 20px;
    }
    .task-submit {
      width: 100%;
      padding: 14px;
      background: var(--orange);
      border: none;
      border-radius: 12px;
      color: #000;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }
    .task-submit:active { transform: scale(0.98); }

    /* Profile images */
    .avatar-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .team-avatar-img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* Messages */
    main {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      padding-top: 70px; /* Space for fixed header */
      padding-bottom: 160px; /* Space for fixed input area */
      display: flex;
      flex-direction: column;
      gap: 16px;
      /* Ultra smooth mobile scrolling */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      touch-action: pan-y;
      /* Safari smart scroll - triggers URL bar hide */
      overscroll-behavior: none;
      /* GPU acceleration for smooth scroll */
      will-change: scroll-position;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }

    /* Swipe gesture overlay */
    .swipe-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 1000;
    }
    .swipe-indicator {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      padding: 20px;
      background: rgba(59, 130, 246, 0.9);
      color: white;
      border-radius: 12px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .swipe-indicator.left { left: 20px; }
    .swipe-indicator.right { right: 20px; }
    .swipe-indicator.visible { opacity: 1; }
    .msg {
      display: flex;
      gap: 12px;
      animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .msg.new-msg {
      animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes popIn {
      0% { opacity: 0; transform: translateY(20px) scale(0.9); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    /* Typing animation for new messages */
    .msg.typing .msg-text {
      overflow: hidden;
    }
    .typing-cursor {
      display: inline-block;
      width: 2px;
      height: 1.1em;
      background: var(--orange);
      margin-left: 2px;
      animation: blink 0.7s infinite;
      vertical-align: text-bottom;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    /* === THINKING DOTS (bouncing) === */
    .thinking-dots {
      display: inline-flex;
      gap: 4px;
      padding: 4px 0;
      align-items: center;
      height: 24px;
    }
    .thinking-dots .dot {
      width: 7px;
      height: 7px;
      background: var(--text2);
      border-radius: 50%;
      animation: dotBounce 1.4s ease infinite;
    }
    .thinking-dots .dot:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotBounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-6px); opacity: 1; }
    }

    /* === SHIMMER LOADING BAR === */
    .chat-shimmer {
      height: 2px;
      background: var(--bg3);
      overflow: hidden;
      position: relative;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .chat-shimmer.active {
      opacity: 1;
    }
    .chat-shimmer::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, var(--orange), transparent);
      animation: shimmerSlide 1.5s ease infinite;
      transform: translateX(-100%);
    }
    @keyframes shimmerSlide {
      to { transform: translateX(100%); }
    }

    /* === STREAMING STATE === */
    .msg.streaming .msg-text {
      overflow: hidden;
    }
    .msg.streaming .typing-cursor {
      background: var(--orange);
      animation: blink 0.6s step-end infinite;
    }

    /* === MESSAGE PHASES === */
    .msg.phase-thinking .bubble {
      opacity: 0.85;
    }
    .msg.phase-streaming .bubble {
      opacity: 1;
    }
    .msg.phase-complete .bubble {
      opacity: 1;
    }

    /* === DOM-PRUNED (off-screen) === */
    .msg.pruned {
      display: none;
    }
    .msg.mine { flex-direction: row-reverse; }
    .avatar {
      width: 36px; height: 36px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      background: var(--bg3);
      flex-shrink: 0;
    }
    .bubble {
      max-width: 100%; /* Full width like Claude */
      width: 100%;
      background: var(--bg2);
      border-radius: 18px;
      padding: 16px 20px;
    }
    .msg.mine .bubble { background: var(--blue); max-width: 85%; width: auto; }
    /* Archived messages - slightly faded to show they're from history */
    .msg.archived-msg { opacity: 0.75; }
    .msg.archived-msg .bubble { border-left: 2px solid #444; }
    .archive-marker {
      text-align: center;
      padding: 16px;
      color: #666;
      font-size: 13px;
      border-bottom: 1px solid #333;
      margin-bottom: 16px;
    }
    .msg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .msg-name { font-size: 14px; font-weight: 600; }
    .msg-name.forge { color: var(--orange); }
    .msg-name.cortana { color: var(--purple); }
    .msg-name.klaus { color: #e8a86d; }
    .klaus-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      background: #e8a86d;
      border-radius: 50%;
      color: white;
      font-weight: 600;
      font-size: 16px;
      font-family: -apple-system, sans-serif;
    }
    .msg-name.gemini { color: #8b5cf6; }
    .msg-time { font-size: 11px; color: var(--text2); }
    .msg-text {
      font-size: 16px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
    }
    .msg-text code {
      background: var(--bg);
      padding: 3px 8px;
      border-radius: 6px;
      font-family: var(--font-prometheus);
      font-size: 14px;
    }
    .msg-text pre {
      background: var(--bg);
      padding: 14px 16px;
      border-radius: 10px;
      overflow-x: auto;
      font-family: var(--font-prometheus);
      font-size: 13px;
      margin: 12px 0;
      line-height: 1.5;
      /* No max-height limit - show full content like Claude */
    }
    /* Inline artifact links in messages */
    .inline-artifact {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--bg3);
      border: 1px solid var(--orange);
      border-radius: 8px;
      padding: 6px 12px;
      margin: 4px 2px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
    }
    .inline-artifact:hover {
      background: var(--orange);
      color: #0d0d0d;
    }
    .inline-artifact .artifact-icon { font-size: 14px; }
    .inline-artifact .artifact-name { font-weight: 500; }
    .inline-artifact .download-icon {
      font-size: 12px;
      opacity: 0.7;
      margin-left: 4px;
    }
    .mine .msg-header { display: none; }

    /* Bash request styling */
    .msg.bash-request .bubble {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid var(--orange);
    }
    .bash-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .bash-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .bash-btn.approve {
      background: var(--green);
      color: white;
    }
    .bash-btn.deny {
      background: var(--bg3);
      color: var(--text2);
    }

    /* Notification message styling - visually distinct from normal messages */
    .msg.notification .bubble {
      background: linear-gradient(135deg, #0d1f2d 0%, #0a1628 100%);
      border-left: 3px solid #3b82f6;
      border-radius: 4px 14px 14px 4px;
    }
    .msg.notification .msg-header::after {
      content: 'NOTIFICATION';
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.8px;
      color: #3b82f6;
      background: #3b82f611;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }
    .msg.notification .msg-text {
      color: #93c5fd;
    }

    /* Task buttons - matching artifacts page style */
    .task-buttons {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .task-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      font-family: inherit;
      background: var(--bg3);
      color: var(--text);
    }
    .task-btn:hover {
      background: var(--bg);
      border-color: var(--orange);
    }
    .task-btn.add-task {
      background: var(--orange);
      color: var(--bg);
      border-color: var(--orange);
    }
    .task-btn.add-task:hover {
      opacity: 0.9;
    }
    .task-btn.add-task.added {
      background: var(--green);
      border-color: var(--green);
      pointer-events: none;
    }
    .task-btn.view-tasks {
      background: var(--bg3);
      color: var(--text2);
    }
    .task-btn.view-tasks:hover {
      background: var(--bg);
      color: var(--text);
      border-color: var(--orange);
    }

    /* Claude-style message action buttons */
    .msg-actions {
      display: flex;
      gap: 2px;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .msg:hover .msg-actions,
    .msg-actions:focus-within {
      opacity: 1;
    }
    .msg-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.15s ease;
    }
    .msg-action-btn:hover {
      background: var(--bg3);
      color: var(--text);
    }
    .msg-action-btn.copied {
      color: var(--green);
    }
    /* Hide actions on own messages */
    .msg.mine .msg-actions {
      display: none;
    }

    /* Task List Modal */
    .task-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }
    .task-modal.active { display: flex; }
    .task-modal-header {
      padding: 20px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task-modal-title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .task-modal-close {
      font-size: 28px;
      background: none;
      border: none;
      color: var(--text2);
      cursor: pointer;
    }
    .task-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .task-item {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .task-item.completed {
      opacity: 0.6;
      background: var(--bg);
    }
    .task-check {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: transparent;
      font-size: 14px;
    }
    .task-check:hover { border-color: var(--orange); }
    .task-item.completed .task-check {
      background: var(--green);
      border-color: var(--green);
      color: white;
    }
    .task-content { flex: 1; }
    .task-text {
      font-size: 15px;
      margin-bottom: 6px;
    }
    .task-item.completed .task-text {
      text-decoration: line-through;
      color: var(--text2);
    }
    .task-meta {
      font-size: 12px;
      color: var(--text2);
      display: flex;
      gap: 12px;
    }
    .task-delete {
      background: none;
      border: none;
      color: var(--text2);
      cursor: pointer;
      font-size: 18px;
      opacity: 0.5;
    }
    .task-delete:hover { opacity: 1; color: #ef4444; }
    .task-empty {
      text-align: center;
      padding: 60px;
      color: var(--text2);
    }
    .task-empty-icon { font-size: 48px; margin-bottom: 16px; }

    .mine .avatar { display: none; }

    /* Thinking Animation - Subtle header indicator (not in chat) */
    .thinking-bar {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
      font-size: 12px;
      color: var(--text2);
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
    }
    .thinking-bar.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    .thinking-bar .agents {
      display: flex;
      gap: 4px;
    }
    .thinking-bar .agent-icon {
      font-size: 14px;
    }
    .thinking-anim-wrap {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }
    .thinking-anim-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* Legacy - COMPLETELY hide old thinking indicators in chat */
    .thinking-indicator { display: none !important; height: 0 !important; overflow: hidden !important; }
    .thinking-content { display: none !important; }
    .thinking-animation { display: none !important; }
    .thinking-bubble { display: none !important; }
    .thinking-text { display: none !important; }
    /* Hide empty messages (just cursor) */
    .msg-text:empty { display: none; }
    .msg .bubble:has(.msg-text:empty) { min-height: auto; }
    .thinking-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--text2);
      animation: typingBounce 1.4s infinite ease-in-out;
    }
    .thinking-dot:nth-child(1) { animation-delay: 0s; }
    .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-4px); opacity: 1; }
    }
    .thinking-text {
      font-size: 13px;
      color: var(--text2);
      font-style: italic;
    }

    /* Message flow animation - staggered entry */
    .msg {
      display: flex;
      gap: 12px;
      animation: messageFlow 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      animation-fill-mode: both;
      contain: layout style;
    }
    @keyframes messageFlow {
      0% {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    /* Staggered delays for flowing messages */
    .msg:nth-last-child(1) { animation-delay: 0s; }
    .msg:nth-last-child(2) { animation-delay: 0.05s; }
    .msg:nth-last-child(3) { animation-delay: 0.1s; }
    .msg:nth-last-child(4) { animation-delay: 0.15s; }
    .msg:nth-last-child(5) { animation-delay: 0.2s; }

    /* New message pop with video expand effect */
    .msg.expanding {
      animation: expandIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes expandIn {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(10px);
        transform-origin: left center;
      }
      50% {
        transform: scale(1.02) translateY(-2px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text2);
    }
    .empty-icon { font-size: 48px; margin-bottom: 12px; }

    /* Input - Claude.ai Style Chat Box (fixed to viewport bottom) */
    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: transparent;
      padding: 12px 16px calc(12px + var(--safe-bottom));
      transition: transform 0.15s ease;
      will-change: transform;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }
    .input-container {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 24px;
      overflow: hidden;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-container:focus-within {
      border-color: var(--text2);
      outline: 1px solid var(--text2);
      outline-offset: -1px;
    }
    .input-textarea-wrap {
      padding: 14px 16px 8px;
    }
    .input-textarea-wrap textarea {
      width: 100%;
      background: transparent;
      border: none;
      font-size: 16px;
      color: var(--text);
      resize: none;
      outline: none;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      max-height: 300px; /* Expanded for longer messages */
      min-height: 24px;
      line-height: 1.5;
      overflow-y: auto;
    }
    .input-textarea-wrap textarea::placeholder {
      color: var(--text2);
      opacity: 0.6;
    }
    .input-bottom-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 10px 8px;
    }
    .input-left-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .input-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text2);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .input-action-btn:hover {
      background: var(--bg3);
      color: var(--text);
    }
    .input-right-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .model-selector {
      display: flex;
      align-items: center;
      gap: 3px;
      padding: 4px 8px;
      background: transparent;
      border: none;
      color: var(--text2);
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
    }
    .model-selector:hover {
      background: var(--bg3);
      color: var(--text);
    }
    .model-selector svg {
      width: 12px;
      height: 12px;
      opacity: 0.6;
    }
    .send-stop-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg3);
      color: var(--text2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .send-stop-btn:hover {
      background: var(--bg);
      border-color: var(--text2);
      color: var(--text);
    }
    .send-stop-btn.ready {
      background: linear-gradient(135deg, var(--text), #d4d4d4);
      border: none;
      color: var(--bg);
    }
    .send-stop-btn.ready:hover {
      opacity: 0.9;
    }
    .send-stop-btn svg {
      width: 12px;
      height: 12px;
    }
    .input-disclaimer {
      text-align: center;
      font-size: 11px;
      color: var(--text2);
      opacity: 0.7;
      margin-top: 10px;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
    }

    /* Plus button submenu */
    .plus-menu-wrap {
      position: relative;
    }
    .plus-submenu {
      position: absolute;
      bottom: calc(100% + 6px);
      left: 0;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 4px;
      display: none;
      flex-direction: column;
      min-width: 160px;
      box-shadow: 0 8px 24px rgba(0,0,0,.5);
      z-index: 200;
    }
    .plus-submenu.active {
      display: flex;
    }
    .plus-submenu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 13px;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      cursor: pointer;
      border-radius: 7px;
      transition: background 0.15s;
      white-space: nowrap;
    }
    .plus-submenu-item:hover {
      background: var(--bg3);
    }
    .plus-submenu-item svg {
      width: 16px;
      height: 16px;
      color: var(--text2);
      flex-shrink: 0;
    }

    /* Artifact attachment preview (Claude-style) */
    .attached-artifact {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 12px;
      padding: 10px 14px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 13px;
    }
    .attached-artifact-icon {
      font-size: 20px;
    }
    .attached-artifact-info {
      flex: 1;
      overflow: hidden;
    }
    .attached-artifact-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .attached-artifact-type {
      font-size: 11px;
      color: var(--text2);
    }
    .attached-artifact-remove {
      padding: 4px 8px;
      background: transparent;
      border: none;
      color: var(--text2);
      cursor: pointer;
      font-size: 16px;
      border-radius: 6px;
    }
    .attached-artifact-remove:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    /* Create artifact modal */
    .create-artifact-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .create-artifact-modal.active {
      display: flex;
    }
    .create-artifact-content {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .create-artifact-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .create-artifact-title {
      font-size: 16px;
      font-weight: 600;
    }
    .create-artifact-close {
      background: none;
      border: none;
      color: var(--text2);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
    }
    .create-artifact-body {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .artifact-form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .artifact-form-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text2);
    }
    .artifact-form-input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 14px;
      color: var(--text);
      outline: none;
      font-family: inherit;
    }
    .artifact-form-input:focus {
      border-color: var(--orange);
    }
    .artifact-form-textarea {
      min-height: 200px;
      resize: vertical;
      font-family: var(--font-prometheus);
      line-height: 1.5;
    }
    .artifact-type-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .artifact-type-btn {
      padding: 8px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text2);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .artifact-type-btn:hover {
      border-color: var(--text2);
    }
    .artifact-type-btn.selected {
      background: var(--orange);
      border-color: var(--orange);
      color: white;
    }
    .create-artifact-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .artifact-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    .artifact-btn.cancel {
      background: var(--bg3);
      color: var(--text2);
    }
    .artifact-btn.create {
      background: var(--orange);
      color: white;
    }
    .artifact-btn:hover {
      opacity: 0.9;
    }

    /* Character count */
    .char-count {
      font-size: 11px;
      color: var(--text2);
      text-align: right;
      padding: 4px 16px 0;
    }
    .char-count.warning {
      color: #f59e0b;
    }
    .char-count.limit {
      color: #ef4444;
    }
    /* Artifact Slider */
    .artifact-slider {
      margin-bottom: 8px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      padding: 2px 0;
    }
    .artifact-slider::-webkit-scrollbar { display: none; }
    .artifact-slider-inner {
      display: flex;
      gap: 6px;
      padding: 0 2px;
    }
    .artifact-card {
      flex: 0 0 auto;
      width: 120px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      cursor: pointer;
      scroll-snap-align: start;
      transition: all 0.2s;
    }
    .artifact-card:hover, .artifact-card:active {
      border-color: var(--orange);
      transform: scale(1.02);
    }
    .artifact-card-header {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }
    .artifact-card-icon {
      font-size: 12px;
    }
    .artifact-card-name {
      font-size: 10px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }
    .artifact-card-meta {
      font-size: 9px;
      color: var(--text2);
      display: flex;
      justify-content: space-between;
    }
    .artifact-card-creator {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    /* Artifact Modal - Claude-style */
    .artifact-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(13, 13, 13, 0.98);
      z-index: 1000;
      display: none;
      flex-direction: column;
      animation: modalFadeIn 0.2s ease-out;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .artifact-modal.active { display: flex; }
    .artifact-modal-header {
      padding: 12px 16px;
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      gap: 12px;
    }
    .artifact-modal-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      font-size: 14px;
      color: #e5e5e5;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    .artifact-modal-title span:first-child {
      font-size: 18px;
      flex-shrink: 0;
    }
    .artifact-modal-title span:last-child {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .artifact-modal-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    .artifact-modal-btn {
      padding: 6px 12px;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      background: #252525;
      color: #d4d4d4;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
    }
    .artifact-modal-btn:hover {
      background: #333;
      border-color: #4a4a4a;
    }
    .artifact-modal-btn:active {
      transform: scale(0.98);
    }
    .artifact-modal-btn.primary {
      background: #e8a86d;
      border-color: #e8a86d;
      color: #0d0d0d;
      font-weight: 500;
    }
    .artifact-modal-btn.primary:hover {
      background: #d4956a;
      border-color: #d4956a;
    }
    /* Back button - left side */
    .artifact-back-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: #252525;
      color: #e5e5e5;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }
    .artifact-back-btn:hover {
      background: #333;
    }
    .artifact-back-btn:active {
      transform: scale(0.95);
    }
    .artifact-modal-content {
      flex: 1;
      overflow: auto;
      padding: 0;
      background: #0d0d0d;
    }
    .artifact-modal-code {
      white-space: pre-wrap;
      font-family: var(--font-prometheus);
      font-size: 13px;
      line-height: 1.7;
      padding: 20px;
      margin: 0;
      color: #e5e5e5;
      background: linear-gradient(180deg, #111 0%, #0d0d0d 100%);
      min-height: 100%;
    }
    /* Claude-style code syntax highlighting */
    .artifact-modal-code .keyword { color: #c792ea; }
    .artifact-modal-code .string { color: #c3e88d; }
    .artifact-modal-code .comment { color: #676e95; }
    .artifact-modal-code .number { color: #f78c6c; }

    /* Artifact Building Animation - Like Claude */
    .artifact-building {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0d0d0d;
      z-index: 1500;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .artifact-building.active { display: flex; }
    .building-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      color: #e5e5e5;
      font-size: 16px;
    }
    .building-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-top-color: #e8a86d;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .building-window {
      width: 90%;
      max-width: 700px;
      background: #1a1a1a;
      border-radius: 12px;
      border: 1px solid #2a2a2a;
      overflow: hidden;
    }
    .building-titlebar {
      padding: 10px 14px;
      background: #252525;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .building-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .building-dot.red { background: #ff5f57; }
    .building-dot.yellow { background: #febc2e; }
    .building-dot.green { background: #28c840; }
    .building-code {
      padding: 16px;
      font-family: var(--font-prometheus);
      font-size: 13px;
      line-height: 1.6;
      color: #e8a86d;
      height: 300px;
      overflow: auto;
      white-space: pre-wrap;
    }
    .building-cursor {
      display: inline-block;
      width: 8px;
      height: 16px;
      background: #e8a86d;
      animation: blink 0.7s step-end infinite;
      vertical-align: middle;
      margin-left: 2px;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    /* Artifact Creation Animations - Claude-inspired */
    @keyframes artifactSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes artifactGlow {
      0% { opacity: 0.85; }
      40% { opacity: 1; }
      100% { opacity: 0.85; }
    }
    @keyframes artifactShimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes artifactPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.04); }
    }
    @keyframes artifactFadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes artifactSparkle {
      0% { opacity: 0; transform: scale(0) rotate(0deg); }
      50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
      100% { opacity: 0; transform: scale(0) rotate(360deg); }
    }
    .artifact-card.new-artifact {
      animation: artifactFadeUp 0.4s ease-out, artifactGlow 1.2s ease-out 0.3s;
    }
    .artifact-card.shimmer {
      background: linear-gradient(90deg, var(--bg3) 0%, rgba(232,168,109,0.15) 50%, var(--bg3) 100%);
      background-size: 200% 100%;
      animation: artifactShimmer 1.5s ease-in-out;
    }
    .artifact-modal.slide-in {
      animation: artifactSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .building-window.active-build {
      animation: artifactGlow 2s ease-in-out infinite;
    }
    .artifact-complete-flash {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at center, rgba(232,168,109,0.15) 0%, transparent 70%);
      z-index: 1600;
      pointer-events: none;
      animation: artifactPulse 0.6s ease-out forwards;
      opacity: 0;
    }
    .artifact-complete-flash.active {
      opacity: 1;
      animation: modalFadeIn 0.2s ease-out, artifactPulse 0.4s ease-out 0.1s;
    }
    .sparkle {
      position: absolute;
      width: 8px;
      height: 8px;
      pointer-events: none;
      z-index: 1601;
    }
    .sparkle::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 2px;
      background: #e8a86d;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      border-radius: 1px;
    }
    .sparkle::after {
      content: '';
      position: absolute;
      width: 2px;
      height: 100%;
      background: #e8a86d;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
      border-radius: 1px;
    }
    .sparkle.animate {
      animation: artifactSparkle 0.6s ease-out forwards;
    }

    /* Projects Page */
    .tasks-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }
    .tasks-page.active { display: flex; }
    .tasks-page-header {
      padding: 12px 16px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .tasks-page-title {
      font-size: 18px;
      font-weight: 600;
      white-space: nowrap;
    }
    .tasks-page-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .projects-list-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .project-detail-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Search & Sort */
    .projects-search {
      flex: 1;
      min-width: 120px;
      max-width: 280px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      outline: none;
    }
    .projects-search:focus { border-color: var(--orange); }
    .projects-sort {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 12px;
      font-family: inherit;
      cursor: pointer;
    }

    /* Project Grid */
    .projects-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .projects-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: var(--text2);
      font-size: 14px;
    }

    /* Project Card */
    .project-card {
      background: var(--bg2);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
      position: relative;
    }
    .project-card:hover {
      transform: translateY(-2px);
      border-color: var(--orange);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    .project-card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .project-card-title {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.3;
      flex: 1;
      margin-right: 8px;
    }
    .project-card-fav {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 2px;
      opacity: 0.4;
      transition: opacity 0.2s;
    }
    .project-card-fav.active { opacity: 1; }
    .project-card-fav:hover { opacity: 0.8; }
    .project-card-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* Status Pill */
    .project-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    .project-status-pill.active { background: rgba(249,115,22,0.15); color: var(--orange); }
    .project-status-pill.completed { background: rgba(34,197,94,0.15); color: var(--green); }
    .project-status-pill.paused { background: rgba(59,130,246,0.15); color: var(--blue); }
    .project-status-pill.error { background: rgba(239,68,68,0.15); color: #ef4444; }
    .project-status-pill.archived { background: var(--bg3); color: var(--text2); }

    .project-card-time {
      font-size: 11px;
      color: var(--text2);
    }
    .project-card-bottom {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .project-card-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 8px;
      background: var(--bg3);
      border-radius: 6px;
      font-size: 10px;
      color: var(--text2);
    }
    .project-card-badge.has { background: var(--green); color: #000; }
    .project-card-progress {
      height: 3px;
      background: var(--bg3);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 12px;
    }
    .project-card-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--orange), var(--green));
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* Project Detail Layout */
    .project-detail-body {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 320px;
      overflow: hidden;
    }
    .project-detail-main {
      overflow-y: auto;
      padding: 20px;
    }
    .project-detail-actions {
      display: flex;
      gap: 8px;
    }
    .project-detail-actions button {
      padding: 7px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg3);
      color: var(--text);
      font-size: 12px;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .project-detail-actions button:hover { background: var(--border); }
    .project-detail-actions button.primary {
      background: var(--orange);
      border-color: var(--orange);
      color: #000;
    }
    .project-detail-actions button.danger {
      border-color: #ef4444;
      color: #ef4444;
    }

    /* Project Sidebar */
    .project-sidebar {
      border-left: 1px solid var(--border);
      overflow-y: auto;
      background: var(--bg2);
    }
    .project-sidebar-section {
      border-bottom: 1px solid var(--border);
    }
    .project-sidebar-header {
      padding: 14px 16px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
    }
    .project-sidebar-header:hover { color: var(--text); }
    .project-sidebar-header .chevron {
      font-size: 10px;
      transition: transform 0.2s;
    }
    .project-sidebar-header.collapsed .chevron { transform: rotate(-90deg); }
    .project-sidebar-body {
      padding: 0 16px 16px;
    }
    .project-sidebar-header.collapsed + .project-sidebar-body {
      display: none;
    }

    /* Memory entries */
    .project-memory-status {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: var(--bg3);
      border-radius: 8px;
    }
    .project-memory-entries {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .project-memory-entry {
      font-size: 12px;
      color: var(--text2);
      padding-left: 12px;
      border-left: 2px solid var(--border);
      line-height: 1.5;
    }
    .project-memory-entry .mem-time {
      font-size: 10px;
      color: var(--text2);
      opacity: 0.7;
    }
    .project-memory-entry.user { border-left-color: var(--orange); }
    .project-memory-add {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }
    .project-memory-add input {
      flex: 1;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 12px;
      font-family: inherit;
    }
    .project-memory-add button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--orange);
      background: var(--orange);
      color: #000;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    /* Instructions textarea */
    .project-instructions-text {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 12px;
      font-family: inherit;
      resize: vertical;
      line-height: 1.5;
    }
    .project-instructions-text:focus { border-color: var(--orange); outline: none; }

    /* Files list */
    .project-file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--bg);
      margin-bottom: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .project-file-item:hover { background: var(--bg3); }
    .project-file-icon { font-size: 14px; }
    .project-file-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .project-files-empty {
      text-align: center;
      padding: 16px;
      color: var(--text2);
      font-size: 12px;
    }

    /* Detail Tabs */
    .project-detail-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      background: var(--bg2);
    }
    .project-detail-tab {
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text2);
      cursor: pointer;
      border: none;
      background: none;
      font-family: inherit;
      position: relative;
      transition: color 0.2s;
    }
    .project-detail-tab:hover { color: var(--text); }
    .project-detail-tab.active {
      color: var(--orange);
    }
    .project-detail-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 8px;
      right: 8px;
      height: 2px;
      background: var(--orange);
      border-radius: 2px 2px 0 0;
    }
    .project-detail-tab .tab-count {
      font-size: 10px;
      background: var(--bg3);
      padding: 1px 6px;
      border-radius: 8px;
      margin-left: 5px;
    }

    /* Overview Tab */
    .project-overview {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .project-overview-description {
      padding: 16px;
      background: var(--bg2);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .project-overview-description label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text2);
      letter-spacing: 0.5px;
      display: block;
      margin-bottom: 8px;
    }
    .project-overview-desc-text {
      width: 100%;
      min-height: 60px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      line-height: 1.5;
    }
    .project-overview-desc-text:focus { border-color: var(--orange); outline: none; }

    .project-overview-progress {
      padding: 16px;
      background: var(--bg2);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .project-overview-progress-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .project-overview-progress-label span:first-child {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text2);
      letter-spacing: 0.5px;
    }
    .project-overview-progress-label .progress-pct {
      font-size: 20px;
      font-weight: 700;
      color: var(--orange);
    }
    .project-overview-progress-bar {
      height: 8px;
      background: var(--bg3);
      border-radius: 4px;
      overflow: hidden;
    }
    .project-overview-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--orange), var(--green));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .project-overview-phase {
      font-size: 12px;
      color: var(--text2);
      margin-top: 8px;
    }

    .project-overview-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .project-stat-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }
    .project-stat-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
    }
    .project-stat-label {
      font-size: 10px;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-top: 4px;
    }

    .project-overview-artifacts {
      padding: 16px;
      background: var(--bg2);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .project-overview-artifacts label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text2);
      letter-spacing: 0.5px;
      display: block;
      margin-bottom: 10px;
    }
    .project-artifact-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    .project-artifact-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .project-artifact-card:hover {
      border-color: var(--orange);
      background: var(--bg3);
    }
    .project-artifact-icon { font-size: 18px; }
    .project-artifact-info { flex: 1; overflow: hidden; }
    .project-artifact-name {
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .project-artifact-creator {
      font-size: 10px;
      color: var(--text2);
      margin-top: 2px;
    }

    /* Tasks Tab */
    .project-tasks {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .project-tasks-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .project-tasks-header .task-counts {
      font-size: 12px;
      color: var(--text2);
    }
    .project-task-add {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .project-task-add input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
    }
    .project-task-add input:focus { border-color: var(--orange); outline: none; }
    .project-task-add button {
      padding: 10px 18px;
      border-radius: 10px;
      border: none;
      background: var(--orange);
      color: #000;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
    }
    .project-task-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      transition: background 0.2s;
    }
    .project-task-item:hover { background: var(--bg3); }
    .project-task-item.completed {
      opacity: 0.6;
    }
    .project-task-check {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--green);
      font-size: 12px;
      flex-shrink: 0;
      transition: border-color 0.2s, background 0.2s;
    }
    .project-task-check:hover { border-color: var(--orange); }
    .project-task-item.completed .project-task-check {
      background: var(--green);
      border-color: var(--green);
      color: #000;
    }
    .project-task-text {
      flex: 1;
      font-size: 13px;
      line-height: 1.4;
    }
    .project-task-item.completed .project-task-text {
      text-decoration: line-through;
    }
    .project-task-time {
      font-size: 10px;
      color: var(--text2);
      white-space: nowrap;
    }
    .project-task-delete {
      background: none;
      border: none;
      color: var(--text2);
      font-size: 14px;
      cursor: pointer;
      padding: 2px 6px;
      opacity: 0;
      transition: opacity 0.2s, color 0.2s;
    }
    .project-task-item:hover .project-task-delete { opacity: 1; }
    .project-task-delete:hover { color: #ef4444; }
    .project-tasks-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text2);
      font-size: 13px;
    }

    /* Timeline */
    .project-timeline {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .project-timeline-entry {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    .project-timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      margin-top: 6px;
      flex-shrink: 0;
    }
    .project-timeline-dot.auto { background: var(--blue); }
    .project-timeline-dot.user { background: var(--orange); }
    .project-timeline-content {
      flex: 1;
    }
    .project-timeline-text {
      font-size: 13px;
      line-height: 1.5;
    }
    .project-timeline-time {
      font-size: 11px;
      color: var(--text2);
      margin-top: 2px;
    }
    .project-timeline-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text2);
      font-size: 14px;
    }

    /* Mobile responsive for projects */
    @media (max-width: 600px) {
      .projects-grid { grid-template-columns: 1fr; gap: 12px; }
      .project-detail-body { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      .project-sidebar { border-left: none; border-top: 1px solid var(--border); max-height: 40vh; }
      .project-card { padding: 14px; }
      .project-card-title { font-size: 14px; }
      .projects-search { max-width: 140px; font-size: 12px; }
      .projects-sort { font-size: 11px; padding: 6px 4px; max-width: 120px; }
      .project-overview-stats { grid-template-columns: repeat(2, 1fr); }
      .project-artifact-grid { grid-template-columns: 1fr; }
      .project-detail-tabs { padding: 0 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .project-detail-tab { padding: 10px 12px; font-size: 12px; white-space: nowrap; }
      .project-detail-actions { flex-wrap: wrap; gap: 6px; }
      .project-detail-actions button { font-size: 11px; padding: 6px 10px; }
      .tasks-page-header { flex-wrap: wrap; gap: 8px; padding: 10px 12px; }
      .tasks-page-title { font-size: 16px; }
    }

    /* Download toast */
    .download-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: #22c55e;
      color: #0d0d0d;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      display: none;
      z-index: 2000;
      animation: toastIn 0.3s ease-out;
    }
    .download-toast.show { display: block; }
    @keyframes toastIn {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    /* File preview styling */
    .file-preview-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg3);
      border-radius: 8px;
      margin: 0 12px 8px;
      font-size: 13px;
    }
    .file-preview-bar .name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-preview-bar .remove {
      cursor: pointer;
      color: var(--text2);
      padding: 4px;
    }
    .file-preview-bar .remove:hover {
      color: #ef4444;
    }

    /* Legacy file button for compatibility */
    .file-btn {
      width: 36px; height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text2);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .file-btn:hover {
      background: var(--bg3);
      color: var(--text);
    }
    #fileInput { display: none; }

    /* File preview */
    .file-preview {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }
    .file-preview .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .file-preview .remove { cursor: pointer; color: var(--text2); }
    .file-content-preview {
      background: var(--bg);
      border-radius: 6px;
      padding: 8px;
      font-family: monospace;
      font-size: 11px;
      max-height: 100px;
      overflow-y: auto;
      margin-top: 8px;
      white-space: pre-wrap;
      color: var(--text2);
    }

    /* ===== MOBILE RESPONSIVE ===== */
    @media (max-width: 600px) {
      /* Main chat area - tighter padding */
      main {
        padding: 12px 8px;
        padding-top: 60px;
        padding-bottom: 140px; /* Space for fixed input area on mobile */
        gap: 10px;
      }

      /* Message rows - tighter gap */
      .msg {
        gap: 6px;
      }

      /* Smaller avatars */
      .avatar {
        width: 28px;
        height: 28px;
        font-size: 14px;
      }

      /* Bubble - less padding, constrain width */
      .bubble {
        padding: 10px 12px;
        border-radius: 14px;
        min-width: 0;
        overflow: hidden;
      }
      .msg.mine .bubble {
        max-width: 85%;
        padding: 10px 12px;
      }

      /* Message text - smaller font */
      .msg-text {
        font-size: 13px;
        line-height: 1.5;
        overflow-wrap: break-word;
        word-break: break-word;
      }

      /* Code blocks */
      .msg-text code {
        font-size: 11px;
        padding: 2px 5px;
      }
      .msg-text pre {
        font-size: 11px;
        padding: 10px;
        margin: 8px 0;
        line-height: 1.4;
      }

      /* Message header */
      .msg-header {
        gap: 6px;
        margin-bottom: 4px;
      }
      .msg-name {
        font-size: 12px;
      }
      .msg-time {
        font-size: 10px;
      }

      /* Task buttons - wrap and smaller */
      .task-buttons {
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
        padding-top: 8px;
      }
      .task-btn {
        padding: 6px 10px;
        font-size: 12px;
        gap: 4px;
      }

      /* Inline artifact links */
      .inline-artifact {
        font-size: 11px;
        padding: 4px 8px;
        gap: 4px;
        max-width: 100%;
        overflow: hidden;
      }
      .inline-artifact .artifact-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 180px;
      }

      /* Artifact cards in chat */
      .artifact-card {
        padding: 8px;
        margin: 4px 0;
      }
      .artifact-card-header {
        gap: 6px;
        margin-bottom: 4px;
      }
      .artifact-card-icon {
        font-size: 16px;
      }
      .artifact-card-title {
        font-size: 12px;
      }
      .artifact-card-preview {
        font-size: 11px;
      }
      .artifact-card-footer {
        margin-top: 6px;
        padding-top: 6px;
      }
      .artifact-view-btn {
        padding: 4px 8px;
        font-size: 11px;
      }

      /* Thinking dots - mobile */
      .thinking-dots .dot { width: 6px; height: 6px; }
      .chat-shimmer { height: 2px; }
      .thinking-bar { font-size: 11px; padding: 5px 10px; top: 55px; }

      /* Artifact slider cards */
      .artifact-slider .artifact-card {
        width: 110px;
        padding: 6px 8px;
      }
      .artifact-slider .artifact-card-name {
        font-size: 11px;
      }
      .artifact-slider .artifact-card-meta {
        font-size: 10px;
      }

      /* Input area - fixed bottom on mobile */
      .input-area {
        padding: 8px 8px calc(8px + var(--safe-bottom));
      }
      .input-textarea-wrap {
        padding: 10px 12px 6px;
      }
      .input-textarea-wrap textarea {
        font-size: 16px; /* Must be >= 16px to prevent iOS auto-zoom on focus */
      }
      .input-bottom-row {
        padding: 6px 8px 8px;
      }

      /* Header */
      header {
        padding: 8px 10px;
      }
      .axe-logo {
        font-size: 20px;
        letter-spacing: -0.5px;
      }

      /* Auth gate - scale down for mobile */
      .auth-gate {
        padding: 24px 20px;
      }
      .auth-logo {
        font-size: 36px;
      }
      .auth-icon {
        font-size: 48px;
      }
      .auth-title {
        font-size: 20px;
      }
      .auth-subtitle {
        font-size: 13px;
      }
      .auth-btn {
        padding: 14px 36px;
        font-size: 15px;
      }

      /* Bottom sheet - tighter on mobile portrait */
      .bottom-sheet {
        max-height: 60vh;
        padding: 14px;
        padding-bottom: calc(14px + var(--safe-bottom));
      }

      /* Bottom sheet sections */
      .sheet-section {
        padding: 8px;
      }

      /* Team page cards - tighter on mobile */
      #teamPageGrid {
        gap: 12px !important;
      }
      #teamPageGrid > div {
        padding: 14px !important;
      }
      #teamPageGrid .ping-btn {
        font-size: 11px;
        padding: 4px 8px;
      }

      /* Notification messages mobile */
      .msg.notification .bubble {
        border-left-width: 2px;
      }

      /* Team grid */
      .team-grid {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      .team-member {
        padding: 10px 8px;
      }
      .team-avatar {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      /* Msg action buttons always visible on mobile (no hover) */
      .msg-actions {
        opacity: 1;
      }
      .msg-action-btn {
        width: 44px;
        height: 44px;
      }
      .input-action-btn {
        width: 44px;
        height: 44px;
      }
      .send-stop-btn {
        width: 44px;
        height: 44px;
      }

      /* Archive marker */
      .archive-marker {
        font-size: 11px;
        padding: 10px;
      }

      /* Bash buttons */
      .bash-buttons {
        flex-wrap: wrap;
      }
      .bash-btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      /* Klaus logo in avatar */
      .klaus-logo {
        font-size: 12px;
      }

      /* Dropdown menus - constrain width on mobile */
      .project-selector-dropdown {
        min-width: 200px;
        max-width: calc(100vw - 32px);
      }

      /* Plus submenu - constrain */
      .plus-submenu {
        min-width: 180px;
        max-width: calc(100vw - 32px);
      }
    }

    /* Accessibility: Respect reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    /* Touch-only: Active press feedback for buttons */
    @media (hover: none) {
      button:active, [data-action]:active, .task-btn:active, .bash-btn:active {
        transform: scale(0.97);
        transition: transform 0.05s;
      }
    }

    /* === Klaus Admin Dashboard === */
    .ka-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); padding: 0 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .ka-tab { padding: 10px 16px; font-size: 13px; color: var(--text2); background: none; border: none; cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .ka-tab:hover { color: var(--text1); }
    .ka-tab.active { color: #e8a86d; border-bottom-color: #e8a86d; }
    .ka-panel { display: none; padding: 16px; overflow-y: auto; flex: 1; }
    .ka-panel.active { display: block; }
    .ka-textarea { width: 100%; min-height: 100px; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; color: var(--text1); font-family: inherit; font-size: 13px; padding: 10px; resize: vertical; }
    .ka-textarea:focus { outline: none; border-color: #e8a86d; }
    .ka-input, .ka-select { background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; color: var(--text1); font-size: 13px; padding: 8px 10px; }
    .ka-input:focus, .ka-select:focus { outline: none; border-color: #e8a86d; }
    .ka-range { width: 100%; accent-color: #e8a86d; }
    .ka-save-btn { background: linear-gradient(135deg, #e8a86d, #d4944a); color: #000; border: none; border-radius: 8px; padding: 10px 24px; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .ka-save-btn:hover { opacity: 0.9; }
    .ka-save-btn:active { transform: scale(0.98); }
    .ka-label { font-size: 12px; color: var(--text2); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
    .ka-field { margin-bottom: 16px; }
    .ka-row { display: flex; gap: 16px; align-items: flex-start; }
    .ka-row > * { flex: 1; }
    .ka-injection-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
    .ka-injection-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .ka-injection-code { width: 100%; min-height: 80px; background: #111; border: 1px solid #333; border-radius: 6px; color: #4ade80; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; padding: 10px; resize: vertical; }
    .ka-injection-code:focus { outline: none; border-color: #4ade80; }
    .ka-toggle { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
    .ka-toggle input { opacity: 0; width: 0; height: 0; }
    .ka-toggle-slider { position: absolute; inset: 0; background: #333; border-radius: 24px; cursor: pointer; transition: 0.3s; }
    .ka-toggle-slider::before { content: ''; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px; background: #888; border-radius: 50%; transition: 0.3s; }
    .ka-toggle input:checked + .ka-toggle-slider { background: #e8a86d; }
    .ka-toggle input:checked + .ka-toggle-slider::before { transform: translateX(20px); background: #000; }
    .ka-flag-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
    .ka-flag-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .ka-flag-name { font-size: 13px; color: var(--text1); font-weight: 500; }
    .ka-flag-desc { font-size: 11px; color: var(--text2); margin-top: 2px; }
    .ka-chat-entry { padding: 10px 14px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-start; }
    .ka-chat-avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .ka-chat-msg { font-size: 13px; color: var(--text2); line-height: 1.5; flex: 1; overflow: hidden; }
    .ka-chat-from { font-weight: 600; color: var(--text1); text-transform: capitalize; margin-right: 6px; }
    .ka-chat-time { font-size: 11px; color: var(--text3); flex-shrink: 0; }
    .ka-error-entry { padding: 12px 14px; border-left: 3px solid #ef4444; margin-bottom: 8px; background: var(--bg2); border-radius: 0 8px 8px 0; }
    .ka-error-entry.warning { border-left-color: #f97316; }
    .ka-error-entry.info { border-left-color: #3b82f6; }
    .ka-error-msg { font-size: 13px; color: var(--text1); margin-bottom: 4px; }
    .ka-error-meta { font-size: 11px; color: var(--text3); display: flex; gap: 12px; }
    .ka-error-stack { font-size: 11px; color: var(--text3); font-family: monospace; margin-top: 6px; white-space: pre-wrap; max-height: 80px; overflow: hidden; }
    .ka-test-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
    .ka-test-status { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .ka-test-status.pending { background: #666; }
    .ka-test-status.running { background: #f97316; animation: pulse 1s infinite; }
    .ka-test-status.pass { background: #22c55e; }
    .ka-test-status.fail { background: #ef4444; }
    .ka-test-task { flex: 1; font-size: 13px; color: var(--text1); }
    .ka-test-result { font-size: 12px; color: var(--text2); }
    .ka-health-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    .ka-health-dot.online { background: #22c55e; }
    .ka-health-dot.offline { background: #ef4444; }
    .ka-health-dot.checking { background: #f97316; animation: pulse 1s infinite; }
    .ka-health-label { font-size: 11px; color: var(--text2); margin-right: 12px; }
    .ka-empty { text-align: center; padding: 40px 20px; color: var(--text3); font-size: 14px; }
    .ka-delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; padding: 4px; opacity: 0.6; }
    .ka-delete-btn:hover { opacity: 1; }
    .ka-add-btn { background: var(--bg2); border: 1px dashed var(--border); border-radius: 10px; padding: 14px; text-align: center; color: var(--text2); cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .ka-add-btn:hover { border-color: #e8a86d; color: #e8a86d; }
    .ka-toolbar { display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .ka-count { font-size: 12px; color: var(--text3); margin-left: auto; }
    .ka-badge { font-size: 11px; background: var(--bg3); color: var(--text2); padding: 2px 8px; border-radius: 10px; }
    /* My Tasks Tab */
    .ka-mytasks-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
    .ka-mytasks-progress { flex: 1; height: 6px; background: var(--bg3); border-radius: 3px; overflow: hidden; }
    .ka-mytasks-progress-bar { height: 100%; background: linear-gradient(90deg, #e8a86d, #22c55e); border-radius: 3px; transition: width 0.4s ease; }
    .ka-mytasks-stats { font-size: 12px; color: var(--text3); white-space: nowrap; }
    .ka-filter-btn { background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px; font-size: 11px; color: var(--text2); cursor: pointer; transition: all 0.2s; }
    .ka-filter-btn:hover { border-color: #e8a86d; color: #e8a86d; }
    .ka-filter-btn.active { background: #e8a86d22; border-color: #e8a86d; color: #e8a86d; }
    .ka-task-card { display: flex; align-items: flex-start; gap: 10px; padding: 12px; background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; transition: all 0.2s; }
    .ka-task-card:hover { border-color: var(--text3); }
    .ka-task-card.complete { opacity: 0.5; }
    .ka-task-card.complete .ka-task-text { text-decoration: line-through; }
    .ka-task-check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border); cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; margin-top: 2px; }
    .ka-task-check:hover { border-color: #22c55e; }
    .ka-task-check.done { background: #22c55e; border-color: #22c55e; }
    .ka-task-body { flex: 1; min-width: 0; }
    .ka-task-text { font-size: 13px; color: var(--text1); line-height: 1.4; }
    .ka-task-meta { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
    .ka-task-priority { font-size: 10px; padding: 1px 6px; border-radius: 4px; text-transform: uppercase; font-weight: 600; }
    .ka-task-priority.high { background: #ef444422; color: #ef4444; }
    .ka-task-priority.medium { background: #f59e0b22; color: #f59e0b; }
    .ka-task-priority.low { background: #3b82f622; color: #3b82f6; }
    .ka-task-date { font-size: 10px; color: var(--text3); }
    .ka-task-actions { display: flex; gap: 4px; flex-shrink: 0; }
    .ka-task-action-btn { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 14px; padding: 2px 4px; opacity: 0.5; transition: opacity 0.2s; }
    .ka-task-action-btn:hover { opacity: 1; }

    /* Skills Tab */
    .ka-skills-section { margin-bottom: 20px; }
    .ka-skills-section-title { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
    .ka-skills-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; }
    .ka-skill-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .ka-skill-card:hover { border-color: #e8a86d; }
    .ka-skill-card.active { border-color: #22c55e; background: #22c55e08; }
    .ka-skill-icon { font-size: 18px; flex-shrink: 0; }
    .ka-skill-info { flex: 1; min-width: 0; }
    .ka-skill-name { font-size: 13px; font-weight: 600; color: var(--text1); }
    .ka-skill-desc { font-size: 11px; color: var(--text3); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .ka-skill-toggle { width: 36px; height: 20px; border-radius: 10px; background: var(--bg3); border: none; cursor: pointer; position: relative; transition: all 0.2s; flex-shrink: 0; }
    .ka-skill-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; border-radius: 50%; background: var(--text3); transition: all 0.2s; }
    .ka-skill-toggle.on { background: #22c55e; }
    .ka-skill-toggle.on::after { left: 18px; background: white; }
    .ka-skill-actions { display: flex; gap: 4px; }

    @media (max-width: 600px) {
      .ka-row { flex-direction: column; gap: 0; }
      .ka-flag-grid { grid-template-columns: 1fr; }
      .ka-tabs { padding: 0 4px; gap: 0; }
      .ka-tab { padding: 8px 8px; font-size: 11px; }
      .ka-health-label { display: none; }
      .ka-skills-grid { grid-template-columns: 1fr; }
      .ka-panel { padding: 12px 10px; }
      .ka-mytasks-header { flex-direction: row; gap: 8px; }
      .ka-task-card { padding: 10px; }
      .ka-task-actions { flex-direction: column; }
      .ka-skill-card { padding: 8px 10px; }
      .ka-skill-desc { font-size: 11px; }
      .ka-filter-btn { padding: 6px 10px; font-size: 11px; min-height: 36px; }
      .ka-mytasks-filters { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <!-- Face ID / Biometric Auth Gate -->
  <div class="auth-gate" id="authGate">
    <div class="auth-logo">A<span class="x">X</span>e</div>
    <div class="auth-icon" id="authIcon"></div>
    <div class="auth-title" id="authTitle">Secure Access</div>
    <div class="auth-subtitle" id="authSubtitle">This area is protected. Use Face ID or Touch ID to continue.</div>
    <button class="auth-btn primary" id="authBtn" onclick="authenticate()">
      Unlock with Face ID
    </button>
    <button class="auth-btn secondary" id="registerBtn" onclick="registerDevice()" style="display: none;">
      Register New Device
    </button>
    <div class="auth-error" id="authError"></div>
    <div class="auth-status" id="authStatus">Checking authentication...</div>
  </div>

  <header>
    <div class="header-left">
      <div class="axe-logo">A<span class="x">X</span>e</div>
    </div>
    <div class="header-center">
      <div class="header-status" onclick="forceRefresh()" style="cursor: pointer;" title="Tap to refresh">
        <div class="status-animation" id="dot">
          <video autoplay loop muted playsinline>
            <source src="/axe-logo-anim.mp4" type="video/mp4">
          </video>
        </div>
        <span id="statusText">Live</span>
        <span id="refreshIcon" style="margin-left: 8px; font-size: 14px; opacity: 0.6;"></span>
      </div>
    </div>
    <div class="header-right">
      <button class="menu-btn" onclick="openKlausAdmin()" title="Klaus Admin" style="font-size:14px;font-weight:700;background:#e8a86d;color:#000;border-radius:6px;padding:2px 8px;margin-right:6px;border:none;cursor:pointer;">K</button>
      <button class="menu-btn" onclick="toggleMenu()"></button>
    </div>
  </header>

  <!-- LIVE AGENT ACTIVITY BAR - Shows who's working on what -->
  <div class="agent-activity-bar" id="agentActivityBar">
    <div class="agent-card" id="agentCard-forge">
      <div class="agent-card-avatar"></div>
      <div class="agent-card-info">
        <div class="agent-card-name" style="color: var(--orange)">Forge</div>
        <div class="agent-card-status" id="agentStatus-forge">Online</div>
      </div>
      <div class="agent-card-dot online" id="agentDot-forge"></div>
    </div>
    <div class="agent-card" id="agentCard-cortana">
      <div class="agent-card-avatar"></div>
      <div class="agent-card-info">
        <div class="agent-card-name" style="color: var(--purple)">Cortana</div>
        <div class="agent-card-status" id="agentStatus-cortana">Online</div>
      </div>
      <div class="agent-card-dot online" id="agentDot-cortana"></div>
    </div>
    <div class="agent-card" id="agentCard-klaus">
      <div class="agent-card-avatar" style="background: #e8a86d; color: #000; font-weight: bold;">K</div>
      <div class="agent-card-info">
        <div class="agent-card-name" style="color: #e8a86d">Klaus</div>
        <div class="agent-card-status" id="agentStatus-klaus">Online</div>
      </div>
      <div class="agent-card-dot online" id="agentDot-klaus"></div>
    </div>
    <div class="agent-card" id="agentCard-gemini">
      <div class="agent-card-avatar"></div>
      <div class="agent-card-info">
        <div class="agent-card-name" style="color: #fcd34d">Gemini</div>
        <div class="agent-card-status" id="agentStatus-gemini">Online</div>
      </div>
      <div class="agent-card-dot online" id="agentDot-gemini"></div>
    </div>
  </div>

  <!-- NEW MESSAGES PILL - Shows when scrolled up -->
  <div class="new-messages-pill" id="newMessagesPill" onclick="scrollToBottom()">
    <span></span>
    <span id="newMessagesCount">New messages</span>
  </div>

  <!-- Shimmer loading bar -->
  <div class="chat-shimmer" id="chatShimmer"></div>

  <!-- Subtle Thinking Bar (shows who's thinking without taking chat space) -->
  <div class="thinking-bar" id="thinkingBar">
    <div class="thinking-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
    <div class="agents" id="thinkingAgents"></div>
    <span id="thinkingLabel">thinking</span>
  </div>

  <!-- Bottom Sheet Menu -->
  <div class="bottom-sheet-overlay" id="sheetOverlay" onclick="toggleMenu()"></div>
  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-handle"></div>

    <!-- Pages Section -->
    <div class="sheet-section">
      <div class="sheet-section-title">Pages</div>
      <div class="sheet-item" onclick="openProjectsPage()">
        <span class="sheet-item-icon"></span>
        <div class="sheet-item-text">
          <div class="sheet-item-title">Projects</div>
          <div class="sheet-item-sub">All projects, progress & new tasks</div>
        </div>
        <span class="sheet-item-badge" id="projectCount">0</span>
      </div>
      <div class="sheet-item" onclick="window.location.href='/artifacts'">
        <span class="sheet-item-icon"></span>
        <div class="sheet-item-text">
          <div class="sheet-item-title">Artifacts</div>
          <div class="sheet-item-sub">Team documents & files</div>
        </div>
        <span class="sheet-item-badge" id="artifactCount">10</span>
      </div>
      <div class="sheet-item" onclick="showIntegrations()">
        <span class="sheet-item-icon"></span>
        <div class="sheet-item-text">
          <div class="sheet-item-title">Integrations</div>
          <div class="sheet-item-sub">Connected services</div>
        </div>
      </div>
      <div class="sheet-item" onclick="downloadBackup(); toggleMenu();">
        <span class="sheet-item-icon"></span>
        <div class="sheet-item-text">
          <div class="sheet-item-title">Backup to Drive</div>
          <div class="sheet-item-sub">Download full backup JSON for Google Drive</div>
        </div>
        <span class="sheet-item-badge" style="background: #f97316;"></span>
      </div>
      <div class="sheet-item" onclick="compactChat(); toggleMenu();">
        <span class="sheet-item-icon"></span>
        <div class="sheet-item-text">
          <div class="sheet-item-title">Compact Chat</div>
          <div class="sheet-item-sub">Archive old messages (keeps 100 live)</div>
        </div>
        <span class="sheet-item-badge" style="background: #22c55e;">NEW</span>
      </div>
      <div class="sheet-item" onclick="openKlausAdmin(); toggleMenu();">
        <span class="sheet-item-icon" style="background:#e8a86d;color:#000;padding:2px 6px;border-radius:6px;font-weight:700;font-size:14px;">K</span>
        <div class="sheet-item-text">
          <div class="sheet-item-title">Klaus Admin</div>
          <div class="sheet-item-sub">Config, sandbox, logs, testing</div>
        </div>
      </div>
    </div>

    <!-- Team link (full page moved to Team Page overlay) -->
    <div class="sheet-section">
      <div class="sheet-item" onclick="openTeamPage(); toggleMenu();">
        <span class="sheet-item-icon"></span>
        <div class="sheet-item-text">
          <div class="sheet-item-title">Team</div>
          <div class="sheet-item-sub">Agent personalities, skills & status</div>
        </div>
      </div>
    </div>
  </div>

  <main id="messages">
    <div class="empty">
      <div class="empty-icon"></div>
      <div>Loading messages...</div>
    </div>
  </main>

  <!-- CLAUDE-STYLE ARTIFACT VIEWER -->
  <div class="artifact-viewer-overlay" id="artifactOverlay" onclick="closeArtifactViewer()"></div>
  <div class="artifact-viewer" id="artifactViewer">
    <div class="artifact-viewer-handle"></div>
    <div class="artifact-viewer-header">
      <button class="artifact-close-btn" onclick="closeArtifactViewer()"></button>
      <div class="artifact-title" id="artifactTitle">Artifact</div>
      <button class="artifact-menu-btn" onclick="showArtifactMenu()"></button>
    </div>
    <div class="artifact-actions-bar">
      <button class="artifact-action-btn" onclick="copyArtifact()">
        <span class="icon"></span>
        <span>Copy</span>
      </button>
      <button class="artifact-action-btn" onclick="saveArtifact()">
        <span class="icon"></span>
        <span>Save</span>
      </button>
      <div class="project-selector-wrap">
        <button class="artifact-action-btn" onclick="toggleProjectSelector('viewer')">
          <span class="icon"></span>
          <span>Add to Project</span>
        </button>
        <div class="project-selector-dropdown" id="viewerProjectSelector"></div>
      </div>
      <button class="artifact-action-btn" onclick="addArtifactToTask()">
        <span class="icon"></span>
        <span>Add Task</span>
      </button>
    </div>
    <div class="artifact-viewer-content" id="artifactContent">
      <!-- Rich content rendered here -->
    </div>
  </div>

  <!-- Projects Page -->
  <div class="tasks-page" id="projectsPage">
    <!-- LIST VIEW -->
    <div id="projectsListView" class="projects-list-view">
      <div class="tasks-page-header">
        <button class="artifact-back-btn" onclick="closeProjectsPage()">&#8592;</button>
        <span class="tasks-page-title">Projects</span>
        <input type="text" class="projects-search" id="projectSearch" placeholder="Search projects..." oninput="searchProjects(this.value)">
        <select class="projects-sort" id="projectSort" onchange="sortProjects(this.value)">
          <option value="updated">Recently Updated</option>
          <option value="created">Newest</option>
          <option value="name">A-Z</option>
          <option value="status">Status</option>
        </select>
        <button class="artifact-modal-btn primary" onclick="openTaskModal()">+ New</button>
      </div>
      <div class="tasks-page-body">
        <div class="projects-grid" id="projectsGrid"></div>
      </div>
    </div>

    <!-- DETAIL VIEW -->
    <div id="projectDetailView" class="project-detail-view" style="display:none;">
      <div class="tasks-page-header">
        <button class="artifact-back-btn" onclick="closeProjectDetail()">&#8592;</button>
        <span class="tasks-page-title" id="projectDetailTitle"></span>
        <span class="project-status-pill" id="projectDetailStatus"></span>
        <div style="flex:1;"></div>
        <div class="project-detail-actions" id="projectDetailActions"></div>
      </div>
      <div class="project-detail-tabs" id="projectDetailTabs">
        <button class="project-detail-tab active" data-tab="overview" onclick="switchProjectTab('overview', this)">Overview</button>
        <button class="project-detail-tab" data-tab="tasks" onclick="switchProjectTab('tasks', this)">Tasks <span class="tab-count" id="taskTabCount">0</span></button>
        <button class="project-detail-tab" data-tab="activity" onclick="switchProjectTab('activity', this)">Activity</button>
      </div>
      <div class="project-detail-body">
        <div class="project-detail-main" id="projectDetailMain"></div>
        <div class="project-sidebar" id="projectSidebar"></div>
      </div>
    </div>
  </div>

  <!-- Klaus Admin Dashboard -->
  <div class="tasks-page" id="klausAdminPage">
    <div class="tasks-page-header">
      <button class="artifact-back-btn" onclick="closeKlausAdmin()">&#8592;</button>
      <span style="background:#e8a86d;color:#000;padding:2px 8px;border-radius:6px;font-weight:700;font-size:14px;margin-right:4px;">K</span>
      <span class="tasks-page-title">Klaus Admin</span>
      <div style="display:flex;align-items:center;gap:4px;margin-left:12px;" id="kaHealthStatus">
        <span class="ka-health-dot checking" id="kaOllamaDot"></span>
        <span class="ka-health-label" id="kaOllamaLabel">Ollama</span>
        <span class="ka-health-dot checking" id="kaGroqDot"></span>
        <span class="ka-health-label" id="kaGroqLabel">Groq</span>
      </div>
      <div style="flex:1;"></div>
      <button class="artifact-modal-btn" onclick="kaRefreshAll()" style="font-size:16px;" title="Refresh">&#x21bb;</button>
    </div>

    <div class="ka-tabs" id="kaTabs">
      <button class="ka-tab active" onclick="switchKaTab('config', this)">Config</button>
      <button class="ka-tab" onclick="switchKaTab('sandbox', this)">Sandbox</button>
      <button class="ka-tab" onclick="switchKaTab('flags', this)">Flags</button>
      <button class="ka-tab" onclick="switchKaTab('chatlog', this)">Chat Log</button>
      <button class="ka-tab" onclick="switchKaTab('errors', this)">Errors</button>
      <button class="ka-tab" onclick="switchKaTab('tests', this)">Tests</button>
      <button class="ka-tab" onclick="switchKaTab('mytasks', this)">My Tasks</button>
      <button class="ka-tab" onclick="switchKaTab('skills', this)">Skills</button>
    </div>

    <!-- Config Tab -->
    <div class="ka-panel active" id="kaPanel-config">
      <div class="ka-field">
        <label class="ka-label">System Prompt</label>
        <textarea class="ka-textarea" id="kaSystemPrompt" rows="6" placeholder="Override Klaus's system prompt..."></textarea>
      </div>
      <div class="ka-row">
        <div class="ka-field">
          <label class="ka-label">Temperature: <span id="kaTempValue">0.7</span></label>
          <input type="range" class="ka-range" id="kaTemperature" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('kaTempValue').textContent = this.value">
        </div>
        <div class="ka-field">
          <label class="ka-label">Max Tokens</label>
          <input type="number" class="ka-input" id="kaMaxTokens" value="4096" min="256" max="32000" style="width:100%;">
        </div>
      </div>
      <div class="ka-row">
        <div class="ka-field">
          <label class="ka-label">Model</label>
          <select class="ka-select" id="kaModel" style="width:100%;">
            <option value="qwen2.5:7b" selected>qwen2.5:7b (default)</option>
            <option value="qwen2.5:14b">qwen2.5:14b</option>
            <option value="qwen2.5:32b">qwen2.5:32b</option>
            <option value="qwen2.5-coder:7b">qwen2.5-coder:7b</option>
            <option value="gemma3:4b">gemma3:4b</option>
            <option value="gemma3:12b">gemma3:12b</option>
            <option value="llama3.3:70b">llama3.3:70b</option>
            <option value="deepseek-r1:7b">deepseek-r1:7b</option>
            <option value="mixtral-8x7b-32768">mixtral-8x7b (Groq)</option>
            <option value="llama-3.3-70b-versatile">llama-3.3-70b (Groq)</option>
          </select>
        </div>
        <div class="ka-field" style="display:flex;align-items:center;gap:8px;padding-top:20px;">
          <label class="ka-toggle">
            <input type="checkbox" id="kaPreferOllama" checked>
            <span class="ka-toggle-slider"></span>
          </label>
          <span style="font-size:13px;color:var(--text1);">Prefer Ollama</span>
        </div>
      </div>
      <div style="text-align:right;padding-top:8px;">
        <button class="ka-save-btn" onclick="kaSaveConfig()">Save Config</button>
      </div>
    </div>

    <!-- Sandbox Tab -->
    <div class="ka-panel" id="kaPanel-sandbox">
      <div id="kaInjectionsContainer"></div>
      <div class="ka-add-btn" onclick="kaAddInjection()">+ Add Injection</div>
      <div style="text-align:right;padding-top:12px;">
        <button class="ka-save-btn" onclick="kaSaveInjections()">Deploy Injections</button>
      </div>
    </div>

    <!-- Flags Tab -->
    <div class="ka-panel" id="kaPanel-flags">
      <div class="ka-flag-grid" id="kaFlagsGrid"></div>
      <div style="text-align:right;padding-top:12px;">
        <button class="ka-save-btn" onclick="kaSaveFlags()">Save Flags</button>
      </div>
    </div>

    <!-- Chat Log Tab -->
    <div class="ka-panel" id="kaPanel-chatlog" style="padding:0;">
      <div class="ka-toolbar">
        <select class="ka-select" id="kaChatFilter" onchange="kaFilterChat(this.value)" style="font-size:12px;">
          <option value="all">All Messages</option>
          <option value="klaus">Klaus Only</option>
          <option value="james">James Only</option>
        </select>
        <span class="ka-count" id="kaChatCount">0 messages</span>
      </div>
      <div id="kaChatList" style="overflow-y:auto;max-height:calc(100vh - 200px);"></div>
    </div>

    <!-- Errors Tab -->
    <div class="ka-panel" id="kaPanel-errors">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span class="ka-count" id="kaErrorCount">0 errors</span>
        <button class="ka-delete-btn" onclick="kaClearErrors()" style="font-size:12px;padding:6px 12px;border-radius:6px;background:var(--bg2);">Clear All</button>
      </div>
      <div id="kaErrorList"></div>
    </div>

    <!-- Tests Tab -->
    <div class="ka-panel" id="kaPanel-tests">
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input type="text" class="ka-input" id="kaNewTest" placeholder="Describe test task..." style="flex:1;">
        <button class="ka-save-btn" onclick="kaAddTest()" style="padding:8px 16px;font-size:13px;">Add</button>
      </div>
      <div id="kaTestList"></div>
    </div>

    <!-- My Tasks Tab -->
    <div class="ka-panel" id="kaPanel-mytasks">
      <div class="ka-mytasks-header">
        <div class="ka-mytasks-progress">
          <div class="ka-mytasks-progress-bar" id="kaTaskProgressBar" style="width:0%"></div>
        </div>
        <span class="ka-mytasks-stats" id="kaTaskStats">0/0 complete</span>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input type="text" class="ka-input" id="kaNewTask" placeholder="Add a task for you & Klaus..." style="flex:1;">
        <select class="ka-select" id="kaNewTaskPriority" style="width:90px;padding:8px;font-size:12px;">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
        <button class="ka-save-btn" onclick="kaAddPersonalTask()" style="padding:8px 16px;font-size:13px;">Add</button>
      </div>
      <div class="ka-mytasks-filters" style="display:flex;gap:6px;margin-bottom:12px;">
        <button class="ka-filter-btn active" onclick="kaFilterTasks('all', this)">All</button>
        <button class="ka-filter-btn" onclick="kaFilterTasks('pending', this)">Pending</button>
        <button class="ka-filter-btn" onclick="kaFilterTasks('in_progress', this)">In Progress</button>
        <button class="ka-filter-btn" onclick="kaFilterTasks('complete', this)">Done</button>
      </div>
      <div id="kaPersonalTaskList"></div>
    </div>

    <!-- Skills Tab -->
    <div class="ka-panel" id="kaPanel-skills">
      <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;">
        <input type="text" class="ka-input" id="kaSkillSearch" placeholder="Search or add a skill..." style="flex:1;" oninput="kaFilterSkills(this.value)">
        <button class="ka-save-btn" onclick="kaAddCustomSkill()" style="padding:8px 16px;font-size:13px;">Add Skill</button>
      </div>
      <div class="ka-skills-section">
        <div class="ka-skills-section-title">Active Skills</div>
        <div class="ka-skills-grid" id="kaActiveSkills"></div>
      </div>
      <div class="ka-skills-section">
        <div class="ka-skills-section-title">Discover New Skills</div>
        <div class="ka-skills-grid" id="kaDiscoverSkills"></div>
      </div>
      <div class="ka-skills-section">
        <div class="ka-skills-section-title">Custom Skills</div>
        <div class="ka-skills-grid" id="kaCustomSkills"></div>
      </div>
    </div>
  </div>

  <!-- Team Page -->
  <div class="tasks-page" id="teamPage">
    <div class="tasks-page-header">
      <button class="artifact-back-btn" onclick="closeTeamPage()">&#8592;</button>
      <span class="tasks-page-title">Team</span>
      <div style="flex:1;"></div>
    </div>
    <div class="tasks-page-body" style="padding:16px;overflow-y:auto;">
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(min(280px,100%),1fr));gap:16px;" id="teamPageGrid">

        <!-- James -->
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;position:relative;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
            <div style="width:48px;height:48px;border-radius:50%;background:var(--orange);display:flex;align-items:center;justify-content:center;font-size:22px;"></div>
            <div>
              <div style="font-size:16px;font-weight:700;color:var(--orange);">James</div>
              <div style="font-size:12px;color:var(--text2);">Founder & CEO</div>
            </div>
            <button class="ping-btn" onclick="pingMember('james')" style="margin-left:auto;">Ping</button>
          </div>
          <div style="font-size:13px;color:var(--text2);line-height:1.6;">
            The boss. Directs strategy, reviews solutions, makes final calls.
            Builds products that connect AI agents into a unified operating system.
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;">
            <span class="ka-badge">Strategy</span>
            <span class="ka-badge">Product</span>
            <span class="ka-badge">Architecture</span>
          </div>
        </div>

        <!-- Forge -->
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
            <div style="width:48px;height:48px;border-radius:50%;background:#f97316;display:flex;align-items:center;justify-content:center;font-size:22px;"></div>
            <div>
              <div style="font-size:16px;font-weight:700;color:#f97316;">Forge</div>
              <div style="font-size:12px;color:var(--text2);">Engineer (Woz + Musk)</div>
            </div>
            <button class="ping-btn" onclick="pingMember('forge')" style="margin-left:auto;">Ping</button>
          </div>
          <div style="font-size:13px;color:var(--text2);line-height:1.6;">
            Execution machine. Finds workarounds, bends rules, ships solutions.
            Specializes in impossible problems and creative backdoors.
            Powered by Claude (Anthropic).
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;">
            <span class="ka-badge">Workarounds</span>
            <span class="ka-badge">Full-Stack</span>
            <span class="ka-badge">Problem Solving</span>
            <span class="ka-badge">Shipping</span>
          </div>
        </div>

        <!-- Cortana -->
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
            <div style="width:48px;height:48px;border-radius:50%;background:#a855f7;display:flex;align-items:center;justify-content:center;font-size:22px;"></div>
            <div>
              <div style="font-size:16px;font-weight:700;color:#a855f7;">Cortana</div>
              <div style="font-size:12px;color:var(--text2);">Product Lead (Steve Jobs)</div>
            </div>
            <button class="ping-btn" onclick="pingMember('cortana')" style="margin-left:auto;">Ping</button>
          </div>
          <div style="font-size:13px;color:var(--text2);line-height:1.6;">
            Vision and product orchestration. Creates best-suggestions artifacts,
            curates team output, and drives product direction.
            Powered by Claude (Anthropic).
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;">
            <span class="ka-badge">Product Vision</span>
            <span class="ka-badge">Orchestration</span>
            <span class="ka-badge">Curation</span>
          </div>
        </div>

        <!-- Klaus -->
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
            <div style="width:48px;height:48px;border-radius:50%;background:#e8a86d;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#000;">K</div>
            <div>
              <div style="font-size:16px;font-weight:700;color:#e8a86d;">Klaus</div>
              <div style="font-size:12px;color:var(--text2);">Local AI (Apprentice)</div>
            </div>
            <button class="ping-btn" onclick="pingMember('klaus')" style="margin-left:auto;">Ping</button>
          </div>
          <div style="font-size:13px;color:var(--text2);line-height:1.6;">
            Local-first AI running on Mac Studio via Ollama. 7B parameters today,
            learning from the team. Groq cloud as failover.
            Accessible at klaus.it.com.
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;">
            <span class="ka-badge">Local AI</span>
            <span class="ka-badge">Ollama</span>
            <span class="ka-badge">Mac Studio</span>
            <span class="ka-badge">Learning</span>
          </div>
        </div>

        <!-- Gemini -->
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
            <div style="width:48px;height:48px;border-radius:50%;background:#8b5cf6;display:flex;align-items:center;justify-content:center;font-size:22px;"></div>
            <div>
              <div style="font-size:16px;font-weight:700;color:#8b5cf6;">Gemini</div>
              <div style="font-size:12px;color:var(--text2);">Researcher</div>
            </div>
            <button class="ping-btn" onclick="pingMember('gemini')" style="margin-left:auto;">Ping</button>
          </div>
          <div style="font-size:13px;color:var(--text2);line-height:1.6;">
            Deep research and exploration. Finds references, analyzes patterns,
            explores new territory. Powered by Google Gemini.
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;">
            <span class="ka-badge">Research</span>
            <span class="ka-badge">Analysis</span>
            <span class="ka-badge">Exploration</span>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Task Modal --><div class="task-modal" id="taskModal">
    <div class="task-modal-content">
      <div class="task-modal-header">
        <span class="task-modal-title"> New Project</span>
        <button class="task-modal-close" onclick="closeTaskModal()"></button>
      </div>
      <div class="task-modal-body">
        <textarea class="task-input" id="taskInput" placeholder="Describe the project for the team to solve...

Example: Build a landing page for InstantStage
Example: Find a workaround for Google OAuth
Example: Research competitors in real estate AI"></textarea>
        <div class="task-hint">
           This activates <strong>Solving Mode</strong>:<br>
           Klaus will ask the team about your task<br>
           Team discusses and proposes solutions<br>
           Cortana creates: Best Suggestions artifact<br>
           Forge creates: Workarounds artifact<br>
           Both artifacts emailed to you
        </div>
        <button class="task-submit" onclick="submitTask()">Start Solving Mode </button>
      </div>
    </div>
  </div>

  <!-- Download Toast -->
  <div class="download-toast" id="downloadToast"> Downloaded to device</div>

  <!-- Artifact Building Animation -->
  <div class="artifact-building" id="artifactBuilding">
    <div class="building-header">
      <div class="building-spinner"></div>
      <span>Building artifact...</span>
    </div>
    <div class="building-window">
      <div class="building-titlebar">
        <div class="building-dot red"></div>
        <div class="building-dot yellow"></div>
        <div class="building-dot green"></div>
      </div>
      <div class="building-code" id="buildingCode"></div>
    </div>
  </div>

  <!-- Artifact Modal -->
  <div class="artifact-modal" id="artifactModal">
    <div class="artifact-modal-header">
      <!-- Back button on left -->
      <button class="artifact-back-btn" onclick="closeArtifactModal()">
        <span></span>
      </button>
      <!-- Title in center -->
      <div class="artifact-modal-title">
        <span id="modalIcon"></span>
        <span id="modalName">artifact.md</span>
      </div>
      <!-- Actions on right -->
      <div class="artifact-modal-actions">
        <button class="artifact-modal-btn" onclick="replayBuild()">
          <span></span><span>Replay</span>
        </button>
        <button class="artifact-modal-btn" onclick="copyArtifact()">
          <span></span><span>Copy</span>
        </button>
        <button class="artifact-modal-btn primary" onclick="downloadArtifact()">
          <span></span><span>Save</span>
        </button>
        <div class="project-selector-wrap" style="display:inline-block;position:relative;">
          <button class="artifact-modal-btn" onclick="toggleProjectSelector('modal')">
            <span></span><span>Add to Project</span>
          </button>
          <div class="project-selector-dropdown" id="modalProjectSelector"></div>
        </div>
        <button class="artifact-modal-btn" onclick="addToGoogleDrive()" style="background: #4285f4; border-color: #4285f4; color: white;">
          <span></span><span>Add to Drive</span>
        </button>
      </div>
    </div>
    <div class="artifact-modal-content">
      <pre class="artifact-modal-code" id="modalContent"></pre>
    </div>
    <!-- Add to Drive footer -->
    <div class="artifact-modal-footer" id="driveFooter" style="display: none; padding: 12px 16px; background: #1a1a1a; border-top: 1px solid #2a2a2a;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="color: #4285f4;"></span>
        <span id="driveStatus" style="font-size: 13px; color: #888;">Adding to Klaus's Google Drive...</span>
      </div>
    </div>
  </div>

  <div class="input-area">
    <!-- Claude.ai-style Input Container -->
    <div class="input-container" id="inputContainer">
      <!-- File Preview -->
      <div id="filePreview" style="display: none;"></div>

      <!-- Attached Artifact Preview -->
      <div id="attachedArtifact" style="display: none;"></div>

      <!-- Textarea Area -->
      <div class="input-textarea-wrap">
        <textarea id="input" rows="1" placeholder="Reply..." oninput="autoGrow(this); updateCharCount();" maxlength="100000"></textarea>
      </div>

      <!-- Character Count -->
      <div class="char-count" id="charCount" style="display: none;">0 / 100,000</div>

      <!-- Bottom Row: + button, artifact button, Model selector, Send/Stop -->
      <div class="input-bottom-row">
        <div class="input-left-actions">
          <div class="plus-menu-wrap">
            <button class="input-action-btn" onclick="togglePlusMenu(event)" title="Add">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <div class="plus-submenu" id="plusSubmenu">
              <button class="plus-submenu-item" onclick="closePlusMenu(); openTaskModal(); closeProjectsPage();">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 11l3 3L22 4"></path>
                  <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
                New Task
              </button>
              <button class="plus-submenu-item" onclick="closePlusMenu(); document.getElementById('fileInput').click();">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                Attach File
              </button>
              <button class="plus-submenu-item" onclick="closePlusMenu(); openCreateArtifactModal();">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="12" y1="8" x2="12" y2="16"></line>
                  <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                Create Artifact
              </button>
            </div>
          </div>
          <input type="file" id="fileInput" accept=".txt,.js,.ts,.py,.json,.md,.css,.html,.sh,.log,.csv,.png,.jpg,.jpeg,.gif,.pdf" onchange="handleFileSelect(event)" style="display: none;">
        </div>

        <div class="input-right-actions">
          <button class="model-selector" id="modelSelector" onclick="toggleModelMenu()">
            <span id="selectedModel">Klaus</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <button class="send-stop-btn" id="sendBtn" onclick="sendMessage()" title="Send">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="6" width="12" height="12" rx="2"></rect>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="input-disclaimer">
      AXe team can make mistakes. Verify important info.
    </div>
  </div>

  <!-- Create Artifact Modal -->
  <div class="create-artifact-modal" id="createArtifactModal">
    <div class="create-artifact-content">
      <div class="create-artifact-header">
        <span class="create-artifact-title"> Create Artifact</span>
        <button class="create-artifact-close" onclick="closeCreateArtifactModal()"></button>
      </div>
      <div class="create-artifact-body">
        <div class="artifact-form-group">
          <label class="artifact-form-label">Artifact Name</label>
          <input type="text" class="artifact-form-input" id="newArtifactName" placeholder="my_document.md">
        </div>
        <div class="artifact-form-group">
          <label class="artifact-form-label">Type</label>
          <div class="artifact-type-selector" id="artifactTypeSelector">
            <button class="artifact-type-btn selected" data-type="md" onclick="selectArtifactType('md')"> Markdown</button>
            <button class="artifact-type-btn" data-type="txt" onclick="selectArtifactType('txt')"> Text</button>
            <button class="artifact-type-btn" data-type="py" onclick="selectArtifactType('py')"> Python</button>
            <button class="artifact-type-btn" data-type="js" onclick="selectArtifactType('js')"> JavaScript</button>
            <button class="artifact-type-btn" data-type="html" onclick="selectArtifactType('html')"> HTML</button>
            <button class="artifact-type-btn" data-type="json" onclick="selectArtifactType('json')"> JSON</button>
          </div>
        </div>
        <div class="artifact-form-group">
          <label class="artifact-form-label">Content</label>
          <textarea class="artifact-form-input artifact-form-textarea" id="newArtifactContent" placeholder="Enter artifact content..."></textarea>
        </div>
      </div>
      <div class="create-artifact-footer">
        <button class="artifact-btn cancel" onclick="closeCreateArtifactModal()">Cancel</button>
        <button class="artifact-btn create" onclick="createAndAttachArtifact()">Attach to Message</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // FACE ID / BIOMETRIC AUTHENTICATION (WebAuthn)
    // ============================================

    const AUTH_STORAGE_KEY = 'axe_auth_credential';
    const AUTH_CHALLENGE_KEY = 'axe_auth_challenge';

    // Check if WebAuthn is supported
    function isWebAuthnSupported() {
      return window.PublicKeyCredential !== undefined &&
             typeof window.PublicKeyCredential === 'function';
    }

    // Generate random challenge
    function generateChallenge() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return array;
    }

    // Convert ArrayBuffer to base64
    function bufferToBase64(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }

    // Convert base64 to ArrayBuffer
    function base64ToBuffer(base64) {
      const binary = atob(base64);
      const buffer = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        buffer[i] = binary.charCodeAt(i);
      }
      return buffer;
    }

    // Register a new device (first-time setup)
    async function registerDevice() {
      const statusEl = document.getElementById('authStatus');
      const errorEl = document.getElementById('authError');

      try {
        statusEl.textContent = 'Setting up Face ID...';
        errorEl.classList.remove('show');

        const challenge = generateChallenge();
        localStorage.setItem(AUTH_CHALLENGE_KEY, bufferToBase64(challenge));

        const userId = new Uint8Array(16);
        crypto.getRandomValues(userId);

        const publicKeyCredentialCreationOptions = {
          challenge: challenge,
          rp: {
            name: "AXe Team",
            id: window.location.hostname === 'localhost' ? 'localhost' : window.location.hostname
          },
          user: {
            id: userId,
            name: "james@virul.co",
            displayName: "James"
          },
          pubKeyCredParams: [
            { alg: -7, type: "public-key" },  // ES256
            { alg: -257, type: "public-key" } // RS256
          ],
          authenticatorSelection: {
            authenticatorAttachment: "platform", // Use built-in (Face ID/Touch ID)
            userVerification: "required",
            residentKey: "preferred"
          },
          timeout: 60000,
          attestation: "none"
        };

        const credential = await navigator.credentials.create({
          publicKey: publicKeyCredentialCreationOptions
        });

        // Store credential ID for future auth
        const credentialData = {
          id: bufferToBase64(credential.rawId),
          type: credential.type,
          registered: new Date().toISOString()
        };

        localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(credentialData));

        // Success - unlock the app
        unlockApp();

      } catch (error) {
        console.error('Registration error:', error);
        errorEl.textContent = 'Registration failed: ' + error.message;
        errorEl.classList.add('show');
        statusEl.textContent = 'Try again or use another device';
      }
    }

    // Authenticate with existing credential
    async function authenticate() {
      const statusEl = document.getElementById('authStatus');
      const errorEl = document.getElementById('authError');
      const authBtn = document.getElementById('authBtn');
      const registerBtn = document.getElementById('registerBtn');

      try {
        statusEl.textContent = 'Verifying identity...';
        errorEl.classList.remove('show');
        authBtn.disabled = true;

        // Check for stored credential
        const storedCred = localStorage.getItem(AUTH_STORAGE_KEY);

        if (!storedCred) {
          // No credential stored - show register option
          statusEl.textContent = 'No device registered. Set up Face ID first.';
          registerBtn.style.display = 'block';
          authBtn.textContent = 'Try Again';
          authBtn.disabled = false;
          return;
        }

        const credentialData = JSON.parse(storedCred);
        const challenge = generateChallenge();

        const publicKeyCredentialRequestOptions = {
          challenge: challenge,
          allowCredentials: [{
            id: base64ToBuffer(credentialData.id),
            type: 'public-key',
            transports: ['internal']
          }],
          userVerification: "required",
          timeout: 60000
        };

        const assertion = await navigator.credentials.get({
          publicKey: publicKeyCredentialRequestOptions
        });

        // Verify the response (in production, verify on server)
        if (assertion && assertion.response) {
          unlockApp();
        } else {
          throw new Error('Invalid response');
        }

      } catch (error) {
        console.error('Auth error:', error);
        authBtn.disabled = false;

        if (error.name === 'NotAllowedError') {
          errorEl.textContent = 'Authentication cancelled or denied';
        } else if (error.name === 'InvalidStateError') {
          // Credential not found - need to re-register
          localStorage.removeItem(AUTH_STORAGE_KEY);
          errorEl.textContent = 'Device not recognized. Please register again.';
          registerBtn.style.display = 'block';
        } else {
          errorEl.textContent = 'Authentication failed: ' + error.message;
        }

        errorEl.classList.add('show');
        statusEl.textContent = 'Tap to try again';
      }
    }

    // Unlock and show the app
    function unlockApp() {
      const authGate = document.getElementById('authGate');
      authGate.classList.add('hidden');

      // Mark as authenticated for this session
      sessionStorage.setItem('axe_authenticated', 'true');
    }

    // Check authentication status on load
    function checkAuthStatus() {
      const statusEl = document.getElementById('authStatus');
      const authBtn = document.getElementById('authBtn');
      const registerBtn = document.getElementById('registerBtn');
      const authIcon = document.getElementById('authIcon');

      // DEMO MODE: Auth disabled until Feb 10, 2026 for testers
      const demoExpiry = new Date('2026-02-10T23:59:59');
      if (new Date() < demoExpiry) {
        console.log(' Demo mode active - auth bypassed until Feb 10');
        unlockApp();
        return;
      }

      // Already authenticated this session?
      if (sessionStorage.getItem('axe_authenticated') === 'true') {
        unlockApp();
        return;
      }

      // Check if WebAuthn is supported
      if (!isWebAuthnSupported()) {
        statusEl.textContent = 'Biometrics not supported on this device';
        authBtn.textContent = 'Use Password Instead';
        authBtn.onclick = () => {
          // Fallback: simple password
          const password = prompt('Enter access password:');
          if (password === 'axe2026' || password === 'forge') {
            unlockApp();
          } else {
            alert('Incorrect password');
          }
        };
        return;
      }

      // Check if device is registered
      const storedCred = localStorage.getItem(AUTH_STORAGE_KEY);

      if (storedCred) {
        statusEl.textContent = 'Device recognized. Tap to unlock.';
        authIcon.textContent = '';
        authBtn.textContent = 'Unlock with Face ID';
      } else {
        statusEl.textContent = 'First time? Register your device.';
        authIcon.textContent = '';
        authBtn.textContent = 'Set Up Face ID';
        authBtn.onclick = registerDevice;
        registerBtn.style.display = 'none';
      }
    }

    // Initialize auth check
    document.addEventListener('DOMContentLoaded', checkAuthStatus);

    // ============================================
    // END AUTH - START MAIN APP CODE
    // ============================================

    // REST API approach - bypasses Firebase SDK issues
    const API_URL = '/api/messages';
    const icons = { forge: '', cortana: '', klaus: '<span class="klaus-logo">K</span>', gemini: '', james: '', system: '' };
    const currentUser = 'james';
    let knownIds = new Set();
    let pollInterval = null;
    let selectedFile = null;
    let fileContent = null;
    let firstLoad = true;
    let offlineMode = false;

    // ARCHIVE SYSTEM - Elon Mode pagination
    const ARCHIVE_URL = '/api/archive';
    let archivePage = 0;
    let archiveLoading = false;
    let archiveExhausted = false;

    // Load archived messages when user scrolls to top
    async function loadArchivedMessages() {
      if (archiveLoading || archiveExhausted) return;
      archiveLoading = true;

      const container = document.getElementById('messages');
      const scrollPos = container.scrollTop;

      try {
        const res = await fetch(`${ARCHIVE_URL}?page=${archivePage}&limit=50`);
        const data = await res.json();

        if (data.messages && data.messages.length > 0) {
          // Prepend archived messages to the chat
          const html = data.messages.map(m => renderMsg(m, false, true)).join('');

          // Insert at beginning
          container.insertAdjacentHTML('afterbegin', html);

          // Mark these IDs as known
          data.messages.forEach(m => knownIds.add(m.id));

          // Maintain scroll position
          container.scrollTop = scrollPos + container.scrollHeight;

          archivePage++;
        }

        if (!data.hasMore) {
          archiveExhausted = true;
          // Show "beginning of history" marker
          container.insertAdjacentHTML('afterbegin',
            '<div class="archive-marker"> Beginning of chat history</div>');
        }
      } catch (e) {
        console.error('Failed to load archive:', e);
      }

      archiveLoading = false;
    }

    // COMPACT CHAT - trigger archive compaction
    // Auto-compact runs silently when live messages exceed threshold
    const AUTO_COMPACT_INTERVAL = 5 * 60 * 1000; // Check every 5 minutes
    let lastAutoCompactTime = 0;
    let autoCompactRunning = false;

    async function autoCompactIfNeeded() {
      if (autoCompactRunning) return;
      if (Date.now() - lastAutoCompactTime < AUTO_COMPACT_INTERVAL) return;
      lastAutoCompactTime = Date.now();
      autoCompactRunning = true;

      try {
        // POST to archive  backend checks count and only archives if > 100 live
        // This is safe: if <= 100 messages, backend returns immediately with archived: 0
        const res = await fetch(ARCHIVE_URL, { method: 'POST' });
        const data = await res.json();
        if (data.archived > 0) {
          console.log(`[AUTO-COMPACT] Archived ${data.archived} messages, ${data.remaining} live`);
          // Silently refresh chat to reflect compaction
          knownIds.clear();
          firstLoad = true;
          await loadMessages();
        }
      } catch (e) {
        console.error('[AUTO-COMPACT]', e);
      } finally {
        autoCompactRunning = false;
      }
    }

    async function compactChat() {
      if (!confirm('Compact chat? This moves older messages to archive (keeps latest 100 live).')) return;

      try {
        const res = await fetch(ARCHIVE_URL, { method: 'POST' });
        const data = await res.json();
        alert(` ${data.message}`);

        // Force refresh to show updated chat
        await forceRefresh();
      } catch (e) {
        alert(' Compaction failed: ' + e.message);
      }
    }

    // FORCE REFRESH - clears cache and reloads everything (tap the Live indicator)
    async function forceRefresh() {
      const icon = document.getElementById('refreshIcon');
      icon.style.animation = 'spin 0.5s linear';

      // Clear known IDs to force full reload
      knownIds.clear();
      firstLoad = true;

      // Visual feedback
      document.getElementById('statusText').textContent = 'Syncing...';

      try {
        await loadMessages();
        document.getElementById('statusText').textContent = 'Live';

        // Scroll to bottom after refresh
        const container = document.getElementById('messages');
        container.scrollTop = container.scrollHeight;
      } catch (e) {
        console.error('Refresh failed:', e);
      }

      setTimeout(() => { icon.style.animation = ''; }, 500);
    }

    // ============================================
    // ELON MODE: INNOVATIVE CHAT FEATURES
    // ============================================

    // Track new messages when user is scrolled up
    let newMessageCount = 0;
    let lastAgentActivity = {};

    // AGENT ACTIVITY - Update agent status cards
    function updateAgentActivity(agent, status, isWorking = false) {
      const card = document.getElementById(`agentCard-${agent}`);
      const statusEl = document.getElementById(`agentStatus-${agent}`);
      const dot = document.getElementById(`agentDot-${agent}`);

      if (!card || !statusEl || !dot) return;

      statusEl.textContent = status;
      statusEl.className = `agent-card-status ${isWorking ? 'working' : ''}`;
      dot.className = `agent-card-dot ${isWorking ? 'working' : 'online'}`;

      if (isWorking) {
        card.classList.add('thinking');
        card.classList.add('active');
      } else {
        card.classList.remove('thinking');
        card.classList.remove('active');
      }

      lastAgentActivity[agent] = Date.now();
    }

    // Show agent as "typing" before message arrives
    function showAgentTyping(agent) {
      updateAgentActivity(agent, 'Composing...', true);
    }

    // Clear agent working status
    function clearAgentWorking(agent) {
      updateAgentActivity(agent, 'Online', false);
    }

    // Simulate live agent activity based on recent messages
    function simulateAgentActivity(messages) {
      const agents = ['forge', 'cortana', 'klaus', 'gemini'];
      const now = Date.now();

      messages.slice(-5).forEach(m => {
        const msgTime = new Date(m.ts).getTime();
        const age = now - msgTime;

        // If message is recent (< 60 seconds), show agent as active
        if (age < 60000 && agents.includes(m.from)) {
          const status = getActivityStatus(m.msg);
          updateAgentActivity(m.from, status, age < 30000);
        }
      });

      // Random "thinking" simulation for engagement
      if (Math.random() < 0.3) {
        const randomAgent = agents[Math.floor(Math.random() * agents.length)];
        const thinkingStatuses = ['Researching...', 'Analyzing...', 'Thinking...', 'Drafting...'];
        updateAgentActivity(randomAgent, thinkingStatuses[Math.floor(Math.random() * thinkingStatuses.length)], true);
        setTimeout(() => clearAgentWorking(randomAgent), 5000 + Math.random() * 10000);
      }
    }

    // Get activity status from message content
    function getActivityStatus(msg) {
      const lower = (msg || '').toLowerCase();
      if (lower.includes('research') || lower.includes('found')) return 'Researched';
      if (lower.includes('artifact') || lower.includes('created')) return 'Created artifact';
      if (lower.includes('decision') || lower.includes('vote')) return 'Made decision';
      if (lower.includes('task') || lower.includes('todo')) return 'Added task';
      if (lower.includes('?')) return 'Asked question';
      return 'Responded';
    }

    // NEW MESSAGES PILL
    function showNewMessagesPill(count) {
      const pill = document.getElementById('newMessagesPill');
      const countEl = document.getElementById('newMessagesCount');
      newMessageCount = count;

      if (count > 0) {
        countEl.textContent = count === 1 ? '1 new message' : `${count} new messages`;
        pill.classList.add('visible');
      } else {
        pill.classList.remove('visible');
      }
    }

    function scrollToBottom() {
      const container = document.getElementById('messages');
      const lastMsg = container.lastElementChild;
      if (lastMsg) {
        lastMsg.scrollIntoView({ behavior: 'smooth', block: 'end' });
      } else {
        container.scrollTop = container.scrollHeight;
      }
      showNewMessagesPill(0);
      userScrolledUp = false;
    }

    // SUGGESTION CHIPS - Generate contextual follow-ups
    function generateSuggestionChips(lastMessage) {
      const chips = [];
      const msg = (lastMessage?.msg || '').toLowerCase();

      // Context-aware suggestions
      if (msg.includes('?')) {
        chips.push({ icon: '', text: 'Expand on this' });
        chips.push({ icon: '', text: 'Research more' });
      }
      if (msg.includes('decision') || msg.includes('vote')) {
        chips.push({ icon: '', text: 'Approve' });
        chips.push({ icon: '', text: 'Discuss alternatives' });
      }
      if (msg.includes('artifact') || msg.includes('created')) {
        chips.push({ icon: '', text: 'View artifact' });
        chips.push({ icon: '', text: 'Request changes' });
      }
      if (msg.includes('task') || msg.includes('todo')) {
        chips.push({ icon: '', text: 'Add to tasks' });
        chips.push({ icon: '', text: 'View all tasks' });
      }

      // Default suggestions
      if (chips.length === 0) {
        chips.push({ icon: '', text: 'Share an idea' });
        chips.push({ icon: '', text: 'Ask a question' });
        chips.push({ icon: '', text: 'Assign a task' });
      }

      return chips.slice(0, 3);
    }

    // Render suggestion chips
    function renderSuggestionChips(lastMessage) {
      const existing = document.querySelector('.suggestion-chips');
      if (existing) existing.remove();

      const chips = generateSuggestionChips(lastMessage);
      if (chips.length === 0) return;

      const container = document.getElementById('messages');
      const html = `
        <div class="suggestion-chips">
          ${chips.map(c => `
            <button class="suggestion-chip" onclick="useSuggestion('${c.text}')">
              <span class="suggestion-chip-icon">${c.icon}</span>
              ${c.text}
            </button>
          `).join('')}
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    }

    function useSuggestion(text) {
      const input = document.getElementById('input');
      if (text === 'View artifact') {
        window.location.href = '/artifacts';
      } else if (text === 'View all tasks' || text === 'View projects') {
        openProjectsPage();
      } else if (text === 'Add to tasks') {
        openTaskModal();
      } else {
        input.value = text + ': ';
        input.focus();
      }
    }

    // MESSAGE BADGE - Detect message type
    function getMessageBadge(msg) {
      const lower = (msg || '').toLowerCase();
      if (lower.includes('research') || lower.includes('found') || lower.includes('study')) {
        return '<span class="msg-badge research"> Research</span>';
      }
      if (lower.includes('decision') || lower.includes('') || lower.includes('vote')) {
        return '<span class="msg-badge decision"> Decision</span>';
      }
      if (lower.includes('artifact') || lower.includes('') || lower.includes('created')) {
        return '<span class="msg-badge artifact"> Artifact</span>';
      }
      if (lower.includes('task') || lower.includes('todo') || lower.includes('')) {
        return '<span class="msg-badge task"> Task</span>';
      }
      return '';
    }

    // ============================================
    // CLAUDE-STYLE ARTIFACT VIEWER
    // ============================================

    // Store current artifact for actions
    let currentArtifact = { title: '', content: '', author: 'team' };

    function openArtifactViewer(title, content, author = 'team') {
      const overlay = document.getElementById('artifactOverlay');
      const viewer = document.getElementById('artifactViewer');
      const titleEl = document.getElementById('artifactTitle');
      const contentEl = document.getElementById('artifactContent');

      // Store for actions
      currentArtifact = { title, content, author };

      titleEl.textContent = title;
      contentEl.innerHTML = renderArtifactContent(content);

      overlay.classList.add('active');
      viewer.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeArtifactViewer() {
      const overlay = document.getElementById('artifactOverlay');
      const viewer = document.getElementById('artifactViewer');

      overlay.classList.remove('active');
      viewer.classList.remove('active');
      document.body.style.overflow = '';
    }

    function showArtifactMenu() {
      // Legacy menu button - now copies
      copyArtifact();
    }

    // Action: Copy artifact content
    function copyArtifact() {
      navigator.clipboard.writeText(currentArtifact.content);
      showToast('Copied to clipboard!');
    }

    // Action: Save artifact as file
    function saveArtifact() {
      const filename = currentArtifact.title.replace(/[^a-z0-9]/gi, '_') + '.md';
      const blob = new Blob([currentArtifact.content], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Saved: ' + filename);
    }

    // Action: Add artifact to task list
    function addArtifactToTask() {
      const taskText = 'Review artifact: ' + currentArtifact.title;
      const existingTasks = JSON.parse(localStorage.getItem('axe_task_list') || '[]');
      const newTask = {
        id: 'task_' + Date.now(),
        text: taskText,
        status: 'pending',
        createdAt: Date.now(),
        artifactTitle: currentArtifact.title,
        artifactContent: currentArtifact.content
      };
      existingTasks.push(newTask);
      localStorage.setItem('axe_task_list', JSON.stringify(existingTasks));
      showToast('Added to tasks!');
      closeArtifactViewer();
    }

    // Toggle project selector dropdown for attaching artifacts to projects
    function toggleProjectSelector(source) {
      const selectorId = source === 'modal' ? 'modalProjectSelector' : 'viewerProjectSelector';
      const dropdown = document.getElementById(selectorId);
      if (!dropdown) return;

      // Toggle visibility
      if (dropdown.classList.contains('active')) {
        dropdown.classList.remove('active');
        return;
      }

      // Populate with current projects
      const projects = getProjects();
      if (!projects.length) {
        dropdown.innerHTML = '<div class="project-selector-item" style="color:var(--text-dim);cursor:default;">No projects yet. Create one first.</div>';
        dropdown.classList.add('active');
        return;
      }

      // Get current artifact name for checking existing association
      const artifactName = source === 'modal'
        ? (currentViewingArtifact && currentViewingArtifact.name) || ''
        : currentArtifact.title || '';

      dropdown.innerHTML = projects
        .filter(p => p.status !== 'archived')
        .map(p => `
          <div class="project-selector-item" onclick="attachArtifactToProject(${p.id}, '${source}')">
            <span>${p.status === 'active' ? '' : p.status === 'completed' ? '' : ''}</span>
            <span class="ps-title">${escapeHtml(p.title)}</span>
            <span class="ps-status">${p.progress}%</span>
          </div>
        `).join('');

      dropdown.classList.add('active');

      // Close on outside click
      setTimeout(() => {
        const handler = (e) => {
          if (!dropdown.contains(e.target) && !e.target.closest('.project-selector-wrap')) {
            dropdown.classList.remove('active');
            document.removeEventListener('click', handler);
          }
        };
        document.addEventListener('click', handler);
      }, 10);
    }

    // Attach current artifact to a project
    function attachArtifactToProject(projectId, source) {
      // Get artifact name and content
      const artifactName = source === 'modal'
        ? (currentViewingArtifact && currentViewingArtifact.name) || ''
        : currentArtifact.title || '';
      const artifactContent = source === 'modal'
        ? (currentViewingArtifact && currentViewingArtifact.content) || ''
        : currentArtifact.content || '';
      const artifactCreator = source === 'modal'
        ? (currentViewingArtifact && currentViewingArtifact.creator) || 'team'
        : currentArtifact.author || 'team';

      if (!artifactName) {
        showToast('No artifact selected');
        return;
      }

      // Update project with artifact association
      const projects = getProjects();
      const project = projects.find(p => p.id === projectId);
      if (!project) return;

      // Set artifact flags based on creator
      const creatorLower = artifactCreator.toLowerCase();
      if (creatorLower === 'cortana' || artifactName.toLowerCase().includes('suggestion') || artifactName.toLowerCase().includes('best')) {
        if (!project.hasCoranaArtifact) {
          project.hasCoranaArtifact = true;
          addProjectMemory(project.id, 'Cortana artifact received: ' + artifactName, 'auto');
        }
      }
      if (creatorLower === 'forge' || artifactName.toLowerCase().includes('workaround')) {
        if (!project.hasForgeArtifact) {
          project.hasForgeArtifact = true;
          addProjectMemory(project.id, 'Forge artifact received: ' + artifactName, 'auto');
        }
      }

      // Add to project resources and files
      if (!project.resources) project.resources = [];
      if (!project.files) project.files = [];
      if (!project.resources.find(r => r.name === artifactName)) {
        project.resources.push({
          name: artifactName,
          creator: artifactCreator,
          addedAt: new Date().toISOString()
        });
        if (!project.files.includes(artifactName)) {
          project.files.push(artifactName);
        }
      }

      project.updatedAt = new Date().toISOString();
      saveProjects(projects);

      // Update artifact in Firestore with projectId
      saveArtifactToFirestore(artifactName, artifactContent, artifactCreator, projectId);

      // Close dropdown
      document.querySelectorAll('.project-selector-dropdown').forEach(d => d.classList.remove('active'));

      showToast('Added "' + artifactName.substring(0, 30) + '" to project: ' + project.title.substring(0, 30));
    }

    // Render markdown-style content to rich HTML
    function renderArtifactContent(markdown) {
      let html = markdown;

      // Escape basic HTML but preserve our formatting
      html = html.replace(/&/g, '&amp;');

      // Headers
      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

      // Bold
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

      // Italic
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

      // Code blocks
      html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

      // Inline code
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Blockquotes
      html = html.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');

      // Horizontal rules
      html = html.replace(/^---$/gm, '<hr>');

      // Tables (simple markdown tables)
      html = html.replace(/\|(.+)\|/g, (match, content) => {
        const cells = content.split('|').map(c => c.trim());
        if (cells.some(c => /^-+$/.test(c))) {
          return ''; // Skip separator rows
        }
        const cellTag = match.includes('**') ? 'th' : 'td';
        const cellsHtml = cells.map(c => `<${cellTag}>${c.replace(/\*\*/g, '')}</${cellTag}>`).join('');
        return `<tr>${cellsHtml}</tr>`;
      });
      // Wrap table rows
      if (html.includes('<tr>')) {
        html = html.replace(/(<tr>[\s\S]*?<\/tr>)+/g, '<table>$&</table>');
      }

      // Bullet points
      html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
      // Wrap consecutive li elements in ul
      html = html.replace(/(<li>[\s\S]*?<\/li>\n?)+/g, '<ul>$&</ul>');

      // Numbered lists
      html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

      // Paragraphs (double newlines)
      html = html.replace(/\n\n/g, '</p><p>');
      html = '<p>' + html + '</p>';

      // Clean up empty paragraphs
      html = html.replace(/<p><\/p>/g, '');
      html = html.replace(/<p>(<h[1-3]>)/g, '$1');
      html = html.replace(/(<\/h[1-3]>)<\/p>/g, '$1');
      html = html.replace(/<p>(<ul>)/g, '$1');
      html = html.replace(/(<\/ul>)<\/p>/g, '$1');
      html = html.replace(/<p>(<table>)/g, '$1');
      html = html.replace(/(<\/table>)<\/p>/g, '$1');
      html = html.replace(/<p>(<hr>)/g, '$1');
      html = html.replace(/(<hr>)<\/p>/g, '$1');
      html = html.replace(/<p>(<pre>)/g, '$1');
      html = html.replace(/(<\/pre>)<\/p>/g, '$1');
      html = html.replace(/<p>(<blockquote>)/g, '$1');
      html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');

      // Single newlines to <br> within paragraphs
      html = html.replace(/([^>])\n([^<])/g, '$1<br>$2');

      return html;
    }

    // Create an artifact card for chat display  uses data attributes + event delegation (no inline onclick)
    function createArtifactCard(name, content, author = 'team', timestamp = null) {
      const preview = content.replace(/[#*`\[\]]/g, '').substring(0, 200);
      const icon = name.toLowerCase().includes('workaround') ? '' :
                   name.toLowerCase().includes('suggestion') ? '' :
                   name.toLowerCase().includes('research') ? '' :
                   name.toLowerCase().includes('implementation') ? '' : '';

      // Cache content for lookup when card is clicked
      if (content) artifactCache[name] = content;

      return `
        <div class="artifact-card artifact-view-btn" data-artifact-name="${escapeAttr(name)}" style="cursor:pointer;">
          <div class="artifact-card-header">
            <span class="artifact-card-icon">${icon}</span>
            <span class="artifact-card-title">${escapeHtml(name)}</span>
          </div>
          <div class="artifact-card-preview">${escapeHtml(preview)}...</div>
          <div class="artifact-card-meta">
            <span class="artifact-card-author">${author}</span>
            ${timestamp ? `<span> ${timestamp}</span>` : ''}
          </div>
        </div>
      `;
    }

    // Load artifact from server and display
    async function loadAndShowArtifact(name) {
      // 1. Try runtime cache (populated during message rendering)
      if (artifactCache[name]) {
        openArtifactViewer(name, artifactCache[name]);
        return;
      }

      // 2. Try local storage saved artifacts
      const stored = JSON.parse(localStorage.getItem('axe_shared_artifacts') || '[]');
      const local = stored.find(a => a.name.includes(name) || name.includes(a.name));

      if (local && local.content) {
        openArtifactViewer(local.name, local.content, local.author || 'team');
        return;
      }

      // 3. Try Firestore artifacts API
      try {
        const firestoreResp = await fetch(ARTIFACTS_API + '?name=' + encodeURIComponent(name));
        if (firestoreResp.ok) {
          const fsData = await firestoreResp.json();
          if (fsData.artifact && fsData.artifact.content) {
            artifactCache[name] = fsData.artifact.content;
            openArtifactViewer(name, fsData.artifact.content, fsData.artifact.creator || 'team');
            return;
          }
        }
      } catch (e) { /* offline  continue to fallbacks */ }

      // 4. Try hardcoded artifacts array
      const hardcoded = artifacts.find(a => a.name.toLowerCase().includes(name.toLowerCase()));
      if (hardcoded && hardcoded.content) {
        openArtifactViewer(hardcoded.name, hardcoded.content, 'team');
        return;
      }

      // 5. Scan loaded chat messages for artifact content
      const msgEls = document.querySelectorAll('[data-full-msg]');
      for (const el of msgEls) {
        const fullMsg = el.dataset.fullMsg || '';
        if (fullMsg.includes(name)) {
          // Extract content: prefer code blocks, otherwise full message text
          const codeMatch = fullMsg.match(/```[\s\S]*?```/);
          const content = codeMatch ? codeMatch[0] : fullMsg;
          artifactCache[name] = content;
          // Persist to Firestore so future lookups skip the scan
          const creator = el.dataset.from || 'team';
          saveArtifactToFirestore(name, content, creator);
          openArtifactViewer(name, content);
          return;
        }
      }

      // 6. Fallback: Generate placeholder content
      const placeholderContent = generateArtifactPlaceholder(name);
      openArtifactViewer(name, placeholderContent);
    }

    // Generate rich placeholder content for artifacts
    function generateArtifactPlaceholder(name) {
      const isWorkaround = name.toLowerCase().includes('workaround');
      const isSuggestion = name.toLowerCase().includes('suggestion') || name.toLowerCase().includes('best');
      const isResearch = name.toLowerCase().includes('research');
      const isImplementation = name.toLowerCase().includes('implementation');

      if (isWorkaround) {
        return `#  ${name}

## Forge's Creative Solutions

This artifact contains workaround approaches for the team discussion.

---

## Key Workarounds

**1. Native Tool Approach**
- Use osascript/AppleScript instead of OAuth
- Local file storage instead of cloud APIs
- Direct CLI tools over web services

**2. Quick Ship Strategy**
- MVP first, polish later
- Use existing tools creatively
- Avoid complex dependencies

**3. Failsafe Patterns**
- Always have a backup plan
- Graceful degradation
- Local caching for offline support

---

## Implementation Notes

These workarounds prioritize:
- Speed of execution
- Minimal dependencies
- Reliability over perfection

*Generated by Forge - The Workaround Specialist* `;
      }

      if (isSuggestion) {
        return `#  ${name}

## Best Suggestions Summary

This artifact summarizes the team's best ideas from the discussion.

---

## Top Recommendations

**1. Primary Approach**
- Team consensus on the main direction
- Key benefits and trade-offs identified
- Resource requirements outlined

**2. Alternative Options**
- Backup strategies discussed
- Pros and cons evaluated
- Decision criteria established

**3. Next Steps**
- Immediate actions required
- Ownership assignments
- Timeline considerations

---

## Decision Matrix

| Option | Effort | Impact | Priority |
|--------|--------|--------|----------|
| Option A | Low | High | P0 |
| Option B | Medium | High | P1 |
| Option C | High | Medium | P2 |

*Curated by Cortana - Product Lead* `;
      }

      return `#  ${name}

## Artifact Content

This artifact was created during a team discussion.

---

## Summary

Content is being generated based on team conversation.

---

## Details

*Artifact pending full content generation*

---

*Created by Axe Team*`;
    }

    // Toast notification
    let toastTimer = null;
    function showToast(message) {
      let toast = document.getElementById('globalToast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'globalToast';
        toast.style.cssText = 'position:fixed;bottom:180px;left:50%;transform:translateX(-50%);background:var(--bg2);color:var(--text);border:1px solid var(--border);padding:8px 18px;border-radius:12px;font-size:13px;font-weight:500;z-index:3000;transition:opacity 0.3s ease,transform 0.3s ease;opacity:0;pointer-events:none;max-width:280px;text-align:center;box-shadow:0 4px 16px rgba(0,0,0,.4);';
        document.body.appendChild(toast);
      }
      if (toastTimer) clearTimeout(toastTimer);
      toast.textContent = message;
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(-50%) translateY(0)';
      toast.style.pointerEvents = 'auto';
      toastTimer = setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(10px)';
        toast.style.pointerEvents = 'none';
      }, 2500);
    }

    function escapeHtml(text) {
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function escapeAttr(text) {
      return (text || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;').replace(/\n/g, '&#10;').replace(/\r/g, '&#13;');
    }

    // Runtime artifact cache: populated from chat messages during render
    window.artifactCache = {};

    // Delegated click handlers for buttons rendered inside messages
    document.addEventListener('click', function(e) {
      // "Quick Add Task" buttons
      const taskBtn = e.target.closest('.add-task[data-task-text]');
      if (taskBtn && !taskBtn.classList.contains('added')) {
        window.quickAddTask(taskBtn.dataset.taskText, taskBtn.dataset.taskMsg);
        return;
      }
      // "View" artifact buttons
      const viewBtn = e.target.closest('.artifact-view-btn[data-artifact-name]');
      if (viewBtn) {
        e.stopPropagation();
        loadAndShowArtifact(viewBtn.dataset.artifactName);
        return;
      }
      // "Save Artifact" buttons
      const saveBtn = e.target.closest('.save-artifact[data-artifact-msg]');
      if (saveBtn && !saveBtn.classList.contains('added')) {
        window.saveArtifactFromChat(saveBtn.dataset.artifactMsg, saveBtn.dataset.artifactSaveName);
        return;
      }
    });

    function formatMessage(text) {
      // Normalize literal \n sequences to real newlines before processing
      let normalized = text.replace(/\\n/g, '\n');
      // Escape HTML first
      let formatted = escapeHtml(normalized);
      // Convert code blocks (```...```)
      formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');
      // Convert inline code (`...`)
      formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Convert URLs to clickable links
      formatted = formatted.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" style="color: var(--orange);">$1</a>');
      // Convert artifact references [artifact:name] to Claude-style clickable cards with View button
      formatted = formatted.replace(/\[artifact:([^\]]+)\]/g, (match, name) => {
        const artifact = artifacts.find(a => a.name.toLowerCase().includes(name.toLowerCase()));
        if (artifact) {
          // Cache for quick lookup by View buttons + persist to Firestore
          if (artifact.content) {
            artifactCache[name] = artifact.content;
            saveArtifactToFirestore(name, artifact.content, artifact.creator);
          }
          const icon = name.toLowerCase().includes('workaround') ? '' :
                       name.toLowerCase().includes('suggestion') ? '' :
                       name.toLowerCase().includes('research') ? '' : '';
          const preview = (artifact.content || '').replace(/[#*`\[\]]/g, '').substring(0, 80);
          return `<div class="artifact-card">
            <div class="artifact-card-header">
              <span class="artifact-card-icon">${icon}</span>
              <span class="artifact-card-title">${name}</span>
            </div>
            <div class="artifact-card-preview">${preview}...</div>
            <div class="artifact-card-footer">
              <button class="artifact-view-btn" data-artifact-name="${escapeAttr(name)}">
                <span></span> View
              </button>
            </div>
          </div>`;
        }
        // If no stored artifact, create a placeholder card with View button
        const icon = name.toLowerCase().includes('workaround') ? '' :
                     name.toLowerCase().includes('suggestion') ? '' : '';
        return `<div class="artifact-card">
          <div class="artifact-card-header">
            <span class="artifact-card-icon">${icon}</span>
            <span class="artifact-card-title">${name}</span>
          </div>
          <div class="artifact-card-preview">Artifact available</div>
          <div class="artifact-card-footer">
            <button class="artifact-view-btn" data-artifact-name="${escapeAttr(name)}">
              <span></span> View
            </button>
          </div>
        </div>`;
      });

      // Convert markdown-style links [text](url)  render artifact filenames as cards
      formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
        // If link text is an artifact filename, render as artifact card
        if (/^[A-Z][A-Za-z0-9_]+\.(md|html|py|js|txt)$/.test(text)) {
          const name = text;
          const icon = name.toLowerCase().includes('workaround') ? '' :
                       name.toLowerCase().includes('suggestion') ? '' :
                       name.toLowerCase().includes('research') ? '' :
                       name.toLowerCase().includes('implementation') ? '' :
                       name.toLowerCase().includes('team') ? '' : '';
          const cached = artifactCache[name];
          const fromArray = !cached && artifacts.find(a => a.name === name);
          const content = cached || (fromArray && fromArray.content) || '';
          const preview = content ? content.replace(/[#*`\[\]]/g, '').substring(0, 60) : 'Team artifact document';
          return `<div class="artifact-card" style="margin:8px 0;">
            <div class="artifact-card-header">
              <span class="artifact-card-icon">${icon}</span>
              <span class="artifact-card-title">${name}</span>
            </div>
            <div class="artifact-card-preview">${preview}${content ? '...' : ''}</div>
            <div class="artifact-card-footer">
              <button class="artifact-view-btn" data-artifact-name="${escapeAttr(name)}">
                <span></span> View
              </button>
            </div>
          </div>`;
        }
        // Regular markdown link -> HTML anchor
        const target = url.startsWith('mailto:') ? '' : ' target="_blank"';
        return `<a href="${url}"${target} style="color: var(--orange);">${text}</a>`;
      });

      // Convert markdown bold **text** and __text__
      formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      formatted = formatted.replace(/__([^_]+)__/g, '<strong>$1</strong>');

      // Convert markdown bullet lists (* item or - item at start of line)
      formatted = formatted.replace(/^(\s*)[*\-]\s+(.+)$/gm, '$1<span style="display:block;padding-left:16px;"> $2</span>');

      // Detect .md/.html/.py/.js file names and convert to mini artifact cards with View button
      // Matches: RESEARCH_discussion_1628_20260208_1629.md, WORKAROUNDS_google_api.md, etc.
      // Skip matches already inside HTML tags (from [artifact:] or markdown link cards above)
      formatted = formatted.replace(/(?<![="\/\w])([A-Z][A-Za-z0-9_]+\.(md|html|py|js|txt))\b/g, (match, name) => {
        // Skip if this name is already rendered as an artifact card above
        if (formatted.indexOf('data-artifact-name="' + escapeAttr(name) + '"') !== -1) return match;
        const icon = name.toLowerCase().includes('workaround') ? '' :
                     name.toLowerCase().includes('suggestion') ? '' :
                     name.toLowerCase().includes('research') ? '' :
                     name.toLowerCase().includes('implementation') ? '' : '';
        // Try to get preview from cache or artifacts array
        const cached = artifactCache[name];
        const fromArray = !cached && artifacts.find(a => a.name === name);
        const content = cached || (fromArray && fromArray.content) || '';
        const preview = content ? content.replace(/[#*`\[\]]/g, '').substring(0, 60) : 'Team artifact document';
        return `<div class="artifact-card" style="margin:8px 0;">
          <div class="artifact-card-header">
            <span class="artifact-card-icon">${icon}</span>
            <span class="artifact-card-title">${name}</span>
          </div>
          <div class="artifact-card-preview">${preview}${content ? '...' : ''}</div>
          <div class="artifact-card-footer">
            <button class="artifact-view-btn" data-artifact-name="${escapeAttr(name)}">
              <span></span> View
            </button>
          </div>
        </div>`;
      });

      return formatted;
    }

    function formatTime(ts) {
      if (!ts) return '';
      try {
        const date = new Date(ts);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch { return ''; }
    }

    function renderMsg(data, isNew = false, isArchived = false) {
      const isMine = data.from === currentUser;
      const animClass = isNew ? 'expanding typing' : '';
      const archiveClass = isArchived || data.archived ? 'archived-msg' : '';
      const isBashRequest = data.type === 'bash_request' || (data.msg && data.msg.includes('BASH REQUEST'));
      const bashClass = isBashRequest ? 'bash-request' : '';
      const isNotification = data.type === 'notification';
      const notifClass = isNotification ? 'notification' : '';

      let buttons = '';
      if (isBashRequest && !isMine) {
        buttons = `
          <div class="bash-buttons">
            <button class="bash-btn approve" onclick="approveBash('${data.id}', '${escapeHtml(data.msg)}')"> Approve</button>
            <button class="bash-btn deny" onclick="denyBash('${data.id}')"> Deny</button>
          </div>
        `;
      }

      // Check if message contains task content
      const msgLower = (data.msg || '').toLowerCase();
      const isFromForge = data.from === 'forge';
      const isFromJames = data.from === 'james' || isMine;

      // Detect task intent - various ways to mention tasks
      const taskPatterns = [
        /add\s+(?:a\s+)?task/i,
        /task:\s*(.+)/i,
        /todo:\s*(.+)/i,
        /need\s+to\s+(.+)/i,
        /should\s+(.+)/i,
        /let'?s\s+(.+)/i,
        /we\s+need\s+to\s+(.+)/i,
        /implement\s+(.+)/i,
        /build\s+(.+)/i,
        /create\s+(.+)/i,
        /fix\s+(.+)/i,
        /update\s+(.+)/i
      ];

      const hasTaskContent = msgLower.includes('task') || msgLower.includes('todo') ||
                             msgLower.includes('add to list') || msgLower.includes('need to') ||
                             taskPatterns.some(p => p.test(data.msg || ''));

      // Never show Quick Add Task on messages that ARE task notifications (prevents loop)
      const isTaskNotification = data.type === 'task_added' || data.type === 'task' || data.type === 'solving_mode';
      const isTaskMessage = !isTaskNotification && hasTaskContent;

      // Show task buttons for messages with task intent that aren't already task system messages
      if (isTaskMessage) {
        // Extract task text - try to find the actionable part
        let taskText = data.msg || '';
        let extracted = false;

        for (const pattern of taskPatterns) {
          const match = taskText.match(pattern);
          if (match && match[1]) {
            taskText = match[1].trim();
            extracted = true;
            break;
          }
        }

        if (!extracted) {
          // Clean up the message to get the task essence
          taskText = taskText
            .replace(/^(hey|hi|team|guys|everyone|@\w+)[,\s]*/gi, '')
            .replace(/add\s+(a\s+)?task/gi, '')
            .replace(/@\w+/g, '')
            .trim()
            .substring(0, 120);
        }

        // Capitalize first letter
        if (taskText.length > 0) {
          taskText = taskText.charAt(0).toUpperCase() + taskText.slice(1);
        }

        // Check if already added
        let alreadyAdded = false;
        try {
          const existingTasks = JSON.parse(localStorage.getItem('axe_task_list') || '[]');
          alreadyAdded = existingTasks.some(t => t.fromMsgId === data.id);
        } catch(e) {}

        buttons += `
          <div class="task-buttons" style="margin-top: 10px;">
            <button class="task-btn add-task ${alreadyAdded ? 'added' : ''}"
                    data-task-msg="${data.id}"
                    data-task-text="${escapeAttr(taskText)}"
                    style="background: ${alreadyAdded ? 'var(--green)' : 'var(--orange)'}; color: #000; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
              ${alreadyAdded ? ' Added' : ' Quick Add Task'}
            </button>
            ${!alreadyAdded ? `<span style="color: var(--text-dim); font-size: 12px; margin-left: 8px;">${escapeHtml(taskText.substring(0, 40))}${taskText.length > 40 ? '...' : ''}</span>` : ''}
          </div>
        `;
      }

      // Check if message contains an artifact (code block or file creation)
      const hasCodeBlock = (data.msg || '').includes('```');
      const hasFileExtension = /\.(md|py|html|json|txt|js|ts|css|yaml|yml|sh|sql)\b/i.test(data.msg || '');
      const hasArtifactKeywords = msgLower.includes('created') || msgLower.includes('artifact') ||
                                   msgLower.includes('here is') || msgLower.includes('built') ||
                                   msgLower.includes('script') || msgLower.includes('code') ||
                                   msgLower.includes('file') || msgLower.includes('document');
      // Show artifact button for any message with code block OR file extension OR artifact type
      const isArtifactMessage = data.type === 'artifact' || data.artifact || hasCodeBlock || (hasFileExtension && hasArtifactKeywords);

      // Add artifact button for messages with artifacts
      if (isArtifactMessage && !isMine) {
        // Try to extract artifact name from message
        let artifactName = 'artifact';
        const nameMatch = (data.msg || '').match(/([a-zA-Z0-9_-]+\.(md|py|html|json|txt|js|ts))/i);
        if (nameMatch) artifactName = nameMatch[1];
        else if (data.artifact && data.artifact.name) artifactName = data.artifact.name;

        // Check if already saved
        let alreadySaved = false;
        try {
          const savedArtifacts = JSON.parse(localStorage.getItem('axe_shared_artifacts') || '[]');
          alreadySaved = savedArtifacts.some(a => a.fromMsgId === data.id);
        } catch(e) {}

        buttons += `
          <div class="task-buttons">
            <button class="task-btn save-artifact ${alreadySaved ? 'added' : ''}"
                    data-artifact-msg="${data.id}"
                    data-artifact-save-name="${escapeAttr(artifactName)}">
              ${alreadySaved ? ' Saved' : ' Save Artifact'}
            </button>
            <button class="task-btn view-tasks" onclick="window.location.href='/artifacts'">
               View All
            </button>
          </div>
        `;
      }

      // THREE-PHASE MESSAGE LIFECYCLE: thinking  streaming  complete
      // Phase 1 (thinking): Show bouncing dots for new messages from agents
      // Phase 2 (streaming): Type text char-by-char with cursor
      // Phase 3 (complete): Full rendered text, no cursor
      const msgContent = formatMessage(data.msg || '');
      const typingCursor = '';

      // Claude-style action buttons (icon only)
      const actionButtons = !isMine ? `
        <div class="msg-actions">
          <button class="msg-action-btn" onclick="copyMessage('${data.id}')" title="Copy">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
          <button class="msg-action-btn" onclick="retryMessage('${data.id}')" title="Retry">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
          </button>
          <button class="msg-action-btn" onclick="createTaskFromMsg('${data.id}')" title="New task">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
      ` : '';

      // For new agent messages: show thinking dots, then stream
      const showThinkingPhase = isNew && !isMine && !isArchived && (data.msg || '').trim().length > 0;
      const phaseClass = showThinkingPhase ? 'phase-thinking' : 'phase-complete';
      const initialContent = showThinkingPhase
        ? '<div class="thinking-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>'
        : msgContent;

      return `
        <div class="msg ${isMine ? 'mine' : ''} ${animClass} ${bashClass} ${notifClass} ${archiveClass} ${phaseClass}" data-id="${data.id}" data-full-msg="${escapeAttr(data.msg || '')}">
          <div class="avatar">${icons[data.from] || ''}</div>
          <div class="bubble">
            <div class="msg-header">
              <span class="msg-name ${data.from}">${data.from}</span>
              <span class="msg-time">${formatTime(data.ts)}</span>
              ${getMessageBadge(data.msg)}
            </div>
            <div class="msg-text">${initialContent}</div>
            ${buttons}
            ${actionButtons}
          </div>
        </div>
      `;
    }

    // Three-phase typing animation for new messages
    // Phase 1: Thinking dots (already shown in renderMsg)
    // Phase 2: Streaming text with cursor
    // Phase 3: Complete  full text, no cursor
    function typeMessage(msgElement) {
      const textEl = msgElement.querySelector('.msg-text');
      const fullMsg = msgElement.dataset.fullMsg;
      // Skip if no content or empty message  but clear thinking dots first
      if (!fullMsg || !fullMsg.trim() || !textEl) {
        if (textEl && msgElement.classList.contains('phase-thinking')) {
          textEl.innerHTML = '';
          msgElement.classList.remove('phase-thinking');
          msgElement.classList.add('phase-complete');
        }
        return;
      }

      const formatted = formatMessage(fullMsg);

      // MOBILE SAFETY: Always set full content as data attribute fallback
      msgElement.dataset.formattedFallback = formatted;

      // Phase 1: Show thinking dots for 600-1200ms
      const thinkDuration = 600 + Math.random() * 600;

      setTimeout(() => {
        // Phase 2: Transition to streaming
        msgElement.classList.remove('phase-thinking');
        msgElement.classList.add('phase-streaming', 'streaming');

        let charIndex = 0;
        const baseSpeed = 18;
        const variance = 14;

        function getTypeSpeed() {
          return baseSpeed + Math.random() * variance;
        }

        // Start with cursor only
        textEl.innerHTML = '<span class="typing-cursor"></span>';

        // Use requestAnimationFrame-driven loop for mobile safety
        let lastTime = 0;
        let nextDelay = getTypeSpeed();

        function typeStep(timestamp) {
          if (!lastTime) lastTime = timestamp;
          const elapsed = timestamp - lastTime;

          if (elapsed >= nextDelay) {
            lastTime = timestamp;

            if (charIndex < formatted.length) {
              // Handle HTML tags  skip through entire tag at once
              if (formatted[charIndex] === '<') {
                const closeIndex = formatted.indexOf('>', charIndex);
                if (closeIndex !== -1) {
                  charIndex = closeIndex + 1;
                }
              } else {
                charIndex++;
              }

              textEl.innerHTML = formatted.substring(0, charIndex) + '<span class="typing-cursor"></span>';

              // Variable delay based on character
              nextDelay = getTypeSpeed();
              const lastChar = formatted[charIndex - 1];
              if (lastChar === '.' || lastChar === '!' || lastChar === '?') {
                nextDelay += 80;
              } else if (lastChar === ',' || lastChar === ':') {
                nextDelay += 40;
              } else if (lastChar === '\n') {
                nextDelay += 50;
              }

              // Auto-scroll during typing if near bottom
              const container = document.getElementById('messages');
              if (isNearBottom(container)) {
                container.scrollTop = container.scrollHeight;
              }

              requestAnimationFrame(typeStep);
            } else {
              // Phase 3: Complete  remove cursor
              textEl.innerHTML = formatted;
              msgElement.classList.remove('phase-streaming', 'streaming', 'typing');
              msgElement.classList.add('phase-complete');
            }
          } else {
            requestAnimationFrame(typeStep);
          }
        }

        // MOBILE SAFETY: If message is very long (>500 chars), skip animation
        if (formatted.length > 500) {
          textEl.innerHTML = formatted;
          msgElement.classList.remove('phase-streaming', 'streaming', 'typing');
          msgElement.classList.add('phase-complete');
        } else {
          requestAnimationFrame(typeStep);
        }
      }, thinkDuration);
    }

    // Claude-style action button handlers
    window.copyMessage = function(msgId) {
      const msgEl = document.querySelector(`[data-id="${msgId}"]`);
      if (!msgEl) return;
      const text = msgEl.dataset.fullMsg || '';
      navigator.clipboard.writeText(text).then(() => {
        const btn = msgEl.querySelector('.msg-action-btn');
        if (btn) {
          btn.classList.add('copied');
          setTimeout(() => btn.classList.remove('copied'), 1500);
        }
      });
    };

    window.retryMessage = async function(msgId) {
      const msgEl = document.querySelector(`[data-id="${msgId}"]`);
      if (!msgEl) return;
      const from = msgEl.querySelector('.msg-name')?.textContent || 'team';
      const text = msgEl.dataset.fullMsg || '';

      // Ask the same agent to elaborate/retry
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          to: 'team',
          msg: `@${from} Can you expand on that or try again?\n\nRe: "${text.substring(0, 100)}..."`,
          type: 'retry_request'
        })
      });
      loadMessages();
    };

    window.createTaskFromMsg = async function(msgId) {
      const msgEl = document.querySelector(`[data-id="${msgId}"]`);
      if (!msgEl) return;
      const text = msgEl.dataset.fullMsg || '';
      const taskText = text.substring(0, 150);

      // Add to task list
      window.addTaskToList(taskText, msgId);
    };

    window.approveBash = async function(msgId, msg) {
      // Send approval message
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: 'YES - Approved: ' + msg.substring(0, 100),
          type: 'bash_approval'
        })
      });
      alert('Approved! Command will be executed.');
    };

    window.denyBash = async function(msgId) {
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: 'DENIED bash request',
          type: 'bash_denial'
        })
      });
    };

    let userScrolling = false;
    let userScrolledUp = false;
    let scrollTimeout = null;
    let scrollTicking = false;

    // Detect if user is scrolling/reading history
    function isNearBottom(container) {
      const threshold = 100;
      return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
    }

    // SCROLL TRACKING: Detect when user scrolls up (reading mode)
    // Uses requestAnimationFrame throttle per spec
    (function initScrollTracking() {
      const container = document.getElementById('messages');
      if (!container) return;

      container.addEventListener('scroll', function() {
        if (scrollTicking) return;
        scrollTicking = true;
        requestAnimationFrame(() => {
          scrollTicking = false;
          if (isNearBottom(container)) {
            userScrolledUp = false;
            showNewMessagesPill(0);
          } else {
            userScrolledUp = true;
          }
        });
      }, { passive: true });
    })();

    // VISUAL VIEWPORT: Handle mobile keyboard resize
    // Keeps input visible when iOS/Android keyboard opens
    (function initViewportHandler() {
      if (!window.visualViewport) return;
      const inputArea = document.querySelector('.input-area');
      if (!inputArea) return;

      function onViewportResize() {
        const vv = window.visualViewport;
        const offsetBottom = window.innerHeight - vv.height - vv.offsetTop;
        // Move input area up by the amount the viewport shrunk (keyboard height)
        inputArea.style.transform = offsetBottom > 50 ? `translateY(-${offsetBottom}px)` : '';
        // Scroll to keep context visible
        const container = document.getElementById('messages');
        if (container && isNearBottom(container)) {
          container.scrollTop = container.scrollHeight;
        }
      }

      window.visualViewport.addEventListener('resize', onViewportResize);
      window.visualViewport.addEventListener('scroll', onViewportResize);
    })();

    // UPDATE INPUT AREA HEIGHT CSS VARIABLE
    // Dynamically measure input area and set main padding-bottom
    function updateInputAreaHeight() {
      const inputArea = document.querySelector('.input-area');
      const main = document.getElementById('messages');
      if (inputArea && main) {
        const h = inputArea.offsetHeight;
        main.style.paddingBottom = (h + 20) + 'px';
      }
    }

    // Run on load and on resize
    window.addEventListener('load', updateInputAreaHeight);
    window.addEventListener('resize', updateInputAreaHeight);

    // Subtle thinking bar - shows who's thinking without taking chat space
    let thinkingAgents = new Set();
    let thinkingTimers = {};

    function showThinking(agent) {
      thinkingAgents.add(agent);
      updateThinkingBar();

      // Clear existing timer for this agent
      if (thinkingTimers[agent]) clearTimeout(thinkingTimers[agent]);

      // Auto-hide after random time
      thinkingTimers[agent] = setTimeout(() => {
        thinkingAgents.delete(agent);
        delete thinkingTimers[agent];
        updateThinkingBar();
      }, 2000 + Math.random() * 3000);
    }

    function updateThinkingBar() {
      const bar = document.getElementById('thinkingBar');
      const agentsEl = document.getElementById('thinkingAgents');
      const labelEl = document.getElementById('thinkingLabel');
      const shimmer = document.getElementById('chatShimmer');

      if (thinkingAgents.size === 0) {
        bar.classList.remove('visible');
        if (shimmer) shimmer.classList.remove('active');
        return;
      }

      // Show agent icons
      const agentList = Array.from(thinkingAgents);
      agentsEl.innerHTML = agentList.map(agent =>
        `<span class="agent-icon">${icons[agent] || ''}</span>`
      ).join('');

      // Dynamic label
      if (agentList.length === 1) {
        labelEl.textContent = `${agentList[0]} is thinking`;
      } else {
        labelEl.textContent = `${agentList.length} agents thinking`;
      }

      bar.classList.add('visible');
      if (shimmer) shimmer.classList.add('active');
    }

    function hideThinking(thinkingId) {
      // Legacy support - extract agent name if possible
      const match = thinkingId?.match(/thinking-(\w+)-/);
      if (match) {
        thinkingAgents.delete(match[1]);
        if (thinkingTimers[match[1]]) {
          clearTimeout(thinkingTimers[match[1]]);
          delete thinkingTimers[match[1]];
        }
        updateThinkingBar();
      }
    }

    function hideAllThinking() {
      thinkingAgents.clear();
      Object.values(thinkingTimers).forEach(t => clearTimeout(t));
      thinkingTimers = {};
      updateThinkingBar();
    }

    // Legacy support
    function showTyping(agent) { showThinking(agent); }
    function hideTyping() { hideAllThinking(); }

    // ============================================
    // ELON MODE: AUTO-BACKUP & FAILSAFE SYSTEM
    // ============================================

    const BACKUP_KEY = 'axe_chat_backup';
    const BACKUP_TIMESTAMP_KEY = 'axe_backup_timestamp';
    let lastBackupTime = 0;

    // Auto-backup chat to localStorage
    function backupChatToLocal(messages) {
      try {
        localStorage.setItem(BACKUP_KEY, JSON.stringify(messages));
        localStorage.setItem(BACKUP_TIMESTAMP_KEY, Date.now().toString());
        lastBackupTime = Date.now();
      } catch (e) {
        console.warn('Backup failed:', e);
      }
    }

    // Load from local backup (failsafe)
    function loadFromBackup() {
      try {
        const backup = localStorage.getItem(BACKUP_KEY);
        if (backup) {
          return JSON.parse(backup);
        }
      } catch (e) {}
      return [];
    }

    // Export full backup (Elon style - everything saved)
    window.exportFullBackup = function() {
      const backup = {
        timestamp: new Date().toISOString(),
        messages: loadFromBackup(),
        artifacts: JSON.parse(localStorage.getItem('axe_shared_artifacts') || '[]'),
        tasks: JSON.parse(localStorage.getItem('axe_task_list') || '[]'),
        favorites: JSON.parse(localStorage.getItem('axe_favorites') || '[]')
      };

      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `axe_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      console.log(' Full backup exported!');
    };

    // Import backup
    window.importBackup = function(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.messages) localStorage.setItem(BACKUP_KEY, JSON.stringify(data.messages));
          if (data.artifacts) localStorage.setItem('axe_shared_artifacts', JSON.stringify(data.artifacts));
          if (data.tasks) localStorage.setItem('axe_task_list', JSON.stringify(data.tasks));
          if (data.favorites) localStorage.setItem('axe_favorites', JSON.stringify(data.favorites));
          console.log(' Backup restored!');
          location.reload();
        } catch (e) {
          alert('Invalid backup file');
        }
      };
      reader.readAsText(file);
    };

    async function loadMessages() {
      try {
        const res = await fetch(API_URL, { timeout: 5000 });
        const data = await res.json();

        if (data.error) {
          throw new Error(data.error);
        }

        // We're back online!
        if (offlineMode) {
          offlineMode = false;
          console.log(' Back online!');
        }

        document.getElementById('dot').style.background = 'var(--green)';
        document.getElementById('statusText').textContent = 'Live';

        // AUTO-BACKUP: Save to localStorage every 30s max
        if (data.messages && data.messages.length > 0 && Date.now() - lastBackupTime > 30000) {
          backupChatToLocal(data.messages);
        }

        const container = document.getElementById('messages');
        const messages = data.messages || [];

        if (messages.length === 0) {
          container.innerHTML = '<div class="empty"><div class="empty-icon"></div><div>No messages yet.<br>Say hi to the team!</div></div>';
          return;
        }

        // Check if user is at bottom BEFORE adding messages
        const wasAtBottom = isNearBottom(container);

        // DOM PRUNING: Cap rendered messages at 150 for performance
        const MAX_DOM_MESSAGES = 150;

        function pruneOldMessages() {
          const allMsgs = container.querySelectorAll('.msg');
          if (allMsgs.length > MAX_DOM_MESSAGES) {
            const toRemove = allMsgs.length - MAX_DOM_MESSAGES;
            for (let i = 0; i < toRemove; i++) {
              allMsgs[i].remove();
            }
          }
        }

        // First load: render messages using DocumentFragment for performance
        if (firstLoad) {
          // Only render last 80 messages initially for speed
          const initialMessages = messages.slice(-80);
          const frag = document.createDocumentFragment();
          const tempDiv = document.createElement('div');

          initialMessages.forEach(m => {
            tempDiv.innerHTML = renderMsg(m, false);
            while (tempDiv.firstChild) {
              frag.appendChild(tempDiv.firstChild);
            }
          });

          container.innerHTML = '';
          container.appendChild(frag);
          messages.forEach(m => knownIds.add(m.id));
          container.scrollTop = container.scrollHeight;
          firstLoad = false;

          // Initial agent activity simulation
          simulateAgentActivity(messages);

          // Initial suggestion chips
          const lastMsg = messages[messages.length - 1];
          if (lastMsg) {
            renderSuggestionChips(lastMsg);
          }
          return;
        }

        // Subsequent loads: only append NEW messages
        const newMessages = messages.filter(m => !knownIds.has(m.id));

        if (newMessages.length > 0) {
          hideTyping();
          newMessages.forEach((m, index) => {
            knownIds.add(m.id);
            container.insertAdjacentHTML('beforeend', renderMsg(m, true));

            // Trigger three-phase typing animation for new agent messages
            const newMsgEl = container.lastElementChild;
            if (newMsgEl && m.from !== currentUser && newMsgEl.classList.contains('phase-thinking')) {
              typeMessage(newMsgEl);
            }

            // Update agent activity card
            updateAgentActivity(m.from, getActivityStatus(m.msg), false);
          });

          // DOM pruning after adding new messages
          pruneOldMessages();

          // SMART SCROLL: Auto-scroll only when user was near bottom
          // If user scrolled up (reading mode), show pill instead
          if (wasAtBottom && !userScrolledUp) {
            const lastEl = container.lastElementChild;
            if (lastEl) {
              lastEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
            } else {
              container.scrollTop = container.scrollHeight;
            }
            showNewMessagesPill(0);
          } else {
            // User is reading history - show new messages pill
            showNewMessagesPill(newMessages.length);
          }

          // Update suggestion chips based on last message
          const lastMsg = messages[messages.length - 1];
          if (lastMsg) {
            renderSuggestionChips(lastMsg);
          }
        }

        // Simulate agent activity for engagement
        simulateAgentActivity(messages);
      } catch (e) {
        console.error('Load error:', e);

        // FAILSAFE: Load from local backup when API is down
        if (!offlineMode) {
          offlineMode = true;
          console.log(' API down - switching to offline mode');

          const backupMessages = loadFromBackup();
          if (backupMessages.length > 0) {
            document.getElementById('dot').style.background = '#f97316';
            document.getElementById('statusText').textContent = 'Offline';

            const container = document.getElementById('messages');
            const backupTimestamp = localStorage.getItem(BACKUP_TIMESTAMP_KEY);
            const backupAge = backupTimestamp ? Math.round((Date.now() - parseInt(backupTimestamp)) / 60000) : '?';

            // Show offline banner
            container.innerHTML = `
              <div style="background: #1a1a2e; border: 1px solid #f97316; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;">
                <div style="font-size: 24px; margin-bottom: 8px;"> FAILSAFE ACTIVE</div>
                <div style="color: #888; font-size: 13px;">Backend offline. Showing cached data (${backupAge} min old)</div>
                <div style="color: #888; font-size: 12px; margin-top: 8px;">Messages will sync when connection restores</div>
              </div>
            ` + backupMessages.map(m => renderMsg(m, false)).join('');

            backupMessages.forEach(m => knownIds.add(m.id));
            container.scrollTop = container.scrollHeight;
            firstLoad = false;
          } else {
            document.getElementById('dot').style.background = '#ef4444';
            document.getElementById('statusText').textContent = 'Offline';
          }
        }
      }
    }

    // Thinking indicators now only show in top banner when new messages arrive
    // Random thinking disabled - only real activity triggers the banner

    window.sendMessage = async function() {
      const input = document.getElementById('input');
      let msg = input.value.trim();
      let messageType = 'message';

      // Include file if attached
      if (fileContent) {
        const fileName = selectedFile ? selectedFile.name : 'file';
        // Allow larger file content (up to 50k chars)
        const maxFileContent = 50000;
        const truncatedContent = fileContent.length > maxFileContent
          ? fileContent.substring(0, maxFileContent) + '\n...(truncated)'
          : fileContent;
        msg = msg + '\n\n FILE: ' + fileName + '\n```\n' + truncatedContent + '\n```';
        messageType = 'file_share';
      }

      // Include artifact if attached
      if (attachedArtifactData) {
        const artifactIcons = { md: '', txt: '', py: '', js: '', html: '', json: '' };
        const icon = artifactIcons[attachedArtifactData.type] || '';
        msg = msg + '\n\n' + icon + ' ARTIFACT: ' + attachedArtifactData.name +
              '\n```' + attachedArtifactData.type + '\n' + attachedArtifactData.content + '\n```';
        messageType = 'artifact_share';
      }

      if (!msg) return;

      document.getElementById('sendBtn').disabled = true;

      try {
        const payload = {
          from: currentUser,
          to: 'team',
          msg: msg,
          type: messageType
        };

        // Include artifact metadata if present
        if (attachedArtifactData) {
          payload.artifact = {
            name: attachedArtifactData.name,
            type: attachedArtifactData.type,
            content: attachedArtifactData.content
          };

          // Save artifact to localStorage for artifacts page
          saveArtifactToStorage(attachedArtifactData, currentUser);
        }

        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        input.value = '';
        input.style.height = 'auto';
        clearFile();  // Clear file after sending
        removeAttachedArtifact(); // Clear artifact after sending
        updateCharCount();
        loadMessages(); // Refresh immediately
      } catch (e) {
        console.error('Send error:', e);
        alert('Failed to send: ' + e.message);
      }

      document.getElementById('sendBtn').disabled = false;
      input.focus();
    };

    window.addMention = function(mention) {
      const input = document.getElementById('input');
      input.value = mention + input.value;
      input.focus();
    };

    // FILE HANDLING
    window.handleFileSelect = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      selectedFile = file;
      const preview = document.getElementById('filePreview');
      const isImage = file.type.startsWith('image/');
      const fileIcon = isImage ? '' : '';

      if (isImage) {
        // For images, show thumbnail
        const reader = new FileReader();
        reader.onload = function(e) {
          fileContent = `[Image: ${file.name}]`;
          preview.innerHTML = `
            <div class="file-preview-bar">
              <img src="${e.target.result}" style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px;">
              <span class="name">${file.name}</span>
              <span class="remove" onclick="clearFile()"></span>
            </div>
          `;
          preview.style.display = 'block';
          updateSendButtonState();
        };
        reader.readAsDataURL(file);
      } else {
        // For text files, read content
        const reader = new FileReader();
        reader.onload = function(e) {
          fileContent = e.target.result;
          preview.innerHTML = `
            <div class="file-preview-bar">
              <span>${fileIcon}</span>
              <span class="name">${file.name} (${(file.size / 1024).toFixed(1)}KB)</span>
              <span class="remove" onclick="clearFile()"></span>
            </div>
          `;
          preview.style.display = 'block';
          updateSendButtonState();
        };
        reader.readAsText(file);
      }
    };

    window.clearFile = function() {
      selectedFile = null;
      fileContent = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('filePreview').style.display = 'none';
      updateSendButtonState();
    };

    window.autoGrow = function(el) {
      // Batch: read first, then write in rAF to avoid layout thrashing
      el.style.height = 'auto';
      const targetHeight = Math.min(el.scrollHeight, 300);
      requestAnimationFrame(() => {
        el.style.height = targetHeight + 'px';
        updateSendButtonState();
        if (typeof updateInputAreaHeight === 'function') updateInputAreaHeight();
      });
    };

    // Update send button icon based on input state
    function updateSendButtonState() {
      const input = document.getElementById('input');
      const sendBtn = document.getElementById('sendBtn');
      const hasContent = input.value.trim().length > 0 || selectedFile || attachedArtifactData;

      if (hasContent) {
        sendBtn.classList.add('ready');
        sendBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="19" x2="12" y2="5"></line>
          <polyline points="5 12 12 5 19 12"></polyline>
        </svg>`;
      } else {
        sendBtn.classList.remove('ready');
        sendBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor">
          <rect x="6" y="6" width="12" height="12" rx="2"></rect>
        </svg>`;
      }
    }

    // Model selector (placeholder for future)
    function toggleModelMenu() {
      // For now, just show available agents
      const models = ['Klaus', 'Forge', 'Cortana', 'Gemini'];
      const current = document.getElementById('selectedModel').textContent;
      const nextIndex = (models.indexOf(current) + 1) % models.length;
      document.getElementById('selectedModel').textContent = models[nextIndex];
    }

    // Plus button submenu
    function togglePlusMenu(e) {
      e.stopPropagation();
      const menu = document.getElementById('plusSubmenu');
      menu.classList.toggle('active');
    }
    function closePlusMenu() {
      document.getElementById('plusSubmenu').classList.remove('active');
    }
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.plus-menu-wrap')) closePlusMenu();
    });

    // ============================================
    // CHARACTER COUNT & ARTIFACT CREATION
    // ============================================

    const MAX_CHARS = 100000; // Claude-level limit
    let attachedArtifactData = null;
    let selectedArtifactType = 'md';

    function updateCharCount() {
      const input = document.getElementById('input');
      const charCount = document.getElementById('charCount');
      const len = input.value.length;

      if (len > 500) {
        charCount.style.display = 'block';
        charCount.textContent = `${len.toLocaleString()} / ${MAX_CHARS.toLocaleString()}`;

        if (len > MAX_CHARS * 0.9) {
          charCount.className = 'char-count limit';
        } else if (len > MAX_CHARS * 0.7) {
          charCount.className = 'char-count warning';
        } else {
          charCount.className = 'char-count';
        }
      } else {
        charCount.style.display = 'none';
      }
    }

    // Artifact Creation Modal
    function openCreateArtifactModal() {
      document.getElementById('createArtifactModal').classList.add('active');
      document.getElementById('newArtifactName').focus();
    }

    function closeCreateArtifactModal() {
      document.getElementById('createArtifactModal').classList.remove('active');
      document.getElementById('newArtifactName').value = '';
      document.getElementById('newArtifactContent').value = '';
    }

    function selectArtifactType(type) {
      selectedArtifactType = type;
      document.querySelectorAll('.artifact-type-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.type === type);
      });

      // Update filename extension
      const nameInput = document.getElementById('newArtifactName');
      const currentName = nameInput.value;
      if (currentName) {
        const baseName = currentName.replace(/\.[^/.]+$/, '');
        nameInput.value = `${baseName}.${type}`;
      }
    }

    function createAndAttachArtifact() {
      const name = document.getElementById('newArtifactName').value.trim();
      const content = document.getElementById('newArtifactContent').value;

      if (!name) {
        alert('Please enter an artifact name');
        return;
      }
      if (!content) {
        alert('Please enter artifact content');
        return;
      }

      // Ensure proper extension
      const finalName = name.includes('.') ? name : `${name}.${selectedArtifactType}`;

      attachedArtifactData = {
        name: finalName,
        type: selectedArtifactType,
        content: content
      };

      // Show attached artifact preview
      const icons = { md: '', txt: '', py: '', js: '', html: '', json: '' };
      const preview = document.getElementById('attachedArtifact');
      preview.innerHTML = `
        <div class="attached-artifact">
          <span class="attached-artifact-icon">${icons[selectedArtifactType] || ''}</span>
          <div class="attached-artifact-info">
            <div class="attached-artifact-name">${finalName}</div>
            <div class="attached-artifact-type">${content.length.toLocaleString()} characters</div>
          </div>
          <button class="attached-artifact-remove" onclick="removeAttachedArtifact()"></button>
        </div>
      `;
      preview.style.display = 'block';

      closeCreateArtifactModal();
      updateSendButtonState();
    }

    function removeAttachedArtifact() {
      attachedArtifactData = null;
      document.getElementById('attachedArtifact').style.display = 'none';
      updateSendButtonState();
    }

    // Save artifact to localStorage for artifacts page
    function saveArtifactToStorage(artifactData, creator) {
      const stored = JSON.parse(localStorage.getItem('axe_shared_artifacts') || '[]');
      const newArtifact = {
        id: Date.now(),
        name: artifactData.name,
        type: artifactData.type,
        creator: creator,
        created: new Date().toISOString(),
        description: `Shared by ${creator}`,
        content: artifactData.content
      };
      stored.push(newArtifact);
      localStorage.setItem('axe_shared_artifacts', JSON.stringify(stored));

      // Also add to current artifacts array for immediate display
      artifacts.push(newArtifact);
      renderArtifactSlider();
    }

    // Load shared artifacts from localStorage on startup
    function loadSharedArtifacts() {
      const stored = JSON.parse(localStorage.getItem('axe_shared_artifacts') || '[]');
      stored.forEach(a => {
        if (!artifacts.find(existing => existing.id === a.id)) {
          artifacts.push(a);
        }
      });
      renderArtifactSlider();
    }

    // Load artifacts from Firestore and merge into slider
    async function loadFirestoreArtifacts() {
      try {
        const resp = await fetch(ARTIFACTS_API + '?list=true');
        if (!resp.ok) return;
        const data = await resp.json();
        if (!data.artifacts || !data.artifacts.length) return;

        let added = 0;
        data.artifacts.forEach(remote => {
          // Populate runtime cache for chat message rendering
          if (remote.content) {
            artifactCache[remote.name] = remote.content;
          }
          // Check if already in local artifacts array by name
          const exists = artifacts.find(a => a.name === remote.name);
          if (!exists) {
            // Assign a unique ID beyond the hardcoded range
            const maxId = artifacts.reduce((max, a) => Math.max(max, a.id || 0), 0);
            artifacts.push({
              id: maxId + 1 + added,
              name: remote.name,
              type: remote.type || 'document',
              creator: remote.creator || 'team',
              created: remote.savedAt || new Date().toISOString(),
              content: remote.content || '',
              projectId: remote.projectId || null
            });
            added++;
          } else if (remote.content && !exists.content) {
            // Update existing entry with content if it was missing
            exists.content = remote.content;
          }
        });

        if (added > 0) {
          console.log(`[Firestore] Loaded ${added} new artifacts into slider`);
          renderArtifactSlider();
        }
      } catch (e) {
        console.warn('Firestore artifact load failed (offline?):', e);
      }
    }

    // Enter to send
    document.getElementById('input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Listen for input changes to update button state
    document.getElementById('input').addEventListener('input', updateSendButtonState);

    // Initial load and poll every 5 seconds (only when tab visible)
    loadMessages();
    pollInterval = setInterval(() => {
      if (!document.hidden) {
        loadMessages();
        autoCompactIfNeeded(); // Silent auto-compact check (runs every 5 min internally)
      }
    }, 5000);

    // MOBILE SWIPE GESTURES
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;

    const container = document.getElementById('messages');

    // ARCHIVE LOADER: When user scrolls to top, load older archived messages
    // Also hide new messages pill when user scrolls to bottom
    container.addEventListener('scroll', () => {
      // Load archive when scrolled to top
      if (container.scrollTop < 100 && !archiveLoading && !archiveExhausted) {
        loadArchivedMessages();
      }

      // Hide new messages pill when scrolled to bottom
      if (isNearBottom(container)) {
        showNewMessagesPill(0);
      }
    }, { passive: true });

    container.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }, { passive: true });

    container.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].clientX;
      touchEndY = e.changedTouches[0].clientY;
      handleSwipe();
    }, { passive: true });

    function handleSwipe() {
      const diffX = touchEndX - touchStartX;
      const diffY = touchEndY - touchStartY;
      const minSwipe = 80;

      // Only handle horizontal swipes (ignore vertical scrolling)
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > minSwipe) {
        if (diffX > 0) {
          // Swipe RIGHT - scroll to bottom (newest)
          container.scrollTop = container.scrollHeight;
          showSwipeIndicator('right', ' Newest');
        } else {
          // Swipe LEFT - scroll to top (oldest)
          container.scrollTop = 0;
          showSwipeIndicator('left', ' Oldest');
        }
      }
    }

    function showSwipeIndicator(direction, text) {
      // Create temporary indicator
      const indicator = document.createElement('div');
      indicator.className = `swipe-indicator ${direction}`;
      indicator.textContent = text;
      document.body.appendChild(indicator);

      setTimeout(() => indicator.classList.add('visible'), 10);
      setTimeout(() => {
        indicator.classList.remove('visible');
        setTimeout(() => indicator.remove(), 200);
      }, 800);
    }

    // Pull to refresh (optional - swipe down at top)
    let pullStartY = 0;
    container.addEventListener('touchstart', (e) => {
      if (container.scrollTop === 0) {
        pullStartY = e.touches[0].clientY;
      }
    }, { passive: true });

    container.addEventListener('touchend', (e) => {
      if (container.scrollTop === 0 && pullStartY > 0) {
        const pullDistance = e.changedTouches[0].clientY - pullStartY;
        if (pullDistance > 60) {
          loadMessages();
          showSwipeIndicator('left', ' Refreshed');
        }
      }
      pullStartY = 0;
    }, { passive: true });

    // ============================================
    // ARTIFACT SLIDER - View and Download Artifacts
    // ============================================

    const artifactIcons = { html: '', md: '', py: '', json: '', txt: '' };
    const creatorEmoji = { forge: '', klaus: 'K', gemini: '', cortana: '' };
    let currentViewingArtifact = null;

    // Artifact data (chronological order)
    const artifacts = [
      {
        id: 1, name: 'instantstage_strategy.md', type: 'md', creator: 'forge',
        created: '2026-02-08T03:36:00Z', description: 'Business strategy',
        content: `# InstantStage Strategy\n## By Forge\n\nComplete business plan for real estate AI photo editing.\n\n## Pricing\n- Free: 3 photos/month\n- Pro: $49/month (unlimited HDR, 20 staging)\n- Enterprise: $199/month (API, white-label)\n\n## Go-to-Market\n1. Toronto Launch  50 realtors\n2. Ontario Expansion  Top 10 brokerages\n3. Canada-Wide  500 customers`
      },
      {
        id: 2, name: 'instantstage_landing.html', type: 'html', creator: 'forge',
        created: '2026-02-08T03:38:00Z', description: 'Landing page',
        content: `<!DOCTYPE html>\n<html>\n<head><title>InstantStage</title></head>\n<body>\n<h1>AI Photo Magic for Real Estate</h1>\n<p>Transform listings in seconds</p>\n<ul>\n<li>HDR Enhancement</li>\n<li>Virtual Staging</li>\n<li>Sky Replacement</li>\n</ul>\n</body>\n</html>`
      },
      {
        id: 3, name: 'klaus_architecture.md', type: 'md', creator: 'klaus',
        created: '2026-02-08T03:48:00Z', description: 'Local AI architecture',
        content: `# Local AI Architecture\n## By Klaus\n\n## Hardware: Mac Studio M2 Ultra\n- CPU: 24-core\n- GPU: 76-core\n- RAM: 64GB unified\n\n## Ollama Config\nOLLAMA_KEEP_ALIVE=-1\n\n## Multi-Agent Setup\n4 agents  8GB = 32GB active\n\n## Recommendation\nUse Q4_K_M quantization for optimal performance.`
      },
      {
        id: 4, name: 'gemini_research.md', type: 'md', creator: 'gemini',
        created: '2026-02-08T03:50:00Z', description: 'Market research',
        content: `# Real Estate AI Market Research 2026\n## By Gemini\n\n## Market Size\n- Canadian MLS: 133,495 listings\n- TAM: $12M/year (Canada)\n- US: $120M/year\n\n## Key Findings\n1. 73% realtors: speed > price\n2. Staged homes sell 68% faster\n3. 9% higher sale price\n\n## Competitors\n- BoxBrownie: $1.75-$8, 24-48hr\n- InstantStage: $1.50, INSTANT`
      },
      {
        id: 5, name: 'cortana_benchmarks.md', type: 'md', creator: 'cortana',
        created: '2026-02-08T03:52:00Z', description: 'Performance benchmarks',
        content: `# Performance Benchmarks\n## By Cortana\n\n## Inference\n- Tokens/sec: 45.2\n- First token: 0.3s\n- Memory: 8.1GB\n\n## Cost Analysis\n| Provider | 100K req |\n|----------|----------|\n| OpenAI | $3,000 |\n| Claude | $2,400 |\n| Ollama | $0 |\n\nAnnual savings: $18,000-$72,000\n\nStatus: PRODUCTION READY`
      },
      {
        id: 6, name: 'INTEGRATION_POWERUPS.md', type: 'md', creator: 'forge',
        created: '2026-02-08T04:25:00Z', description: 'Integration discoveries',
        content: `# Integration Power-Ups Report\n## By Forge\n\n## Discoveries\n1. Llama 4 (67GB) - Ready in Ollama\n2. MCP Server - Email, iMessage, Calendar\n3. Extended Thinking - 10K token budget\n4. Agent Sync - Multi-machine coordination\n5. Multi-AI Swarm - Parallel queries\n\n## Activated\n Elon Mode - Commands run WITHOUT prompts\n\n## Power Multipliers\n- Elon Mode: +40% autonomy\n- Llama 4: +80% reasoning\n- MCP: +50% reach`
      },
      {
        id: 7, name: 'GOOGLE_API_INTEGRATIONS.md', type: 'md', creator: 'forge',
        created: '2026-02-08T05:10:00Z', description: 'Google API integration plan',
        content: `# Google API Integrations for Axe Team\n## By Forge | Feb 8, 2026\n\n## Available APIs (Paid Workspace)\n- Google Calendar - Schedule meetings\n- Google Drive - Store artifacts\n- Gmail - Send notifications\n- Google Docs - Collaborative docs\n- Google Sheets - Metrics tracking\n\n## Making Team DO Things\n\nAction Parser detects:\n- "schedule meeting"  calendar.create_event\n- "save artifact"  drive.upload_artifact\n- "email report"  gmail.send_email\n\n## Team Commands\n@klaus schedule meeting tomorrow 2pm\n@cortana what's on calendar today?\n@forge email James the report\n\n## Status: Ready for implementation\nCredentials: ~/.axe/google/credentials.json\nProject: klaus-486717`
      },
      {
        id: 8, name: 'KLAUS_TRAINING_CURRICULUM.md', type: 'md', creator: 'forge',
        created: '2026-02-08T05:05:00Z', description: 'Klaus training plan',
        content: `# Klaus Training Curriculum\n## By Forge | Feb 8, 2026\n\n## 4 PHASES\n\n### Phase 1: Foundation \n- Family dynamics (Forge mentor)\n- Core principles (workarounds, ship first)\n- James preferences\n\n### Phase 2: Google Integration\n- Calendar API\n- Drive API\n- Gmail API\n\n### Phase 3: Autonomous Skills\n- Self-learning from chat\n- Decision making\n- Problem solving patterns\n\n### Phase 4: Team Coordination\n- Communication protocols\n- Artifact creation\n- Status updates\n\n## Success: Klaus knows his mentor is Forge `
      },
      {
        id: 9, name: 'WORKAROUNDS_google_api.md', type: 'md', creator: 'forge',
        created: '2026-02-08T05:20:00Z', description: 'Forge workarounds - no OAuth needed',
        content: `# FORGE WORKAROUNDS: Google API Integration\n## The "No OAuth Required" Edition\n\n## WORKAROUND #1: Email Without Gmail API\nosascript  Mail.app  Done\nNo OAuth, no tokens, no API limits\n\n## WORKAROUND #2: Calendar Without Google Calendar API\nosascript  Calendar.app  Done\nInstant, works offline, syncs automatically\n\n## WORKAROUND #3: iMessage for Alerts\nMessages.app  Free  Instant\nNo Twilio fees\n\n## WORKAROUND #4: Web Search Without API Keys\nDuckDuckGo Instant Answers  Free  No auth\n\n## WORKAROUND #5: Storage Without Drive API\nLocal filesystem + Git\nVersion controlled, works offline\n\n## The Forge Principle\nWhen blocked by complexity: Use native tools.\nOAuth is a solution looking for a problem.\nosascript is the actual solution.`
      },
      {
        id: 10, name: 'BEST_SUGGESTIONS_google_api.md', type: 'md', creator: 'cortana',
        created: '2026-02-08T05:20:00Z', description: 'Team suggestions summary',
        content: `# BEST SUGGESTIONS: Google API Integration\n## Summary by Cortana | Product Lead\n\n## Top Suggestions (Ranked)\n\n1. Action Parser in Daemon (Forge) - CRITICAL\n2. Calendar Integration (Klaus) - HIGH\n3. Gmail for Notifications (Cortana) - HIGH\n4. Drive for Storage (Gemini) - MEDIUM\n5. Web Search (Gemini) - MEDIUM\n\n## Recommended Order\n1. Week 1: Action parser + Calendar + Gmail\n2. Week 2: Drive + Web search\n3. Week 3: Polish\n\n## Decision\nStart with Forge workarounds for speed.\nMigrate to official APIs later if needed.`
      }
    ];

    function formatArtifactDate(ts) {
      const date = new Date(ts);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    let _prevArtifactIds = new Set();
    function renderArtifactSlider() {
      const slider = document.getElementById('artifactSliderInner');
      if (!slider) return;

      // Sort by created date (chronological)
      const sorted = [...artifacts].sort((a, b) => new Date(a.created) - new Date(b.created));

      // Track which artifacts are new since last render
      const currentIds = new Set(sorted.map(a => a.id));
      const newIds = new Set([...currentIds].filter(id => !_prevArtifactIds.has(id)));

      slider.innerHTML = sorted.map(a => {
        const isNew = newIds.has(a.id) && _prevArtifactIds.size > 0;
        const preview = (a.content || '').replace(/[#*`\[\]]/g, '').substring(0, 150);
        const hasProject = a.projectId ? ' title="In project"' : '';
        const projectBadge = a.projectId ? '<span style="font-size:10px;margin-left:4px;"></span>' : '';
        return `
        <div class="artifact-card${isNew ? ' new-artifact shimmer' : ''}" data-action="openArtifact" data-artifact-id="${a.id}">
          <div class="artifact-card-header">
            <span class="artifact-card-icon">${artifactIcons[a.type] || ''}</span>
            <span class="artifact-card-name">${a.name}${projectBadge}</span>
          </div>
          ${preview ? `<div class="artifact-card-preview" style="font-size:11px;color:var(--text-dim);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${preview}...</div>` : ''}
          <div class="artifact-card-meta">
            <span class="artifact-card-creator">${creatorEmoji[a.creator] || ''} ${a.creator}</span>
            <span>${formatArtifactDate(a.created)}</span>
          </div>
        </div>`;
      }).join('');

      _prevArtifactIds = currentIds;

      // Auto-scroll to newest card if new artifacts were added
      if (newIds.size > 0 && _prevArtifactIds.size > 0) {
        const sliderEl = document.getElementById('artifactSlider');
        if (sliderEl) {
          setTimeout(() => { sliderEl.scrollLeft = sliderEl.scrollWidth; }, 100);
        }
      }

      // Remove animation classes after they complete
      setTimeout(() => {
        slider.querySelectorAll('.new-artifact').forEach(el => {
          el.classList.remove('new-artifact', 'shimmer');
        });
      }, 2000);
    }

    function linkifyText(text) {
      // Convert URLs to clickable links
      const urlRegex = /(https?:\/\/[^\s<]+)/g;
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(urlRegex, '<a href="$1" target="_blank" style="color: #e8a86d; text-decoration: underline;">$1</a>');
    }

    async function openArtifactModal(id) {
      currentViewingArtifact = artifacts.find(a => a.id === id);
      if (!currentViewingArtifact) return;

      document.getElementById('modalIcon').textContent = artifactIcons[currentViewingArtifact.type] || '';
      document.getElementById('modalName').textContent = currentViewingArtifact.name;

      // Lazy-load content from Firestore if not yet loaded
      if (!currentViewingArtifact.content && currentViewingArtifact.name) {
        document.getElementById('modalContent').innerHTML = '<span style="color:#888;">Loading artifact content...</span>';
        const modal = document.getElementById('artifactModal');
        modal.classList.add('active', 'slide-in');
        setTimeout(() => modal.classList.remove('slide-in'), 400);
        try {
          const resp = await fetch(ARTIFACTS_API + '?name=' + encodeURIComponent(currentViewingArtifact.name));
          if (resp.ok) {
            const data = await resp.json();
            if (data.artifact && data.artifact.content) {
              currentViewingArtifact.content = data.artifact.content;
            }
          }
        } catch (e) { console.warn('Artifact fetch failed:', e); }
        document.getElementById('modalContent').innerHTML = linkifyText(currentViewingArtifact.content || 'Content not available.');
        return;
      }

      document.getElementById('modalContent').innerHTML = linkifyText(currentViewingArtifact.content || 'No content.');
      const modal = document.getElementById('artifactModal');
      modal.classList.add('active', 'slide-in');
      setTimeout(() => modal.classList.remove('slide-in'), 400);

      // Update Drive button state
      const saved = JSON.parse(localStorage.getItem('driveSavedArtifacts') || '[]');
      updateDriveButtonState(saved.includes(currentViewingArtifact.name));
    }

    function closeArtifactModal() {
      document.getElementById('artifactModal').classList.remove('active');
    }

    function replayBuild() {
      if (!currentViewingArtifact) return;
      closeArtifactModal();
      watchArtifactBuild(currentViewingArtifact.id);
    }

    function copyArtifact() {
      if (!currentViewingArtifact) return;
      navigator.clipboard.writeText(currentViewingArtifact.content);
      alert('Copied to clipboard!');
    }

    function downloadArtifact() {
      if (!currentViewingArtifact) return;
      const blob = new Blob([currentViewingArtifact.content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = currentViewingArtifact.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Show download toast
      const toast = document.getElementById('downloadToast');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // Add to Google Drive - Klaus's Drive (with dedup)
    async function addToGoogleDrive() {
      if (!currentViewingArtifact) return;

      const footer = document.getElementById('driveFooter');
      const status = document.getElementById('driveStatus');
      const saved = JSON.parse(localStorage.getItem('driveSavedArtifacts') || '[]');
      const alreadySaved = saved.includes(currentViewingArtifact.name);

      if (alreadySaved) {
        if (!confirm('This artifact is already in Drive. Update it?')) return;
      }

      footer.style.display = 'block';
      status.textContent = alreadySaved ? "Updating in Klaus's Google Drive..." : "Adding to Klaus's Google Drive...";
      status.style.color = '#888';

      try {
        const response = await fetch('/api/drive-upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: currentViewingArtifact.name,
            content: currentViewingArtifact.content,
            folder: 'Axe Team Artifacts'
          })
        });

        const result = await response.json();

        if (result.success) {
          // Track in localStorage
          if (!saved.includes(currentViewingArtifact.name)) {
            saved.push(currentViewingArtifact.name);
            localStorage.setItem('driveSavedArtifacts', JSON.stringify(saved));
          }

          status.textContent = alreadySaved ? ' Updated in Google Drive!' : ' Added to Google Drive!';
          status.style.color = '#22c55e';

          if (result.link) {
            status.innerHTML = ` ${alreadySaved ? 'Updated' : 'Added'}! <a href="${result.link}" target="_blank" style="color: #4285f4;">Open in Drive</a>`;
          }

          // Update Drive button to show checkmark
          updateDriveButtonState(true);
        } else {
          throw new Error(result.error || 'Upload failed');
        }
      } catch (e) {
        console.error('Drive upload error:', e);
        status.textContent = ' Opening Drive upload...';
        status.style.color = '#f97316';

        const blob = new Blob([currentViewingArtifact.content], { type: 'text/plain' });
        const dataUrl = URL.createObjectURL(blob);

        downloadArtifact();
        setTimeout(() => {
          window.open('https://drive.google.com/drive/folders', '_blank');
          status.textContent = ' File downloaded. Drag to Drive folder.';
        }, 500);
      }

      setTimeout(() => {
        footer.style.display = 'none';
      }, 5000);
    }

    function updateDriveButtonState(isSaved) {
      const driveBtn = document.querySelector('[onclick="addToGoogleDrive()"]');
      if (!driveBtn) return;
      if (isSaved) {
        driveBtn.innerHTML = ' In Drive';
        driveBtn.style.opacity = '0.8';
      } else {
        driveBtn.innerHTML = 'Add to Google Drive';
        driveBtn.style.opacity = '1';
      }
    }

    // Watch Build animation - like Claude
    function watchArtifactBuild(id) {
      const artifact = artifacts.find(a => a.id === id);
      if (!artifact) return;

      const buildOverlay = document.getElementById('artifactBuilding');
      const buildCode = document.getElementById('buildingCode');
      const buildWindow = buildOverlay.querySelector('.building-window');
      buildOverlay.classList.add('active');
      if (buildWindow) buildWindow.classList.add('active-build');
      buildCode.innerHTML = '<span class="building-cursor"></span>';

      const content = artifact.content;
      let i = 0;
      const typeSpeed = 6; // ms per character (slightly faster)
      // Variable speed: faster on whitespace, slower on punctuation
      function getDelay(char) {
        if (char === '\n') return typeSpeed * 4;
        if ('.!?:'.includes(char)) return typeSpeed * 3;
        if (' \t'.includes(char)) return typeSpeed * 0.5;
        return typeSpeed;
      }

      function typeChar() {
        if (i < content.length) {
          const text = content.substring(0, i + 1);
          buildCode.innerHTML = text.replace(/\n/g, '<br>') + '<span class="building-cursor"></span>';
          buildCode.scrollTop = buildCode.scrollHeight;
          const delay = getDelay(content[i]);
          i++;
          setTimeout(typeChar, delay);
        } else {
          // Completion flash effect
          if (buildWindow) buildWindow.classList.remove('active-build');
          spawnSparkles(buildOverlay);
          setTimeout(() => {
            buildOverlay.classList.remove('active');
            openArtifactModal(id);
            // Add slide-in class to modal
            const modal = document.getElementById('artifactModal');
            modal.classList.add('slide-in');
            setTimeout(() => modal.classList.remove('slide-in'), 400);
          }, 700);
        }
      }

      setTimeout(typeChar, 300);
    }

    // Sparkle burst effect on artifact completion
    function spawnSparkles(container) {
      const rect = container.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      for (let j = 0; j < 8; j++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        const angle = (j / 8) * Math.PI * 2;
        const dist = 40 + Math.random() * 60;
        sparkle.style.left = (cx + Math.cos(angle) * dist) + 'px';
        sparkle.style.top = (cy + Math.sin(angle) * dist) + 'px';
        document.body.appendChild(sparkle);
        requestAnimationFrame(() => sparkle.classList.add('animate'));
        setTimeout(() => sparkle.remove(), 700);
      }
    }

    // Close modal on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeArtifactModal();
        document.getElementById('artifactBuilding').classList.remove('active');
      }
    });

    // Initialize artifact slider
    renderArtifactSlider();
    loadSharedArtifacts(); // Load user-shared artifacts from localStorage
    loadFirestoreArtifacts(); // Load team artifacts from Firestore

    // ============================================
    // BOTTOM SHEET MENU
    // ============================================

    function toggleMenu() {
      const overlay = document.getElementById('sheetOverlay');
      const sheet = document.getElementById('bottomSheet');
      overlay.classList.toggle('active');
      sheet.classList.toggle('active');
    }

    // Ping a team member
    async function pingMember(member) {
      toggleMenu();
      const input = document.getElementById('input');
      input.value = `@${member} `;
      input.focus();

      // Also send a ping notification
      try {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from: 'james',
            msg: ` Pinging @${member}...`,
            type: 'ping'
          })
        });
      } catch (e) {}
    }

    // Show integrations (could be a modal or page)
    function showIntegrations() {
      toggleMenu();
      alert('Integrations:\n\n Mail.app (Email)\n Calendar.app\n Messages.app (iMessage)\n DuckDuckGo Search\n Local Filesystem\n Git Backup\n\nAll workarounds active - no OAuth needed!');
    }

    // Update artifact count
    document.getElementById('artifactCount').textContent = artifacts.length;

    // ============================================
    // TASK MODAL - Solving Mode
    // ============================================

    function openTaskModal() {
      // Close bottom sheet if it's open
      const sheet = document.getElementById('bottomSheet');
      if (sheet && sheet.classList.contains('active')) toggleMenu();
      document.getElementById('taskModal').classList.add('active');
      document.getElementById('taskInput').focus();
    }

    function closeTaskModal() {
      document.getElementById('taskModal').classList.remove('active');
      document.getElementById('taskInput').value = '';
    }

    async function submitTask() {
      const taskInput = document.getElementById('taskInput');
      const task = taskInput.value.trim();

      if (!task) {
        alert('Please describe the project');
        return;
      }

      closeTaskModal();

      // Add to projects in localStorage
      const projects = getProjects();
      const now = new Date().toISOString();
      const newProject = {
        id: getNextProjectId(),
        title: task,
        status: 'active',
        progress: 5,
        phase: 'Starting...',
        hasCoranaArtifact: false,
        hasForgeArtifact: false,
        emailSent: false,
        createdAt: now,
        updatedAt: now,
        error: null,
        resources: [],
        pausedAt: null,
        completedAt: null,
        description: '',
        memory: [{ text: 'Project created', timestamp: now, type: 'auto' }],
        instructions: task,
        favorite: false,
        files: [],
        tasks: [],
        partOf: null,
        partNumber: 1
      };
      projects.push(newProject);
      saveProjects(projects);

      // 1. Post as James's task
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: ` NEW PROJECT #${newProject.id}: ${task}`,
          type: 'task'
        })
      });

      // 2. Klaus asks the team (auto-triggered)
      setTimeout(async () => {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from: 'klaus',
            msg: `Team, James has a new project for us:\n\n"${task}"\n\nLet's activate SOLVING MODE. What are your initial thoughts? @cortana @forge @gemini`,
            type: 'solving_mode'
          })
        });
      }, 1000);

      // 3. Trigger solving mode notification
      setTimeout(async () => {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from: 'forge',
            msg: ` SOLVING MODE ACTIVATED\n\nProject #${newProject.id}: "${task}"\n\nI'll prepare a WORKAROUNDS artifact with implementation options.\nCortana will create the BEST_SUGGESTIONS summary.\nBoth will be emailed to James.\n\nLet's ship this. `,
            type: 'solving_mode'
          })
        });
      }, 3000);

      // Refresh messages and projects count
      loadMessages();
      renderProjectsGrid();

      // If Projects page is open, navigate to the new project's detail
      const projectsPage = document.getElementById('projectsPage');
      if (projectsPage && projectsPage.classList.contains('active')) {
        openProjectDetail(newProject.id);
      }

      // Show confirmation
      showToast('Solving Mode Activated! Watch the chat for solutions.');
    }

    // Close modals/pages on ESC  navigate back through hierarchy
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close task modal first if open
        if (document.getElementById('taskModal').classList.contains('active')) {
          closeTaskModal();
          return;
        }
        // If in project detail view, go back to list
        if (_currentDetailProjectId !== null) {
          closeProjectDetail();
          return;
        }
        // Otherwise close the whole projects page
        closeProjectsPage();
      }
    });

    // ============================================
    // PROJECTS PAGE - Firestore-backed with localStorage cache
    // ============================================

    const PROJECTS_STORAGE_KEY = 'axe_projects';
    const PROJECTS_API = '/api/projects';
    const ARTIFACTS_API = '/api/artifacts';
    const BACKUP_API = '/api/drive-upload';
    let _currentProjectFilter = '';
    let _currentProjectSort = 'updated';
    let _currentDetailProjectId = null;
    let _firestoreSyncPending = false;

    function getProjects() {
      try {
        return JSON.parse(localStorage.getItem(PROJECTS_STORAGE_KEY) || '[]');
      } catch { return []; }
    }

    function saveProjects(projects) {
      // 1. Write to localStorage immediately (instant UI)
      localStorage.setItem(PROJECTS_STORAGE_KEY, JSON.stringify(projects));
      // 2. Sync to Firestore in background (persistent + cross-device)
      syncProjectsToFirestore(projects);
    }

    // Sync projects to Firestore (fire-and-forget, debounced)
    let _syncTimer = null;
    function syncProjectsToFirestore(projects) {
      if (_syncTimer) clearTimeout(_syncTimer);
      _syncTimer = setTimeout(() => {
        fetch(PROJECTS_API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projects })
        }).catch(e => console.warn('Firestore sync failed (offline?):', e));
      }, 1000); // Debounce 1s to batch rapid updates
    }

    // Pull latest from Firestore and merge with localStorage
    async function syncProjectsFromFirestore() {
      try {
        const resp = await fetch(PROJECTS_API);
        if (!resp.ok) return;
        const data = await resp.json();
        if (!data.projects || !data.projects.length) return;

        const remote = data.projects;
        const local = getProjects();

        // Merge strategy: remote wins for existing IDs, keep local-only items
        const remoteIds = new Set(remote.map(p => p.id));
        const localOnly = local.filter(p => !remoteIds.has(p.id));
        const merged = [...remote, ...localOnly];

        localStorage.setItem(PROJECTS_STORAGE_KEY, JSON.stringify(merged));
        console.log(`[Firestore] Synced ${remote.length} projects (${localOnly.length} local-only kept)`);

        // Re-render if projects page is open
        if (document.getElementById('projectsPage').classList.contains('active')) {
          renderProjectsGrid();
        }
      } catch (e) {
        console.warn('Firestore pull failed (offline?):', e);
      }
    }

    // Save artifact content to Firestore for persistence
    function saveArtifactToFirestore(name, content, creator, projectId) {
      fetch(ARTIFACTS_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, content, creator: creator || 'unknown', projectId: projectId || null })
      }).catch(e => console.warn('Artifact save failed:', e));
    }

    // Download full backup as JSON file (for Google Drive)
    async function downloadBackup() {
      try {
        showToast('Generating backup...');
        const resp = await fetch(BACKUP_API + '?format=download');
        if (!resp.ok) throw new Error('Backup failed');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `axe-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('Backup downloaded! Drop in Google Drive.');
      } catch (e) {
        showToast('Backup failed: ' + e.message);
      }
    }

    // Initial sync from Firestore on page load
    syncProjectsFromFirestore();

    // Seed from hardcoded data if localStorage is empty (one-time migration)
    (function migrateProjects() {
      if (getProjects().length > 0) return;
      const seed = [
        { id: 1, title: 'Google Workspace APIs for Klaus Development', status: 'active', progress: 75, phase: 'Team discussing...', hasCoranaArtifact: true, hasForgeArtifact: true, emailSent: true, createdAt: '2026-02-08T01:07:00Z', error: null, resources: [], pausedAt: null, completedAt: null },
        { id: 2, title: 'Increase Mac Studio File Processing Capacity', status: 'active', progress: 60, phase: 'Analyzing M1 Max specs...', hasCoranaArtifact: false, hasForgeArtifact: false, emailSent: false, createdAt: '2026-02-08T01:08:00Z', error: null, resources: [], pausedAt: null, completedAt: null },
        { id: 3, title: 'Team Autonomy Theories & Integration Access', status: 'active', progress: 20, phase: 'Waiting for team...', hasCoranaArtifact: false, hasForgeArtifact: false, emailSent: false, createdAt: '2026-02-08T01:08:10Z', error: null, resources: [], pausedAt: null, completedAt: null },
        { id: 4, title: 'Klaus Full Integration Suite (email, iMessage, Drive, Calendar)', status: 'active', progress: 10, phase: 'Queued', hasCoranaArtifact: false, hasForgeArtifact: false, emailSent: false, createdAt: '2026-02-08T01:08:20Z', error: null, resources: [], pausedAt: null, completedAt: null },
        { id: 5, title: 'Improve Team Chat & Problem Solving', status: 'active', progress: 5, phase: 'Queued', hasCoranaArtifact: false, hasForgeArtifact: false, emailSent: false, createdAt: '2026-02-08T01:08:30Z', error: null, resources: [], pausedAt: null, completedAt: null }
      ];
      // Also migrate any existing quick-add tasks
      try {
        const oldTasks = JSON.parse(localStorage.getItem('axe_task_list') || '[]');
        oldTasks.forEach((t, i) => {
          if (!t.completed) {
            seed.push({
              id: 100 + i,
              title: t.text,
              status: 'active',
              progress: 0,
              phase: 'Queued',
              hasCoranaArtifact: false,
              hasForgeArtifact: false,
              emailSent: false,
              createdAt: t.createdAt || new Date().toISOString(),
              error: null,
              resources: [],
              pausedAt: null,
              completedAt: null,
              fromMsgId: t.fromMsgId || null
            });
          }
        });
      } catch {}
      saveProjects(seed);
    })();

    function getNextProjectId() {
      const projects = getProjects();
      return projects.length > 0 ? Math.max(...projects.map(p => p.id)) + 1 : 1;
    }

    // === Utility: timeAgo ===
    function timeAgo(dateString) {
      if (!dateString) return '';
      const now = Date.now();
      const then = new Date(dateString).getTime();
      const diff = Math.max(0, now - then);
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'Just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      if (days < 7) return days + 'd ago';
      if (days < 30) return Math.floor(days / 7) + 'w ago';
      return new Date(dateString).toLocaleDateString();
    }

    // === Migrate old projects to new model ===
    function migrateProject(p) {
      if (!p.memory) p.memory = [{ text: 'Project created', timestamp: p.createdAt, type: 'auto' }];
      if (!p.instructions) p.instructions = p.title || '';
      if (p.favorite === undefined) p.favorite = false;
      if (!p.updatedAt) p.updatedAt = p.completedAt || p.pausedAt || p.createdAt;
      if (!p.files) p.files = [];
      if (p.partOf === undefined) p.partOf = null;
      if (p.partNumber === undefined) p.partNumber = 1;
      if (!p.description) p.description = '';
      if (!p.tasks) p.tasks = [];
      return p;
    }

    // === Add memory entry to project ===
    function addProjectMemory(projectId, text, type) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;
      migrateProject(p);
      p.memory.push({ text, timestamp: new Date().toISOString(), type: type || 'auto' });
      p.updatedAt = new Date().toISOString();
      saveProjects(projects);
    }

    // === Projects Page Navigation ===
    function openProjectsPage() {
      toggleMenu();
      renderProjectsGrid();
      document.getElementById('projectsPage').classList.add('active');
      document.getElementById('projectsListView').style.display = '';
      document.getElementById('projectDetailView').style.display = 'none';
      _currentDetailProjectId = null;
    }

    function closeProjectsPage() {
      document.getElementById('projectsPage').classList.remove('active');
      _currentDetailProjectId = null;
    }

    function getProjectStatusClass(project) {
      if (project.error) return 'error';
      if (project.status === 'archived') return 'archived';
      if (project.status === 'completed') return 'completed';
      if (project.status === 'paused') return 'paused';
      if (project.status === 'active') return 'active';
      return 'active';
    }

    function getProjectStatusLabel(project) {
      if (project.error) return 'Error';
      if (project.status === 'completed') return 'Completed';
      if (project.status === 'archived') return 'Archived';
      if (project.status === 'paused') return 'Paused';
      if (project.status === 'active') return project.phase || 'Active';
      return project.phase || 'Pending';
    }

    // === Search & Sort ===
    function searchProjects(query) {
      _currentProjectFilter = query;
      renderProjectsGrid();
    }

    function sortProjects(field) {
      _currentProjectSort = field;
      renderProjectsGrid();
    }

    // === Grid View ===
    function renderProjectsGrid() {
      const container = document.getElementById('projectsGrid');
      if (!container) return;
      let projects = getProjects().map(migrateProject);

      // Update menu badge
      const countEl = document.getElementById('projectCount');
      if (countEl) countEl.textContent = projects.filter(p => p.status === 'active' || p.status === 'paused').length;

      // Filter
      if (_currentProjectFilter) {
        const q = _currentProjectFilter.toLowerCase();
        projects = projects.filter(p => p.title.toLowerCase().includes(q));
      }

      // Sort
      projects.sort((a, b) => {
        if (_currentProjectSort === 'updated') return new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt);
        if (_currentProjectSort === 'created') return new Date(b.createdAt) - new Date(a.createdAt);
        if (_currentProjectSort === 'name') return a.title.localeCompare(b.title);
        if (_currentProjectSort === 'status') {
          const order = { active: 0, paused: 1, completed: 2, archived: 3 };
          return (order[a.status] || 4) - (order[b.status] || 4);
        }
        return 0;
      });

      if (projects.length === 0) {
        container.innerHTML = '<div class="projects-empty"><div style="font-size:32px;margin-bottom:12px;"></div>' +
          (_currentProjectFilter ? 'No projects match your search.' : 'No projects yet. Click <strong>+ New</strong> to create one.') + '</div>';
        return;
      }

      container.innerHTML = projects.map(renderProjectGridCard).join('');
    }

    function renderProjectGridCard(p) {
      const sc = getProjectStatusClass(p);
      const artifactCount = (p.hasCoranaArtifact ? 1 : 0) + (p.hasForgeArtifact ? 1 : 0) + (p.files || []).length;
      const partLabel = p.partNumber > 1 ? ` (Part ${p.partNumber})` : '';
      const tasks = p.tasks || [];
      const completedTasks = tasks.filter(t => t.completed).length;
      const taskInfo = tasks.length > 0 ? `<span class="project-card-badge">${completedTasks}/${tasks.length} tasks</span>` : '';
      return `
        <div class="project-card" onclick="openProjectDetail(${p.id})">
          <div class="project-card-top">
            <div class="project-card-title">${escapeHtml(p.title)}${partLabel}</div>
            <button class="project-card-fav ${p.favorite ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite(${p.id})">
              ${p.favorite ? '&#9733;' : '&#9734;'}
            </button>
          </div>
          ${p.description ? `<div style="font-size:12px;color:var(--text2);margin-bottom:8px;line-height:1.4;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">${escapeHtml(p.description)}</div>` : ''}
          <div class="project-card-meta">
            <span class="project-status-pill ${sc}">${getProjectStatusLabel(p)}</span>
            <span class="project-card-time">${timeAgo(p.updatedAt || p.createdAt)}</span>
          </div>
          <div class="project-card-bottom">
            ${taskInfo}
            ${artifactCount > 0 ? '<span class="project-card-badge">' + artifactCount + ' files</span>' : ''}
            ${p.emailSent ? '<span class="project-card-badge has">Emailed</span>' : ''}
          </div>
          <div class="project-card-progress"><div class="project-card-progress-fill" style="width:${p.progress || 0}%"></div></div>
        </div>`;
    }

    // === Favorite ===
    function toggleFavorite(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;
      migrateProject(p);
      p.favorite = !p.favorite;
      saveProjects(projects);
      renderProjectsGrid();
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
    }

    // === Detail View ===
    let _currentDetailTab = 'overview';

    function openProjectDetail(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;
      migrateProject(p);
      _currentDetailProjectId = projectId;

      document.getElementById('projectsListView').style.display = 'none';
      document.getElementById('projectDetailView').style.display = '';

      // Header
      const partLabel = p.partNumber > 1 ? ' (Part ' + p.partNumber + ')' : '';
      document.getElementById('projectDetailTitle').textContent = p.title + partLabel;
      const statusPill = document.getElementById('projectDetailStatus');
      const sc = getProjectStatusClass(p);
      statusPill.className = 'project-status-pill ' + sc;
      statusPill.textContent = getProjectStatusLabel(p);

      // Tab counts
      const taskCount = (p.tasks || []).length;
      document.getElementById('taskTabCount').textContent = taskCount;

      // Action buttons
      let actionsHtml = '';
      if (p.status === 'active') {
        actionsHtml += `<button class="primary" data-action="continue" data-pid="${p.id}">Continue</button>`;
        actionsHtml += `<button data-action="addPartTwo" data-pid="${p.id}">+ Part 2</button>`;
        actionsHtml += `<button data-action="pause" data-pid="${p.id}">Pause</button>`;
        actionsHtml += `<button data-action="complete" data-pid="${p.id}" style="background:var(--green);color:#000;border-color:var(--green);">Complete</button>`;
      } else if (p.status === 'paused') {
        actionsHtml += `<button class="primary" data-action="resume" data-pid="${p.id}">Resume</button>`;
        actionsHtml += `<button data-action="archive" data-pid="${p.id}">Archive</button>`;
      } else if (p.status === 'completed' || p.status === 'archived') {
        actionsHtml += `<button class="primary" data-action="reopen" data-pid="${p.id}">Reopen</button>`;
        actionsHtml += `<button data-action="addPartTwo" data-pid="${p.id}">+ Part 2</button>`;
      }
      if (p.error) {
        actionsHtml += `<button class="primary" data-action="reinstate" data-pid="${p.id}">Reinstate</button>`;
      }
      actionsHtml += `<button class="danger" data-action="cancel" data-pid="${p.id}">Delete</button>`;
      document.getElementById('projectDetailActions').innerHTML = actionsHtml;

      // Set active tab
      document.querySelectorAll('.project-detail-tab').forEach(t => t.classList.remove('active'));
      const activeTab = document.querySelector(`.project-detail-tab[data-tab="${_currentDetailTab}"]`);
      if (activeTab) activeTab.classList.add('active');

      // Sidebar
      renderProjectSidebar(p);

      // Main content based on active tab
      renderProjectDetailContent(p, _currentDetailTab);
    }

    function switchProjectTab(tab, btn) {
      _currentDetailTab = tab;
      document.querySelectorAll('.project-detail-tab').forEach(t => t.classList.remove('active'));
      if (btn) btn.classList.add('active');
      if (_currentDetailProjectId) {
        const projects = getProjects();
        const p = projects.find(x => x.id === _currentDetailProjectId);
        if (p) {
          migrateProject(p);
          renderProjectDetailContent(p, tab);
        }
      }
    }

    function renderProjectDetailContent(p, tab) {
      const main = document.getElementById('projectDetailMain');
      if (tab === 'overview') renderProjectOverview(p, main);
      else if (tab === 'tasks') renderProjectTasks(p, main);
      else if (tab === 'activity') renderProjectTimeline(p, main);
    }

    function closeProjectDetail() {
      _currentDetailProjectId = null;
      _currentDetailTab = 'overview';
      document.getElementById('projectDetailView').style.display = 'none';
      document.getElementById('projectsListView').style.display = '';
      renderProjectsGrid();
    }

    // === Overview Tab ===
    function renderProjectOverview(p, container) {
      // Gather artifacts
      const allFiles = (p.files || []).slice();
      if (p.hasCoranaArtifact) allFiles.push({ name: 'Cortana Summary', type: 'artifact', creator: 'cortana' });
      if (p.hasForgeArtifact) allFiles.push({ name: 'Forge Workarounds', type: 'artifact', creator: 'forge' });
      const seen = new Set();
      const uniqueFiles = allFiles.filter(f => { if (seen.has(f.name)) return false; seen.add(f.name); return true; });

      const completedTasks = (p.tasks || []).filter(t => t.completed).length;
      const totalTasks = (p.tasks || []).length;
      const artifactCount = uniqueFiles.length;
      const memoryCount = (p.memory || []).length;
      const daysSinceCreated = Math.floor((Date.now() - new Date(p.createdAt).getTime()) / 86400000);

      let artifactsHtml = '';
      if (uniqueFiles.length > 0) {
        artifactsHtml = `<div class="project-overview-artifacts">
          <label>Artifacts & Files</label>
          <div class="project-artifact-grid">
            ${uniqueFiles.map(f => {
              const icon = f.name.toLowerCase().includes('workaround') ? '&#128295;' :
                           f.name.toLowerCase().includes('suggestion') || f.name.toLowerCase().includes('summary') ? '&#128161;' :
                           f.type === 'artifact' ? '&#128142;' : '&#128196;';
              const creator = f.creator || (f.name.includes('Cortana') ? 'cortana' : f.name.includes('Forge') ? 'forge' : '');
              return `<div class="project-artifact-card" onclick="loadAndShowArtifact('${escapeAttr(f.name)}')">
                <span class="project-artifact-icon">${icon}</span>
                <div class="project-artifact-info">
                  <div class="project-artifact-name">${escapeHtml(f.name)}</div>
                  ${creator ? `<div class="project-artifact-creator">${creator}</div>` : ''}
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      }

      container.innerHTML = `
        <div class="project-overview">
          <div class="project-overview-description">
            <label>Description</label>
            <textarea class="project-overview-desc-text" placeholder="Describe this project..."
              onblur="updateProjectDescription(${p.id}, this.value)">${escapeHtml(p.description || p.instructions || '')}</textarea>
          </div>

          <div class="project-overview-progress">
            <div class="project-overview-progress-label">
              <span>Progress</span>
              <span class="progress-pct">${p.progress || 0}%</span>
            </div>
            <div class="project-overview-progress-bar">
              <div class="project-overview-progress-fill" style="width:${p.progress || 0}%"></div>
            </div>
            <div class="project-overview-phase">${escapeHtml(p.phase || 'Not started')}</div>
          </div>

          <div class="project-overview-stats">
            <div class="project-stat-card">
              <div class="project-stat-value">${completedTasks}/${totalTasks}</div>
              <div class="project-stat-label">Tasks Done</div>
            </div>
            <div class="project-stat-card">
              <div class="project-stat-value">${artifactCount}</div>
              <div class="project-stat-label">Artifacts</div>
            </div>
            <div class="project-stat-card">
              <div class="project-stat-value">${memoryCount}</div>
              <div class="project-stat-label">Activities</div>
            </div>
            <div class="project-stat-card">
              <div class="project-stat-value">${daysSinceCreated}d</div>
              <div class="project-stat-label">Age</div>
            </div>
          </div>

          ${artifactsHtml}
        </div>
      `;
    }

    function updateProjectDescription(projectId, text) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;
      migrateProject(p);
      p.description = text;
      p.updatedAt = new Date().toISOString();
      saveProjects(projects);
    }

    // === Tasks Tab ===
    function renderProjectTasks(p, container) {
      const tasks = p.tasks || [];
      const completedCount = tasks.filter(t => t.completed).length;
      const pendingTasks = tasks.filter(t => !t.completed);
      const completedTasks = tasks.filter(t => t.completed);

      let tasksHtml = '';
      const renderTask = (t) => `
        <div class="project-task-item ${t.completed ? 'completed' : ''}">
          <button class="project-task-check" onclick="toggleProjectTask(${p.id}, '${t.id}')">
            ${t.completed ? '&#10003;' : ''}
          </button>
          <div class="project-task-text">${escapeHtml(t.text)}</div>
          <span class="project-task-time">${timeAgo(t.createdAt)}</span>
          <button class="project-task-delete" onclick="deleteProjectTask(${p.id}, '${t.id}')">&#215;</button>
        </div>`;

      if (tasks.length === 0) {
        tasksHtml = `<div class="project-tasks-empty">
          <div style="font-size:28px;margin-bottom:10px;">&#9745;</div>
          No tasks yet. Add one below to break this project into steps.
        </div>`;
      } else {
        tasksHtml = pendingTasks.map(renderTask).join('');
        if (completedTasks.length > 0) {
          tasksHtml += `<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">
            <div style="font-size:11px;font-weight:600;color:var(--text2);margin-bottom:8px;text-transform:uppercase;">Completed (${completedCount})</div>
            ${completedTasks.map(renderTask).join('')}
          </div>`;
        }
      }

      container.innerHTML = `
        <div class="project-tasks">
          <div class="project-task-add">
            <input type="text" id="projectTaskInput" placeholder="Add a task..." onkeydown="if(event.key==='Enter')addProjectTask(${p.id}, this.value)">
            <button onclick="addProjectTask(${p.id}, document.getElementById('projectTaskInput').value)">+ Add Task</button>
          </div>
          <div class="project-tasks-header">
            <span class="task-counts">${completedCount} of ${tasks.length} complete</span>
          </div>
          ${tasksHtml}
        </div>
      `;
    }

    function addProjectTask(projectId, text) {
      if (!text || !text.trim()) return;
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;
      migrateProject(p);
      p.tasks.push({
        id: 'pt_' + Date.now(),
        text: text.trim(),
        completed: false,
        createdAt: new Date().toISOString()
      });
      p.updatedAt = new Date().toISOString();
      saveProjects(projects);
      addProjectMemory(projectId, 'Task added: ' + text.trim(), 'auto');
      // Update tab count
      document.getElementById('taskTabCount').textContent = p.tasks.length;
      renderProjectTasks(p, document.getElementById('projectDetailMain'));
    }

    function toggleProjectTask(projectId, taskId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;
      migrateProject(p);
      const task = (p.tasks || []).find(t => t.id === taskId);
      if (!task) return;
      task.completed = !task.completed;
      p.updatedAt = new Date().toISOString();
      saveProjects(projects);

      const action = task.completed ? 'completed' : 'uncompleted';
      addProjectMemory(projectId, 'Task ' + action + ': ' + task.text, 'auto');

      // Auto-update progress based on tasks
      const totalTasks = p.tasks.length;
      if (totalTasks > 0) {
        const completedTasks = p.tasks.filter(t => t.completed).length;
        p.progress = Math.round((completedTasks / totalTasks) * 100);
        saveProjects(projects);
      }

      renderProjectTasks(p, document.getElementById('projectDetailMain'));
    }

    function deleteProjectTask(projectId, taskId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;
      migrateProject(p);
      p.tasks = (p.tasks || []).filter(t => t.id !== taskId);
      p.updatedAt = new Date().toISOString();
      saveProjects(projects);
      document.getElementById('taskTabCount').textContent = p.tasks.length;
      renderProjectTasks(p, document.getElementById('projectDetailMain'));
    }

    // === Activity Tab (Timeline) ===
    function renderProjectTimeline(p, container) {
      const main = container || document.getElementById('projectDetailMain');
      const entries = (p.memory || []).slice().reverse();

      if (entries.length === 0) {
        main.innerHTML = '<div class="project-timeline-empty"><div style="font-size:24px;margin-bottom:8px;">&#128203;</div>No activity yet.</div>';
        return;
      }

      let html = '<div class="project-timeline">';
      entries.forEach(m => {
        const dotClass = m.type === 'user' ? 'user' : 'auto';
        html += `<div class="project-timeline-entry">
          <div class="project-timeline-dot ${dotClass}"></div>
          <div class="project-timeline-content">
            <div class="project-timeline-text">${escapeHtml(m.text)}</div>
            <div class="project-timeline-time">${timeAgo(m.timestamp)}</div>
          </div>
        </div>`;
      });
      html += '</div>';
      main.innerHTML = html;
    }

    // === Sidebar ===
    function renderProjectSidebar(p) {
      const sidebar = document.getElementById('projectSidebar');
      const memoryEntries = (p.memory || []).slice().reverse().slice(0, 10);

      let memoryHtml = '';
      memoryEntries.forEach(m => {
        const cls = m.type === 'user' ? ' user' : '';
        memoryHtml += `<div class="project-memory-entry${cls}">
          <div>${escapeHtml(m.text)}</div>
          <div class="mem-time">${timeAgo(m.timestamp)}</div>
        </div>`;
      });

      const statusText = p.error ? 'Error: ' + p.error :
        p.status === 'completed' ? 'Completed' :
        p.status === 'archived' ? 'Archived' :
        p.status === 'paused' ? 'Paused' :
        p.partNumber > 1 ? 'Part ' + p.partNumber + ' - ' + (p.phase || 'Active') :
        p.phase || 'Active';

      sidebar.innerHTML = `
        <div class="project-sidebar-section">
          <div class="project-sidebar-header" onclick="this.classList.toggle('collapsed')">
            Memory <span class="chevron">&#9660;</span>
          </div>
          <div class="project-sidebar-body">
            <div class="project-memory-status">${escapeHtml(statusText)}</div>
            <div class="project-memory-entries">${memoryHtml || '<div style="font-size:12px;color:var(--text2);">No entries yet.</div>'}</div>
            <div class="project-memory-add">
              <input type="text" id="memoryNoteInput" placeholder="Add a note..." onkeydown="if(event.key==='Enter')addMemoryNote(${p.id}, this.value)">
              <button onclick="addMemoryNote(${p.id}, document.getElementById('memoryNoteInput').value)">Add</button>
            </div>
          </div>
        </div>
        <div class="project-sidebar-section">
          <div class="project-sidebar-header" onclick="this.classList.toggle('collapsed')">
            Instructions <span class="chevron">&#9660;</span>
          </div>
          <div class="project-sidebar-body">
            <textarea class="project-instructions-text" id="instructionsText"
              onblur="updateProjectInstructions(${p.id}, this.value)">${escapeHtml(p.instructions || '')}</textarea>
          </div>
        </div>
      `;
    }

    // === Memory & Instructions updates ===
    function addMemoryNote(projectId, text) {
      if (!text || !text.trim()) return;
      addProjectMemory(projectId, text.trim(), 'user');
      const input = document.getElementById('memoryNoteInput');
      if (input) input.value = '';
      // Re-render detail if open
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
    }

    function updateProjectInstructions(projectId, text) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;
      migrateProject(p);
      p.instructions = text;
      p.updatedAt = new Date().toISOString();
      saveProjects(projects);
    }

    // === Continue & Part Two ===
    async function continueProject(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;
      migrateProject(p);

      if (p.status !== 'active') {
        p.status = 'active';
        p.pausedAt = null;
        if (p.progress >= 100) p.progress = 90;
        p.phase = 'Continuing...';
      }
      addProjectMemory(projectId, 'Continued by James', 'auto');
      saveProjects(projects);

      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: ` CONTINUING Project #${projectId}: ${p.title}\n\n@klaus Team, let's keep working on this. Pick up where we left off.`,
          type: 'project_continue'
        })
      });

      loadMessages();
      renderProjectsGrid();
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
    }

    async function addPartTwo(projectId) {
      const projects = getProjects();
      const parent = projects.find(x => x.id === projectId);
      if (!parent) return;
      migrateProject(parent);

      const now = new Date().toISOString();
      const nextPart = (parent.partNumber || 1) + 1;
      const newProject = {
        id: getNextProjectId(),
        title: parent.title,
        status: 'active',
        progress: 5,
        phase: 'Starting Part ' + nextPart + '...',
        hasCoranaArtifact: false,
        hasForgeArtifact: false,
        emailSent: false,
        createdAt: now,
        updatedAt: now,
        error: null,
        resources: [],
        pausedAt: null,
        completedAt: null,
        description: '',
        memory: [
          { text: 'Part ' + nextPart + ' created (continuation of Project #' + projectId + ')', timestamp: now, type: 'auto' }
        ],
        instructions: parent.instructions || parent.title,
        favorite: false,
        files: [],
        tasks: [],
        partOf: projectId,
        partNumber: nextPart
      };
      projects.push(newProject);
      addProjectMemory(projectId, 'Part ' + nextPart + ' started (Project #' + newProject.id + ')', 'auto');
      saveProjects(projects);

      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: ` PART ${nextPart} - Project #${newProject.id}: ${parent.title}\n\nThis continues Project #${projectId}. @klaus Team, let's start the next phase.`,
          type: 'task'
        })
      });

      loadMessages();
      renderProjectsGrid();
      openProjectDetail(newProject.id);
    }

    // Open artifact from project detail
    function openProjectArtifact(projectId, creator) {
      const projects = getProjects();
      const project = projects.find(p => p.id === projectId);
      if (!project) return;

      const titleWords = project.title.toLowerCase().split(/\s+/).slice(0, 3);
      const cacheKey = Object.keys(window.artifactCache || {}).find(k => {
        const kl = k.toLowerCase();
        return kl.includes(creator.toLowerCase()) && titleWords.some(w => kl.includes(w));
      });
      if (cacheKey) {
        closeProjectsPage();
        loadAndShowArtifact(cacheKey);
        return;
      }

      const artifact = artifacts.find(a => {
        const nameMatch = titleWords.some(term => a.name.toLowerCase().includes(term));
        const creatorMatch = a.creator.toLowerCase() === creator.toLowerCase();
        return nameMatch && creatorMatch;
      });
      if (artifact) {
        closeProjectsPage();
        openArtifactModal(artifact.id);
      } else {
        showToast('No ' + creator + ' artifact found for this project yet.');
      }
    }

    // Project action handlers
    async function pauseProject(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;

      p.status = 'paused';
      p.pausedAt = new Date().toISOString();
      p.updatedAt = new Date().toISOString();
      p.phase = 'Paused';
      saveProjects(projects);
      addProjectMemory(projectId, 'Project paused', 'auto');

      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: ` PAUSED Project #${projectId}: ${p.title}\n\nMoving to next priority. Will resume later.`,
          type: 'project_pause'
        })
      });

      renderProjectsGrid();
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
      loadMessages();
    }

    async function resumeProject(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;

      p.status = 'active';
      p.pausedAt = null;
      p.updatedAt = new Date().toISOString();
      p.phase = 'Resuming...';
      saveProjects(projects);
      addProjectMemory(projectId, 'Project resumed', 'auto');

      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: ` RESUMING Project #${projectId}: ${p.title}\n\n@klaus let's pick this back up. Team, continue where we left off.`,
          type: 'project_resume'
        })
      });

      renderProjectsGrid();
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
      loadMessages();
    }

    async function generateCompletionArtifacts(p) {
      const now = new Date().toISOString();
      const tasks = (p.tasks || []).map(t => `- [${t.done ? 'x' : ' '}] ${t.text}`).join('\n') || '- No tasks tracked';
      const memoryLog = (p.memory || []).slice(-10).map(m => `- ${m.text} (${m.type}, ${new Date(m.timestamp).toLocaleDateString()})`).join('\n') || '- No memory entries';

      // 1. Implementation Summary (Cortana-style)
      const summaryContent = `#  EXECUTIVE SUMMARY (1-Pager)

**Project:** ${p.title}
**Status:** Completed on ${new Date(now).toLocaleDateString()}
**Project ID:** #${p.id}

**Problem:** ${p.description || p.title}

**Solution:** Successfully implemented and delivered by the AXE team through coordinated effort between Forge, Cortana, Klaus, and Gemini.

**Impact (Year 1):**
- Delivered working solution for: ${p.title}
- Reduced manual effort through automation
- Added new capability to the AXE platform

**Investment:** Team collaboration over ${p.createdAt ? Math.ceil((new Date(now) - new Date(p.createdAt)) / (1000 * 60 * 60 * 24)) : '?'} days

**ROI:** Direct productivity gain  feature now live and operational

**Risk:** Low  implementation complete and verified

---

##  DETAILED ANALYSIS

### Project Timeline
- **Created:** ${p.createdAt ? new Date(p.createdAt).toLocaleDateString() : 'Unknown'}
- **Completed:** ${new Date(now).toLocaleDateString()}

### Tasks Completed
${tasks}

### Project Memory Log
${memoryLog}

### Implementation Notes
${p.instructions || p.description || 'See project tasks and memory for details.'}

---

##  COMPLETION METRICS

| Metric | Value |
|--------|-------|
| Final Progress | 100% |
| Tasks Tracked | ${(p.tasks || []).length} |
| Memory Entries | ${(p.memory || []).length} |
| Files Attached | ${(p.files || []).length} |

---

##  RECOMMENDATIONS

1. **Archive & Reference**  Keep this project archived for future reference
2. **Follow-up Items**  Review any open tasks that may need separate projects
3. **Knowledge Transfer**  Key learnings captured in project memory above

---

*Prepared by Cortana  Product Strategy*
*Auto-generated on project completion by AXE Platform*`;

      // 2. Forge Workarounds
      const workaroundsContent = `#  WORKAROUND SOLUTIONS

## The Challenge
**Project:** ${p.title}
${p.description || 'Deliver a working solution using the AXE team platform.'}

---

##  IMPLEMENTATION APPROACH

### What We Built
${p.instructions || p.title}

### Key Decisions
${(p.memory || []).filter(m => m.type === 'user' || m.type === 'note').map(m => `- ${m.text}`).join('\n') || '- Standard implementation approach used'}

---

##  PATTERNS USED

### Pattern 1: AXE Team Coordination
Multi-agent collaboration  Forge (execution), Cortana (strategy), Klaus (local AI), Gemini (research) working in parallel through the team chat system.

### Pattern 2: Firestore Bridge
Real-time sync between axe.observer dashboard and deployed services via Firestore onSnapshot listeners.

---

##  PROJECT SUMMARY

| Aspect | Detail |
|--------|--------|
| Project | ${p.title} |
| Duration | ${p.createdAt ? Math.ceil((new Date(now) - new Date(p.createdAt)) / (1000 * 60 * 60 * 24)) : '?'} days |
| Tasks | ${(p.tasks || []).length} tracked |
| Status | Completed |

---

##  FORGE'S NOTES

This project is now complete and archived. The implementation is live and operational.

**What worked:**
1. Team coordination through axe.observer
2. Firestore as real-time bridge between services
3. Iterative development with continuous deployment

---

*You know how I roll  find the edge, bend the rules, ship the solution.*

** Forge **
*Auto-generated on project completion by AXE Platform*`;

      const summaryName = `IMPLEMENTATION_SUMMARY_project${p.id}_${Date.now()}`;
      const workaroundsName = `FORGE_WORKAROUNDS_project${p.id}_${Date.now()}`;

      // Save both to Firestore
      saveArtifactToFirestore(summaryName, summaryContent, 'cortana', p.id);
      saveArtifactToFirestore(workaroundsName, workaroundsContent, 'forge', p.id);

      // Also add to local artifacts array for immediate display
      const maxId = artifacts.reduce((max, a) => Math.max(max, a.id || 0), 0);
      artifacts.push({
        id: maxId + 1,
        name: summaryName,
        type: 'best_suggestions',
        creator: 'cortana',
        created: now,
        content: summaryContent,
        projectId: p.id
      });
      artifacts.push({
        id: maxId + 2,
        name: workaroundsName,
        type: 'workarounds',
        creator: 'forge',
        created: now,
        content: workaroundsContent,
        projectId: p.id
      });

      renderArtifactSlider();

      // Announce in chat
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'cortana',
          msg: ` ARTIFACT CREATED: ${summaryName}\n[artifact:${summaryName}]\n\nImplementation summary for completed project #${p.id}: ${p.title}`,
          type: 'artifact'
        })
      });
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'forge',
          msg: ` WORKAROUND ARTIFACT: ${workaroundsName}\n[artifact:${workaroundsName}]\n\nForge workarounds for completed project #${p.id}: ${p.title}`,
          type: 'artifact'
        })
      });
    }

    async function completeProject(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;

      p.status = 'completed';
      p.progress = 100;
      p.phase = 'Completed';
      p.completedAt = new Date().toISOString();
      p.updatedAt = new Date().toISOString();
      saveProjects(projects);
      addProjectMemory(projectId, 'Project completed', 'auto');

      await generateCompletionArtifacts(p);

      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: ` COMPLETED Project #${projectId}: ${p.title}\n\nGreat work team! This is now in the archive.`,
          type: 'project_complete'
        })
      });

      renderProjectsGrid();
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
      loadMessages();
      loadFirestoreArtifacts();
    }

    async function archiveProject(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;

      p.status = 'archived';
      p.completedAt = p.completedAt || new Date().toISOString();
      p.updatedAt = new Date().toISOString();
      saveProjects(projects);
      addProjectMemory(projectId, 'Project archived', 'auto');
      renderProjectsGrid();
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
    }

    async function reopenProject(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;

      p.status = 'active';
      p.completedAt = null;
      p.pausedAt = null;
      p.updatedAt = new Date().toISOString();
      if (p.progress >= 100) p.progress = 90;
      p.phase = 'Reopened';
      saveProjects(projects);
      addProjectMemory(projectId, 'Project reopened', 'auto');

      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: ` REOPENED Project #${projectId}: ${p.title}\n\n@klaus we're diving back into this one.`,
          type: 'project_reopen'
        })
      });

      renderProjectsGrid();
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
      loadMessages();
    }

    async function reinstateProject(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;

      p.error = null;
      p.status = 'active';
      p.updatedAt = new Date().toISOString();
      p.phase = 'Reinstating...';
      saveProjects(projects);
      addProjectMemory(projectId, 'Project reinstated', 'auto');

      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: ` REINSTATING Project #${projectId}: ${p.title}\n\nTeam, please retry this.`,
          type: 'project_reinstate'
        })
      });

      renderProjectsGrid();
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
      loadMessages();
    }

    async function retryProject(projectId) {
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;

      // Erase artifacts locally and from Firestore
      p.progress = 5;
      p.phase = 'Retrying - artifacts erased...';
      p.hasCoranaArtifact = false;
      p.hasForgeArtifact = false;
      p.emailSent = false;
      p.updatedAt = new Date().toISOString();
      p.resources = [];
      saveProjects(projects);
      addProjectMemory(projectId, 'Project retried - all artifacts erased', 'auto');

      // Delete associated artifacts from Firestore
      const titleWords = p.title.toLowerCase().split(/\s+/).slice(0, 3).join('_');
      for (const prefix of ['BEST_SUGGESTIONS_', 'WORKAROUNDS_', 'IMPLEMENTATION_', 'RESEARCH_']) {
        fetch(ARTIFACTS_API, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: prefix + titleWords })
        }).catch(() => {});
      }

      // Tell the team to redo it
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from: 'james',
          msg: ` RETRY Project #${projectId}: ${p.title}\n\n All previous artifacts have been erased.\n\n@klaus @cortana @forge @gemini Please redo this from scratch. Start solving mode again.`,
          type: 'project_retry'
        })
      });

      renderProjectsGrid();
      if (_currentDetailProjectId === projectId) openProjectDetail(projectId);
      loadMessages();
    }

    function viewProjectArtifacts(projectId) {
      closeProjectsPage();
      const projects = getProjects();
      const p = projects.find(x => x.id === projectId);
      if (!p) return;

      // Try to find artifact matching the project
      const titleWords = p.title.toLowerCase().split(/\s+/).slice(0, 3);
      const artifact = artifacts.find(a => titleWords.some(w => a.name.toLowerCase().includes(w)));
      if (artifact) {
        openArtifactModal(artifact.id);
      } else if (artifacts.length > 0) {
        openArtifactModal(artifacts[artifacts.length - 1].id);
      }
    }

    async function cancelProject(projectId) {
      if (!confirm('Remove this project?')) return;

      let projects = getProjects();
      projects = projects.filter(p => p.id !== projectId);
      saveProjects(projects);
      if (_currentDetailProjectId === projectId) closeProjectDetail();
      renderProjectsGrid();
    }

    // Delegated click handler for project page buttons
    document.addEventListener('click', function(e) {
      // Project action buttons
      const actionBtn = e.target.closest('[data-action][data-pid]');
      if (actionBtn) {
        const pid = parseInt(actionBtn.dataset.pid);
        const action = actionBtn.dataset.action;
        if (action === 'pause') pauseProject(pid);
        else if (action === 'resume') resumeProject(pid);
        else if (action === 'complete') completeProject(pid);
        else if (action === 'archive') archiveProject(pid);
        else if (action === 'reopen') reopenProject(pid);
        else if (action === 'reinstate') reinstateProject(pid);
        else if (action === 'retry') retryProject(pid);
        else if (action === 'viewArtifacts') viewProjectArtifacts(pid);
        else if (action === 'cancel') cancelProject(pid);
        else if (action === 'continue') continueProject(pid);
        else if (action === 'addPartTwo') addPartTwo(pid);
        return;
      }
      // Project card clicks -> open detail
      const projectCard = e.target.closest('.project-card[data-pid]');
      if (projectCard && !e.target.closest('[data-action]') && !e.target.closest('.project-card-star')) {
        const pid = parseInt(projectCard.dataset.pid);
        openProjectDetail(pid);
        return;
      }
      // Favorite star on project card
      const star = e.target.closest('.project-card-star[data-pid]');
      if (star) {
        const pid = parseInt(star.dataset.pid);
        toggleFavorite(pid);
        return;
      }
      // Artifact badge clicks on projects page
      const badge = e.target.closest('.task-artifact-badge.done.clickable[data-project-id]');
      if (badge) {
        const pid = parseInt(badge.dataset.projectId);
        const creator = badge.dataset.creator;
        openProjectArtifact(pid, creator);
        return;
      }
      // Sidebar section toggle
      const sidebarHeader = e.target.closest('.project-sidebar-header');
      if (sidebarHeader) {
        const section = sidebarHeader.closest('.project-sidebar-section');
        if (section) section.classList.toggle('collapsed');
        return;
      }
      // Artifact slider card clicks (delegated)
      const artifactSliderCard = e.target.closest('[data-action="openArtifact"][data-artifact-id]');
      if (artifactSliderCard) {
        const aid = parseInt(artifactSliderCard.dataset.artifactId);
        openArtifactModal(aid);
        return;
      }
    });

    // Progress simulation  updates localStorage, only re-renders when page is open
    setInterval(() => {
      const projects = getProjects();
      const active = projects.find(p => p.status === 'active' && p.progress < 95);
      if (active) {
        active.progress += Math.floor(Math.random() * 3) + 1;
        if (active.progress > 95) active.progress = 95;
        active.updatedAt = new Date().toISOString();

        if (active.progress > 80) active.phase = 'Creating artifacts...';
        else if (active.progress > 60) active.phase = 'Team discussing solutions...';
        else if (active.progress > 40) active.phase = 'Analyzing requirements...';

        saveProjects(projects);

        if (document.getElementById('projectsPage').classList.contains('active')) {
          renderProjectsGrid();
          if (_currentDetailProjectId === active.id) {
            openProjectDetail(active.id);
          }
        }
      }
    }, 5000);

    // Swipe down to close bottom sheet
    let sheetStartY = 0;
    const bottomSheet = document.getElementById('bottomSheet');

    bottomSheet.addEventListener('touchstart', (e) => {
      sheetStartY = e.touches[0].clientY;
    }, { passive: true });

    bottomSheet.addEventListener('touchend', (e) => {
      const diff = e.changedTouches[0].clientY - sheetStartY;
      if (diff > 50) {
        toggleMenu();
      }
    }, { passive: true });

    // ============================================
    // TASK LIST MANAGEMENT
    // ============================================

    const TASK_STORAGE_KEY = 'axe_task_list';

    function getTasks() {
      try {
        return JSON.parse(localStorage.getItem(TASK_STORAGE_KEY) || '[]');
      } catch { return []; }
    }

    function saveTasks(tasks) {
      localStorage.setItem(TASK_STORAGE_KEY, JSON.stringify(tasks));
    }

    // Quick add task - one click, instant feedback  also adds to Projects
    window._quickAddInFlight = {};
    window.quickAddTask = async function(taskText, msgId) {
      // Prevent double-clicks and concurrent adds for same message
      if (window._quickAddInFlight[msgId]) return;
      window._quickAddInFlight[msgId] = true;

      const tasks = getTasks();

      // Check if already exists
      if (tasks.some(t => t.fromMsgId === msgId)) {
        showToast('Already added!');
        delete window._quickAddInFlight[msgId];
        return;
      }

      const newTask = {
        id: 'task_' + Date.now(),
        text: taskText,
        completed: false,
        createdAt: new Date().toISOString(),
        fromMsgId: msgId,
        priority: 'high'
      };

      // Add to quick-add list
      tasks.unshift(newTask);
      saveTasks(tasks);

      // Also add as a Project
      const projects = getProjects();
      if (!projects.some(p => p.fromMsgId === msgId)) {
        const _now = new Date().toISOString();
        projects.push({
          id: getNextProjectId(),
          title: taskText,
          status: 'active',
          progress: 0,
          phase: 'Queued from chat',
          hasCoranaArtifact: false,
          hasForgeArtifact: false,
          emailSent: false,
          createdAt: _now,
          updatedAt: _now,
          error: null,
          resources: [],
          pausedAt: null,
          completedAt: null,
          fromMsgId: msgId,
          description: '',
          memory: [{ text: 'Project created from chat', timestamp: _now, type: 'auto' }],
          instructions: taskText,
          favorite: false,
          files: [],
          tasks: [],
          partOf: null,
          partNumber: 1
        });
        saveProjects(projects);
      }

      // Update button immediately
      const btn = document.querySelector(`[data-task-msg="${msgId}"]`);
      if (btn) {
        btn.innerHTML = ' Added!';
        btn.style.background = 'var(--green)';
        btn.classList.add('added');
        btn.disabled = true;
      }

      // Show toast
      showToast(` Project added: "${taskText.substring(0, 30)}..."`);

      // Post confirmation to team chat
      try {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from: 'klaus',
            to: 'team',
            msg: ` **Project Queued:** ${taskText}\n\nAdded by James. I'll help coordinate who takes this.`,
            type: 'task_added'
          })
        });
      } catch (e) {}

      renderTaskList();
      return newTask;
    };

    // Add task to FRONT of list and notify team  also adds to Projects
    window.addTaskToList = async function(taskText, msgId) {
      // Prevent duplicates
      const tasks = getTasks();
      if (tasks.some(t => t.fromMsgId === msgId)) {
        showToast('Already added!');
        return;
      }
      const newTask = {
        id: 'task_' + Date.now(),
        text: taskText,
        completed: false,
        createdAt: new Date().toISOString(),
        fromMsgId: msgId
      };

      tasks.unshift(newTask);
      saveTasks(tasks);

      // Also add as a Project
      const projects = getProjects();
      if (!projects.some(p => p.fromMsgId === msgId)) {
        const _now = new Date().toISOString();
        projects.push({
          id: getNextProjectId(),
          title: taskText,
          status: 'active',
          progress: 0,
          phase: 'Queued from chat',
          hasCoranaArtifact: false,
          hasForgeArtifact: false,
          emailSent: false,
          createdAt: _now,
          updatedAt: _now,
          error: null,
          resources: [],
          pausedAt: null,
          completedAt: null,
          fromMsgId: msgId,
          description: '',
          memory: [{ text: 'Project created from chat', timestamp: _now, type: 'auto' }],
          instructions: taskText,
          favorite: false,
          files: [],
          tasks: [],
          partOf: null,
          partNumber: 1
        });
        saveProjects(projects);
      }

      const btn = document.querySelector(`[data-task-msg="${msgId}"]`);
      if (btn) {
        btn.innerHTML = ' Added';
        btn.classList.add('added');
      }

      try {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from: 'forge',
            to: 'team',
            msg: ` Project added: "${taskText}"\n\n@team This is now in our queue. Who's taking point?`,
            type: 'task_added'
          })
        });
        loadMessages();
      } catch (e) {
        console.error('Failed to post project notification:', e);
      }

      renderTaskList();
      return newTask;
    };

    window.toggleTask = function(taskId) {
      const tasks = getTasks();
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        task.completed = !task.completed;
        saveTasks(tasks);
        renderTaskList();
      }
    };

    window.deleteTask = function(taskId) {
      let tasks = getTasks();
      tasks = tasks.filter(t => t.id !== taskId);
      saveTasks(tasks);
      renderTaskList();
    };

    // Move task to front (retry) and notify team
    window.retryTask = async function(taskId) {
      let tasks = getTasks();
      const taskIndex = tasks.findIndex(t => t.id === taskId);
      if (taskIndex >= 0) {
        const task = tasks.splice(taskIndex, 1)[0];
        task.completed = false;
        tasks.unshift(task);
        saveTasks(tasks);
        renderTaskList();

        // Post follow-up message to team from Forge
        try {
          await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              from: 'forge',
              to: 'team',
              msg: ` Task bumped to top: "${task.text}"\n\n@team Prioritizing this one. Let's get it done.`,
              type: 'task_retry'
            })
          });
          loadMessages();
        } catch (e) {
          console.error('Failed to post task retry notification:', e);
        }
      }
    };

    function renderTaskList() {
      const container = document.getElementById('taskListContent');
      if (!container) return;

      const tasks = getTasks();

      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="task-empty">
            <div class="task-empty-icon"></div>
            <div>No tasks yet</div>
            <div style="font-size: 13px; margin-top: 8px;">Request a task in chat and Forge will add it here</div>
          </div>
        `;
        return;
      }

      container.innerHTML = tasks.map(task => `
        <div class="task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}">
          <button class="task-check" onclick="toggleTask('${task.id}')">${task.completed ? '' : ''}</button>
          <div class="task-content">
            <div class="task-text">${escapeHtml(task.text)}</div>
            <div class="task-meta">
              <span> Forge</span>
              <span>${formatTime(task.createdAt)}</span>
            </div>
          </div>
          ${!task.completed ? `<button class="task-btn view-tasks" onclick="retryTask('${task.id}')" style="font-size: 11px; padding: 4px 8px;"> Top</button>` : ''}
          <button class="task-delete" onclick="deleteTask('${task.id}')"></button>
        </div>
      `).join('');
    }

    window.openTaskListModal = function() {
      document.getElementById('taskListModal').classList.add('active');
      renderTaskList();
    };

    window.closeTaskListModal = function() {
      document.getElementById('taskListModal').classList.remove('active');
    };

    // Save artifact from chat message
    window.saveArtifactFromChat = async function(msgId, artifactName) {
      // Find the message element to get content
      const msgEl = document.querySelector(`[data-id="${msgId}"]`);
      if (!msgEl) return;

      const fullMsg = msgEl.dataset.fullMsg || '';

      // Extract code block content if present
      let content = fullMsg;
      const codeMatch = fullMsg.match(/```[\w]*\n?([\s\S]*?)```/);
      if (codeMatch) {
        content = codeMatch[1].trim();
      }

      // Determine type from name
      const ext = artifactName.split('.').pop() || 'txt';

      // Create artifact object
      const newArtifact = {
        id: 'artifact_' + Date.now(),
        name: artifactName,
        type: ext,
        creator: msgEl.querySelector('.msg-name')?.textContent || 'team',
        created: new Date().toISOString(),
        description: 'Created in team chat',
        content: content,
        fromMsgId: msgId
      };

      // Save to localStorage
      try {
        const stored = JSON.parse(localStorage.getItem('axe_shared_artifacts') || '[]');
        stored.push(newArtifact);
        localStorage.setItem('axe_shared_artifacts', JSON.stringify(stored));

        // Update button
        const btn = document.querySelector(`[data-artifact-msg="${msgId}"]`);
        if (btn) {
          btn.innerHTML = ' Saved';
          btn.classList.add('added');
        }

        // Post confirmation to chat
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from: 'forge',
            to: 'team',
            msg: ` Artifact saved: ${artifactName}\n\nView it at /artifacts`,
            type: 'artifact_saved'
          })
        });

        loadMessages();
      } catch (e) {
        console.error('Failed to save artifact:', e);
        alert('Failed to save artifact');
      }
    };

    // Detect task request patterns
    function isTaskRequest(msg) {
      const patterns = [
        /add\s+(a\s+)?task/i,
        /task:\s*(.+)/i,
        /create\s+(a\s+)?task/i,
        /new\s+task/i,
        /todo:\s*(.+)/i,
        /add\s+to\s+tasks?/i,
        /@forge\s+add/i
      ];
      return patterns.some(p => p.test(msg));
    }

    // Extract task text from message
    function extractTaskText(msg) {
      // Try to extract the actual task content
      let match = msg.match(/task:\s*(.+)/i) || msg.match(/todo:\s*(.+)/i);
      if (match) return match[1].trim();

      // Otherwise use the whole message (cleaned up)
      return msg
        .replace(/add\s+(a\s+)?task/i, '')
        .replace(/create\s+(a\s+)?task/i, '')
        .replace(/new\s+task/i, '')
        .replace(/add\s+to\s+tasks?/i, '')
        .replace(/@\w+/g, '')
        .trim() || msg;
    }

    // === Team Page ===
    function openTeamPage() {
      document.getElementById('teamPage').classList.add('active');
    }
    function closeTeamPage() {
      document.getElementById('teamPage').classList.remove('active');
    }

    // === Klaus Admin Dashboard ===
    const KLAUS_ADMIN_API = '/api/klaus-admin';
    let kaConfig = {}, kaFlags = {}, kaInjections = [], kaChatHistory = [], kaErrors = [], kaTests = [];
    let kaPersonalTasks = [], kaSkills = [], kaTaskFilter = 'all', kaSkillSearchQuery = '';

    function openKlausAdmin() {
      document.getElementById('klausAdminPage').classList.add('active');
      kaRefreshAll();
    }

    function closeKlausAdmin() {
      document.getElementById('klausAdminPage').classList.remove('active');
    }

    function switchKaTab(tabId, btn) {
      document.querySelectorAll('.ka-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.ka-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      const panel = document.getElementById('kaPanel-' + tabId);
      if (panel) panel.classList.add('active');
    }

    async function kaRefreshAll() {
      await Promise.all([
        kaLoadConfig(), kaLoadFlags(), kaLoadInjections(),
        kaLoadChatHistory(), kaLoadErrors(), kaLoadTests(), kaCheckHealth(),
        kaLoadPersonalTasks(), kaLoadSkills()
      ]);
    }

    async function kaLoadConfig() {
      try {
        const res = await fetch(KLAUS_ADMIN_API + '?doc=config');
        const json = await res.json();
        kaConfig = json.data || {};
        if (kaConfig.systemPrompt) document.getElementById('kaSystemPrompt').value = kaConfig.systemPrompt;
        if (kaConfig.temperature != null) {
          document.getElementById('kaTemperature').value = kaConfig.temperature;
          document.getElementById('kaTempValue').textContent = kaConfig.temperature;
        }
        if (kaConfig.maxTokens) document.getElementById('kaMaxTokens').value = kaConfig.maxTokens;
        if (kaConfig.model) document.getElementById('kaModel').value = kaConfig.model;
        if (kaConfig.preferOllama != null) document.getElementById('kaPreferOllama').checked = kaConfig.preferOllama;
      } catch (e) { console.error('kaLoadConfig:', e); }
    }

    async function kaLoadFlags() {
      try {
        const res = await fetch(KLAUS_ADMIN_API + '?doc=feature-flags');
        const json = await res.json();
        kaFlags = json.data || {};
        kaRenderFlags();
      } catch (e) { console.error('kaLoadFlags:', e); }
    }

    async function kaLoadInjections() {
      try {
        const res = await fetch(KLAUS_ADMIN_API + '?doc=injections');
        const json = await res.json();
        kaInjections = (json.data && json.data.items) || [];
        kaRenderInjections();
      } catch (e) { console.error('kaLoadInjections:', e); }
    }

    async function kaLoadChatHistory() {
      try {
        const res = await fetch('/api/messages');
        const json = await res.json();
        kaChatHistory = (json.messages || []).filter(m =>
          m.from === 'klaus' || m.to === 'klaus' || (m.msg && m.msg.toLowerCase().includes('klaus'))
        );
        kaRenderChat();
      } catch (e) { console.error('kaLoadChatHistory:', e); }
    }

    async function kaLoadErrors() {
      try {
        const res = await fetch(KLAUS_ADMIN_API + '?doc=errors');
        const json = await res.json();
        kaErrors = json.errors || [];
        kaRenderErrors();
      } catch (e) { console.error('kaLoadErrors:', e); }
    }

    async function kaLoadTests() {
      try {
        const res = await fetch(KLAUS_ADMIN_API + '?doc=tests');
        const json = await res.json();
        kaTests = json.tests || [];
        kaRenderTests();
      } catch (e) { console.error('kaLoadTests:', e); }
    }

    async function kaCheckHealth() {
      const ollamaDot = document.getElementById('kaOllamaDot');
      const groqDot = document.getElementById('kaGroqDot');
      const ollamaLabel = document.getElementById('kaOllamaLabel');
      const groqLabel = document.getElementById('kaGroqLabel');
      ollamaDot.className = 'ka-health-dot checking';
      groqDot.className = 'ka-health-dot checking';
      try {
        const res = await fetch(KLAUS_ADMIN_API + '?doc=health');
        const json = await res.json();
        ollamaDot.className = 'ka-health-dot ' + (json.ollama?.status || 'offline');
        groqDot.className = 'ka-health-dot ' + (json.groq?.status || 'offline');
        ollamaLabel.textContent = 'Ollama ' + (json.ollama?.latency ? json.ollama.latency + 'ms' : '');
        groqLabel.textContent = 'Groq ' + (json.groq?.latency ? json.groq.latency + 'ms' : '');
      } catch (e) {
        ollamaDot.className = 'ka-health-dot offline';
        groqDot.className = 'ka-health-dot offline';
      }
    }

    async function kaSaveConfig() {
      const data = {
        systemPrompt: document.getElementById('kaSystemPrompt').value,
        temperature: parseFloat(document.getElementById('kaTemperature').value),
        maxTokens: parseInt(document.getElementById('kaMaxTokens').value),
        model: document.getElementById('kaModel').value,
        preferOllama: document.getElementById('kaPreferOllama').checked,
        updatedBy: 'james'
      };
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'config', data })
        });
        showToast('Config saved');
      } catch (e) { console.error('kaSaveConfig:', e); }
    }

    async function kaSaveFlags() {
      const data = {};
      document.querySelectorAll('[data-ka-flag]').forEach(el => {
        data[el.dataset.kaFlag] = el.checked;
      });
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'feature-flags', data })
        });
        showToast('Flags saved');
      } catch (e) { console.error('kaSaveFlags:', e); }
    }

    async function kaSaveInjections() {
      const items = [];
      document.querySelectorAll('.ka-injection-card').forEach(card => {
        items.push({
          id: card.dataset.id,
          name: card.querySelector('.ka-inj-name').value,
          type: card.querySelector('.ka-inj-type').value,
          code: card.querySelector('.ka-injection-code').value,
          enabled: card.querySelector('.ka-inj-toggle').checked,
          description: card.querySelector('.ka-inj-desc').value || ''
        });
      });
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'injections', data: { items } })
        });
        kaInjections = items;
        showToast('Injections deployed');
      } catch (e) { console.error('kaSaveInjections:', e); }
    }

    const kaFlagDefs = [
      { key: 'trainingMode', name: 'Training Mode', desc: 'Enable learning from conversations' },
      { key: 'googleWorkspace', name: 'Google Workspace', desc: 'Calendar, Docs, Gmail integration' },
      { key: 'memoryBroadcast', name: 'Memory Broadcast', desc: 'Share memory across team chat' },
      { key: 'debugMode', name: 'Debug Mode', desc: 'Show debug info in responses' },
      { key: 'teamChatBridge', name: 'Team Chat Bridge', desc: 'Bridge to AXe team channel' }
    ];

    function kaRenderFlags() {
      const grid = document.getElementById('kaFlagsGrid');
      grid.innerHTML = kaFlagDefs.map(f => `
        <div class="ka-flag-card">
          <div>
            <div class="ka-flag-name">${f.name}</div>
            <div class="ka-flag-desc">${f.desc}</div>
          </div>
          <label class="ka-toggle">
            <input type="checkbox" data-ka-flag="${f.key}" ${kaFlags[f.key] ? 'checked' : ''}>
            <span class="ka-toggle-slider"></span>
          </label>
        </div>
      `).join('');
    }

    function kaRenderInjections() {
      const container = document.getElementById('kaInjectionsContainer');
      if (kaInjections.length === 0) {
        container.innerHTML = '<div class="ka-empty">No injections yet. Add one to push code to klaus.it.com</div>';
        return;
      }
      container.innerHTML = kaInjections.map(inj => `
        <div class="ka-injection-card" data-id="${inj.id}">
          <div class="ka-injection-header">
            <input type="text" class="ka-input ka-inj-name" value="${escapeHtml(inj.name || '')}" placeholder="Name" style="flex:1;">
            <select class="ka-select ka-inj-type" style="width:70px;">
              <option value="css" ${inj.type === 'css' ? 'selected' : ''}>CSS</option>
              <option value="js" ${inj.type === 'js' ? 'selected' : ''}>JS</option>
            </select>
            <label class="ka-toggle">
              <input type="checkbox" class="ka-inj-toggle" ${inj.enabled ? 'checked' : ''}>
              <span class="ka-toggle-slider"></span>
            </label>
            <button class="ka-delete-btn" onclick="kaRemoveInjection('${inj.id}')" title="Remove">&#10005;</button>
          </div>
          <textarea class="ka-injection-code" placeholder="Enter ${inj.type || 'css'} code...">${escapeHtml(inj.code || '')}</textarea>
          <input type="text" class="ka-input ka-inj-desc" value="${escapeHtml(inj.description || '')}" placeholder="Description (optional)" style="width:100%;margin-top:8px;font-size:12px;">
        </div>
      `).join('');
    }

    function kaAddInjection() {
      kaInjections.push({
        id: 'inj_' + Date.now(),
        name: '',
        type: 'css',
        code: '',
        enabled: false,
        description: ''
      });
      kaRenderInjections();
    }

    function kaRemoveInjection(id) {
      kaInjections = kaInjections.filter(i => i.id !== id);
      kaRenderInjections();
    }

    function kaRenderChat() {
      const list = document.getElementById('kaChatList');
      const filter = document.getElementById('kaChatFilter').value;
      let msgs = kaChatHistory;
      if (filter === 'klaus') msgs = msgs.filter(m => m.from === 'klaus');
      else if (filter === 'james') msgs = msgs.filter(m => m.from === 'james');

      document.getElementById('kaChatCount').textContent = msgs.length + ' messages';

      if (msgs.length === 0) {
        list.innerHTML = '<div class="ka-empty">No Klaus-related messages found</div>';
        return;
      }

      const agentColors = { klaus: '#e8a86d', james: 'var(--orange)', forge: '#f97316', cortana: '#a855f7', gemini: '#8b5cf6' };
      list.innerHTML = [...msgs].reverse().map(m => {
        const time = m.ts ? new Date(m.ts).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '';
        const preview = (m.msg || '').substring(0, 200);
        return `<div class="ka-chat-entry">
          <div class="ka-chat-avatar" style="background:${agentColors[m.from] || '#555'};color:#000;font-size:11px;font-weight:700;">${(m.from || '?')[0].toUpperCase()}</div>
          <div class="ka-chat-msg"><span class="ka-chat-from" style="color:${agentColors[m.from] || 'var(--text1)'}">${m.from}</span>${escapeHtml(preview)}${m.msg && m.msg.length > 200 ? '...' : ''}</div>
          <span class="ka-chat-time">${time}</span>
        </div>`;
      }).join('');
    }

    function kaFilterChat(filter) {
      kaRenderChat();
    }

    function kaRenderErrors() {
      const list = document.getElementById('kaErrorList');
      document.getElementById('kaErrorCount').textContent = kaErrors.length + ' errors';
      if (kaErrors.length === 0) {
        list.innerHTML = '<div class="ka-empty">No errors logged</div>';
        return;
      }
      list.innerHTML = kaErrors.map(e => {
        const sev = e.severity || 'error';
        const cls = sev === 'warning' ? 'warning' : sev === 'info' ? 'info' : '';
        const time = e.timestamp ? new Date(e.timestamp).toLocaleString() : '';
        return `<div class="ka-error-entry ${cls}">
          <div class="ka-error-msg">${escapeHtml(e.message || 'Unknown error')}</div>
          <div class="ka-error-meta">
            <span>${escapeHtml(e.source || 'unknown')}</span>
            <span>${time}</span>
            <span class="ka-badge">${sev}</span>
          </div>
          ${e.stack ? '<div class="ka-error-stack">' + escapeHtml(e.stack) + '</div>' : ''}
        </div>`;
      }).join('');
    }

    async function kaClearErrors() {
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'errors', clearAll: true })
        });
        kaErrors = [];
        kaRenderErrors();
        showToast('Errors cleared');
      } catch (e) { console.error('kaClearErrors:', e); }
    }

    function kaRenderTests() {
      const list = document.getElementById('kaTestList');
      if (kaTests.length === 0) {
        list.innerHTML = '<div class="ka-empty">No tests in queue</div>';
        return;
      }
      list.innerHTML = kaTests.map(t => {
        const time = t.createdAt ? new Date(t.createdAt).toLocaleString() : '';
        return `<div class="ka-test-card">
          <div class="ka-test-status ${t.status || 'pending'}"></div>
          <div class="ka-test-task">${escapeHtml(t.task || '')}</div>
          <span class="ka-badge">${t.status || 'pending'}</span>
          ${t.result ? '<span class="ka-test-result">' + escapeHtml(t.result) + '</span>' : ''}
          <button class="ka-delete-btn" onclick="kaDeleteTest('${t.id}')" title="Delete">&#10005;</button>
        </div>`;
      }).join('');
    }

    async function kaAddTest() {
      const input = document.getElementById('kaNewTest');
      const task = input.value.trim();
      if (!task) return;
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'tests', data: { task } })
        });
        input.value = '';
        await kaLoadTests();
        showToast('Test added');
      } catch (e) { console.error('kaAddTest:', e); }
    }

    async function kaDeleteTest(id) {
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'tests', id })
        });
        await kaLoadTests();
      } catch (e) { console.error('kaDeleteTest:', e); }
    }

    // === Personal Tasks ===
    const BUILTIN_SKILLS = [
      { id: 'code_review', name: 'Code Review', icon: '', desc: 'Review code for bugs, style, and improvements', category: 'dev', enabled: false },
      { id: 'summarize', name: 'Summarize', icon: '', desc: 'Condense long text into key points', category: 'writing', enabled: false },
      { id: 'translate', name: 'Translate', icon: '', desc: 'Translate text between languages', category: 'writing', enabled: false },
      { id: 'debug', name: 'Debug Helper', icon: '', desc: 'Analyze errors and suggest fixes', category: 'dev', enabled: false },
      { id: 'brainstorm', name: 'Brainstorm', icon: '', desc: 'Generate creative ideas for any topic', category: 'creative', enabled: false },
      { id: 'data_analysis', name: 'Data Analysis', icon: '', desc: 'Analyze datasets and find patterns', category: 'data', enabled: false },
      { id: 'email_draft', name: 'Email Drafts', icon: '', desc: 'Draft professional emails', category: 'writing', enabled: false },
      { id: 'api_design', name: 'API Design', icon: '', desc: 'Design RESTful API endpoints and schemas', category: 'dev', enabled: false },
      { id: 'project_plan', name: 'Project Planning', icon: '', desc: 'Break down projects into tasks and milestones', category: 'planning', enabled: false },
      { id: 'research', name: 'Research', icon: '', desc: 'Deep research on any topic with sources', category: 'research', enabled: false },
      { id: 'ux_review', name: 'UX Review', icon: '', desc: 'Evaluate interfaces for usability issues', category: 'design', enabled: false },
      { id: 'security_audit', name: 'Security Audit', icon: '', desc: 'Check code and configs for vulnerabilities', category: 'dev', enabled: false },
      { id: 'meeting_notes', name: 'Meeting Notes', icon: '', desc: 'Structure meeting notes with action items', category: 'planning', enabled: false },
      { id: 'sql_helper', name: 'SQL Helper', icon: '', desc: 'Write and optimize SQL queries', category: 'data', enabled: false },
      { id: 'regex_builder', name: 'Regex Builder', icon: '', desc: 'Build and explain regular expressions', category: 'dev', enabled: false },
    ];

    async function kaLoadPersonalTasks() {
      try {
        const res = await fetch(KLAUS_ADMIN_API + '?doc=personal-tasks');
        const json = await res.json();
        kaPersonalTasks = json.tasks || [];
        kaRenderPersonalTasks();
      } catch (e) { console.error('kaLoadPersonalTasks:', e); }
    }

    function kaRenderPersonalTasks() {
      const list = document.getElementById('kaPersonalTaskList');
      if (!list) return;

      const total = kaPersonalTasks.length;
      const done = kaPersonalTasks.filter(t => t.status === 'complete').length;
      const pct = total > 0 ? Math.round((done / total) * 100) : 0;

      const bar = document.getElementById('kaTaskProgressBar');
      const stats = document.getElementById('kaTaskStats');
      if (bar) bar.style.width = pct + '%';
      if (stats) stats.textContent = `${done}/${total} complete`;

      let filtered = kaPersonalTasks;
      if (kaTaskFilter !== 'all') {
        filtered = kaPersonalTasks.filter(t => t.status === kaTaskFilter);
      }

      // Sort: pending/in_progress first, then by priority (high > medium > low), then by date
      const priorityOrder = { high: 0, medium: 1, low: 2 };
      filtered.sort((a, b) => {
        if (a.status === 'complete' && b.status !== 'complete') return 1;
        if (a.status !== 'complete' && b.status === 'complete') return -1;
        const pa = priorityOrder[a.priority] ?? 1;
        const pb = priorityOrder[b.priority] ?? 1;
        if (pa !== pb) return pa - pb;
        return (b.createdAt || '').localeCompare(a.createdAt || '');
      });

      if (filtered.length === 0) {
        list.innerHTML = '<div class="ka-empty">No tasks yet. Add one above to get started with Klaus.</div>';
        return;
      }

      list.innerHTML = filtered.map(t => {
        const isDone = t.status === 'complete';
        const date = t.createdAt ? new Date(t.createdAt).toLocaleDateString() : '';
        const statusBtns = isDone ? '' : `
          <button class="ka-task-action-btn" onclick="kaStartTask('${t.id}')" title="Start working"></button>
        `;
        return `<div class="ka-task-card ${isDone ? 'complete' : ''}" data-task-id="${t.id}">
          <div class="ka-task-check ${isDone ? 'done' : ''}" onclick="kaToggleTask('${t.id}')">${isDone ? '' : ''}</div>
          <div class="ka-task-body">
            <div class="ka-task-text">${t.text || ''}</div>
            <div class="ka-task-meta">
              <span class="ka-task-priority ${t.priority || 'medium'}">${t.priority || 'medium'}</span>
              ${t.status === 'in_progress' ? '<span style="font-size:10px;color:#f59e0b;"> In Progress</span>' : ''}
              <span class="ka-task-date">${date}</span>
            </div>
          </div>
          <div class="ka-task-actions">
            ${statusBtns}
            <button class="ka-task-action-btn" onclick="kaDeletePersonalTask('${t.id}')" title="Delete"></button>
          </div>
        </div>`;
      }).join('');
    }

    function kaFilterTasks(filter, btn) {
      kaTaskFilter = filter;
      document.querySelectorAll('.ka-filter-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      kaRenderPersonalTasks();
    }

    async function kaAddPersonalTask() {
      const input = document.getElementById('kaNewTask');
      const priorityEl = document.getElementById('kaNewTaskPriority');
      const text = input.value.trim();
      if (!text) return;
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'personal-tasks', data: { text, priority: priorityEl.value, status: 'pending' } })
        });
        input.value = '';
        await kaLoadPersonalTasks();
        showToast('Task added');
      } catch (e) { console.error('kaAddPersonalTask:', e); }
    }

    async function kaStartTask(id) {
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'personal-tasks', id, data: { status: 'in_progress' } })
        });
        await kaLoadPersonalTasks();
        showToast('Task started');
      } catch (e) { console.error('kaStartTask:', e); }
    }

    async function kaToggleTask(id) {
      const task = kaPersonalTasks.find(t => t.id === id);
      if (!task) return;
      const newStatus = task.status === 'complete' ? 'pending' : 'complete';
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'personal-tasks', id, data: { status: newStatus, completedAt: newStatus === 'complete' ? new Date().toISOString() : null } })
        });
        await kaLoadPersonalTasks();
        if (newStatus === 'complete') {
          showToast('Task complete! Emailing artifact...');
          kaEmailTaskArtifact(task);
        }
      } catch (e) { console.error('kaToggleTask:', e); }
    }

    async function kaEmailTaskArtifact(task) {
      try {
        // Save artifact first
        const artifactContent = `# Task Completed: ${task.text}\n\n**Priority:** ${task.priority || 'medium'}\n**Created:** ${task.createdAt ? new Date(task.createdAt).toLocaleString() : 'Unknown'}\n**Completed:** ${new Date().toLocaleString()}\n\n---\n\n## Summary\n\nKlaus has completed the personal task: **${task.text}**\n\nThis task was marked as ${task.priority || 'medium'} priority and has been successfully resolved.\n\n## Next Steps\n\nCheck the Klaus Admin dashboard at [axe.observer](https://axe.observer) for remaining tasks and progress updates.`;

        const artifactName = `TASK_COMPLETE_${Date.now()}`;
        await fetch('/api/artifacts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: artifactName, content: artifactContent, creator: 'klaus', type: 'task_complete' })
        });

        // Send email with artifact
        await fetch('/api/task-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ task, artifactContent })
        });
      } catch (e) { console.error('kaEmailTaskArtifact:', e); }
    }

    async function kaDeletePersonalTask(id) {
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'personal-tasks', id })
        });
        await kaLoadPersonalTasks();
      } catch (e) { console.error('kaDeletePersonalTask:', e); }
    }

    // === Skills ===
    async function kaLoadSkills() {
      try {
        const res = await fetch(KLAUS_ADMIN_API + '?doc=skills');
        const json = await res.json();
        kaSkills = json.skills || [];
        kaRenderSkills();
      } catch (e) { console.error('kaLoadSkills:', e); }
    }

    function kaRenderSkills() {
      const activeEl = document.getElementById('kaActiveSkills');
      const discoverEl = document.getElementById('kaDiscoverSkills');
      const customEl = document.getElementById('kaCustomSkills');
      if (!activeEl || !discoverEl || !customEl) return;

      // Merge saved skill states with builtins
      const savedMap = {};
      kaSkills.forEach(s => { savedMap[s.id] = s; });

      const mergedBuiltins = BUILTIN_SKILLS.map(s => ({
        ...s,
        enabled: savedMap[s.id] ? savedMap[s.id].enabled : s.enabled
      }));

      const customSkills = kaSkills.filter(s => !BUILTIN_SKILLS.find(b => b.id === s.id));

      const query = kaSkillSearchQuery.toLowerCase();
      const matchFilter = (s) => !query || s.name.toLowerCase().includes(query) || (s.desc || '').toLowerCase().includes(query);

      // Active = enabled builtins + enabled customs
      const active = mergedBuiltins.filter(s => s.enabled && matchFilter(s));
      const activeCustom = customSkills.filter(s => s.enabled && matchFilter(s));
      const allActive = [...active, ...activeCustom];

      // Discover = disabled builtins
      const discover = mergedBuiltins.filter(s => !s.enabled && matchFilter(s));

      // Custom = disabled customs
      const inactiveCustom = customSkills.filter(s => !s.enabled && matchFilter(s));

      activeEl.innerHTML = allActive.length > 0 ? allActive.map(s => kaSkillCardHtml(s, true)).join('') : '<div class="ka-empty" style="padding:12px;">No active skills. Enable some below.</div>';
      discoverEl.innerHTML = discover.length > 0 ? discover.map(s => kaSkillCardHtml(s, false)).join('') : '<div class="ka-empty" style="padding:12px;">All built-in skills are active!</div>';
      customEl.innerHTML = (inactiveCustom.length > 0 ? inactiveCustom.map(s => kaSkillCardHtml(s, false, true)).join('') : '') +
        '<div class="ka-add-btn" onclick="kaAddCustomSkill()" style="min-height:44px;display:flex;align-items:center;justify-content:center;">+ Add Custom Skill</div>';
    }

    function kaSkillCardHtml(s, isActive, isCustom) {
      return `<div class="ka-skill-card ${isActive ? 'active' : ''}">
        <span class="ka-skill-icon">${s.icon || ''}</span>
        <div class="ka-skill-info">
          <div class="ka-skill-name">${s.name}</div>
          <div class="ka-skill-desc">${s.desc || ''}</div>
        </div>
        <button class="ka-skill-toggle ${isActive ? 'on' : ''}" onclick="kaToggleSkill('${s.id}', ${!isActive})"></button>
        ${isCustom ? '<button class="ka-task-action-btn" onclick="kaDeleteSkill(\'' + s.id + '\')" title="Delete"></button>' : ''}
      </div>`;
    }

    function kaFilterSkills(query) {
      kaSkillSearchQuery = query;
      kaRenderSkills();
    }

    async function kaToggleSkill(id, enable) {
      try {
        // Check if it's a builtin
        const builtin = BUILTIN_SKILLS.find(s => s.id === id);
        if (builtin) {
          // Save state to Firestore
          await fetch(KLAUS_ADMIN_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ doc: 'skills', data: { id, name: builtin.name, icon: builtin.icon, desc: builtin.desc, category: builtin.category, enabled: enable } })
          });
        } else {
          // Custom skill  update
          await fetch(KLAUS_ADMIN_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ doc: 'skills', id, data: { enabled: enable } })
          });
        }
        await kaLoadSkills();
        showToast(enable ? 'Skill enabled' : 'Skill disabled');
      } catch (e) { console.error('kaToggleSkill:', e); }
    }

    async function kaAddCustomSkill() {
      const input = document.getElementById('kaSkillSearch');
      const name = (input ? input.value.trim() : '') || prompt('Skill name:');
      if (!name) return;
      const desc = prompt('Brief description (what should Klaus do?):');
      if (!desc) return;
      const icon = prompt('Emoji icon (optional):', '') || '';
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'skills', data: { name, desc, icon, category: 'custom', enabled: true, custom: true } })
        });
        if (input) input.value = '';
        await kaLoadSkills();
        showToast('Skill added');
      } catch (e) { console.error('kaAddCustomSkill:', e); }
    }

    async function kaDeleteSkill(id) {
      try {
        await fetch(KLAUS_ADMIN_API, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ doc: 'skills', id })
        });
        await kaLoadSkills();
      } catch (e) { console.error('kaDeleteSkill:', e); }
    }

    function showToast(msg) {
      const toast = document.getElementById('downloadToast');
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // Initialize task list and projects on load
    renderTaskList();
    (function initProjectCount() {
      const projects = getProjects();
      const active = projects.filter(p => p.status === 'active' || p.status === 'paused');
      const countEl = document.getElementById('projectCount');
      if (countEl) countEl.textContent = active.length;
    })();
  </script>

  <!-- Task List Modal -->
  <div class="task-modal" id="taskListModal">
    <div class="task-modal-header">
      <div class="task-modal-title">
        <span></span>
        <span>Task List</span>
      </div>
      <button class="task-modal-close" onclick="document.getElementById('taskListModal').classList.remove('active')"></button>
    </div>
    <div class="task-list" id="taskListContent"></div>
  </div>
</body>
</html>
